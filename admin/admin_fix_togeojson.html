<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin · Fix toGeoJSON en GitHub Pages</title>
  <meta name="description" content="Instala togeojson en tu repo y parchea index.html para que el visor cargue KML/KMZ sin depender del CDN.">
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --ok:#34d399; --err:#ef4444; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,Segoe UI,Roboto,Arial}
    .app{max-width:900px;margin:0 auto;padding:24px}
    h1{margin:0 0 16px;font-size:22px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:6px 0 4px;color:#cbd5e1}
    input,button{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{color:var(--muted);font-size:12px}
    .btn{cursor:pointer;background:#1e293b;border:1px solid rgba(255,255,255,.15)}
    .btn:hover{background:#243449}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .log{white-space:pre-wrap;background:#0b1220;border-radius:8px;padding:10px;font-size:12px;border:1px solid rgba(255,255,255,.08);max-height:260px;overflow:auto}
  </style>
</head>
<body>
  <div class="app">
    <h1>Arreglar carga de KML (instalar togeojson + parchear index.html)</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>Repo (owner/name)</label>
          <input id="repo" value="gerardo0503/Nogales">
        </div>
        <div>
          <label>Branch</label>
          <input id="branch" value="main">
        </div>
      </div>
      <label>Token de GitHub (Contents: Read & Write)</label>
      <input id="token" type="password" placeholder="Pega tu token aquí">
      <label><input type="checkbox" id="remember"> Recordar token en este navegador (no recomendado en equipos compartidos)</label>
      <div class="hint">El token se usa solo en tu navegador para hablar con la API de GitHub.</div>
    </div>

    <div class="card">
      <button id="btnInstall" class="btn">1) Instalar togeojson en el repo (/lib/togeojson.umd.js)</button>
      <div class="hint">Descarga desde CDN y guarda una copia local en tu repo para no depender de externos.</div>
      <div id="installMsg" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <button id="btnPatch" class="btn">2) Parchear index.html (agregar &lt;script src="./lib/togeojson.umd.js"&gt;)</button>
      <div class="hint">Inserta el script antes de tu código principal, si aún no está.</div>
      <div id="patchMsg" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <button id="btnOpen" class="btn">Abrir mapa (forzar recarga con ?v=fix)</button>
      <div class="hint">Revisa: https://gerardo0503.github.io/Nogales/?v=fix y presiona “Actualizar”.</div>
    </div>

    <div class="card">
      <label>Bitácora</label>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const $=s=>document.querySelector(s);
    const log = (m)=>{ const el=$('#log'); el.textContent += (m+'\n'); el.scrollTop = el.scrollHeight; };
    const b64 = (txt)=> btoa(unescape(encodeURIComponent(txt)));
    const fromB64 = (b)=> decodeURIComponent(escape(atob(b)));

    const repoEl=$('#repo'), branchEl=$('#branch'), tokenEl=$('#token');
    const saved = localStorage.getItem('gh_token_fix'); if(saved){ tokenEl.value=saved; $('#remember').checked=true; }
    $('#remember').addEventListener('change', e=>{ if(e.target.checked) localStorage.setItem('gh_token_fix', tokenEl.value); else localStorage.removeItem('gh_token_fix'); });
    tokenEl.addEventListener('input', ()=>{ if($('#remember').checked) localStorage.setItem('gh_token_fix', tokenEl.value); });

    async function ghGet(path){
      const url = `https://api.github.com/repos/${repoEl.value}/contents/${path}?ref=${branchEl.value}`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${tokenEl.value}`, Accept: 'application/vnd.github+json' } });
      if(res.status===404) return null;
      if(!res.ok) throw new Error('GET '+path+': '+res.status+' '+await res.text());
      return await res.json();
    }
    async function ghPut(path, contentB64, sha=null, message='update'){
      const url = `https://api.github.com/repos/${repoEl.value}/contents/${path}`;
      const body = { message, content: contentB64, branch: branchEl.value };
      if(sha) body.sha = sha;
      const res = await fetch(url, { method:'PUT', headers: { Authorization: `Bearer ${tokenEl.value}`, Accept: 'application/vnd.github+json' }, body: JSON.stringify(body) });
      if(!res.ok) throw new Error('PUT '+path+': '+res.status+' '+await res.text());
      return await res.json();
    }

    async function installTogeojson(){
      try{
        $('#installMsg').textContent='';
        log('Descargando togeojson.umd.js desde CDN…');
        const res = await fetch('https://unpkg.com/togeojson@0.16.0/dist/togeojson.umd.js');
        if(!res.ok) throw new Error('CDN respondió '+res.status);
        const js = await res.text();
        log('Obtenido ('+js.length+' bytes). Subiendo a lib/togeojson.umd.js…');
        const existing = await ghGet('lib/togeojson.umd.js');
        await ghPut('lib/togeojson.umd.js', b64(js), existing?.sha || null, 'chore: add lib/togeojson.umd.js');
        $('#installMsg').innerHTML = '<span class="ok">OK: togeojson instalado en /lib/togeojson.umd.js</span>';
        log('Listo: /lib/togeojson.umd.js');
      }catch(err){
        console.error(err);
        $('#installMsg').innerHTML = '<span class="err">Error: '+(err.message||err)+'</span>';
        log('ERROR instalar: '+(err.message||err));
      }
    }

    function injectTag(html){
      // Inserta antes de </head> si no existe ya referencia a togeojson
      if(/togeojson/i.test(html)) return { html, changed:false };
      const tag = '\n  <script src="./lib/togeojson.umd.js"></script>\n';
      if(/<\/head>/i.test(html)){
        return { html: html.replace(/<\/head>/i, tag + '</head>'), changed:true };
      }
      // Si no hay </head>, lo ponemos al inicio
      return { html: tag + html, changed:true };
    }

    async function patchIndex(){
      try{
        $('#patchMsg').textContent='';
        log('Leyendo index.html del repo…');
        const info = await ghGet('index.html');
        if(!info) throw new Error('No existe index.html en la raíz');
        const content = fromB64(info.content);
        const { html, changed } = injectTag(content);
        if(!changed){ $('#patchMsg').innerHTML = '<span class="ok">index.html ya tenía togeojson; no hace falta cambiar.</span>'; log('Sin cambios, ya estaba.'); return; }
        log('Insertando <script src="./lib/togeojson.umd.js"> y guardando…');
        await ghPut('index.html', b64(html), info.sha, 'fix: include local togeojson in index.html');
        $('#patchMsg').innerHTML = '<span class="ok">OK: index.html parchado</span>';
        log('Listo: index.html actualizado');
      }catch(err){
        console.error(err);
        $('#patchMsg').innerHTML = '<span class="err">Error: '+(err.message||err)+'</span>';
        log('ERROR parchear: '+(err.message||err));
      }
    }

    $('#btnInstall').addEventListener('click', installTogeojson);
    $('#btnPatch').addEventListener('click', patchIndex);
    $('#btnOpen').addEventListener('click', ()=> window.open('https://gerardo0503.github.io/Nogales/?v=fix', '_blank'));
  </script>
</body>
</html>
