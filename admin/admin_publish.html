<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Publicar KML a GitHub (baches.kml)</title>
<style>
  body{font:16px/1.4 system-ui,Segoe UI,Roboto,Arial;margin:20px;background:#0f172a;color:#e5e7eb}
  input,button{font:inherit}
  .row{margin-bottom:14px}
  .box{background:#0b1220;border:1px solid #223046;border-radius:10px;padding:12px}
  .inp{width:100%;background:#0b1220;border:1px solid #223046;border-radius:8px;padding:8px 10px;color:#e5e7eb}
  .btn{background:#0b1220;border:1px solid #223046;border-radius:8px;padding:8px 12px;color:#e5e7eb;cursor:pointer}
  .log{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
</style>
</head>
<body>
<h2>Publicar KML a GitHub → <code>baches.kml</code></h2>
<div class="box">
  <div class="row">
    <label>Repo (owner/name)</label><br>
    <input id="repo" class="inp" placeholder="Gerardo0503/Nogales">
  </div>
  <div class="row">
    <label>Branch</label><br>
    <input id="branch" class="inp" value="main">
  </div>
  <div class="row">
    <label>Token GitHub (scope: contents:write)</label><br>
    <input id="token" class="inp" placeholder="ghp_...">
  </div>
  <div class="row">
    <label>Archivo KML/KMZ</label><br>
    <input id="file" type="file" accept=".kml,.kmz" class="inp">
  </div>
  <button id="btn" class="btn">Publicar como baches.kml</button>
</div>
<h3>Bitácora</h3>
<div id="log" class="log box"></div>

<script>
const log = (s)=>{ document.getElementById('log').textContent += s + "\\n"; };
document.getElementById('btn').onclick = async ()=>{
  try{
    const repo   = document.getElementById('repo').value.trim();
    const branch = document.getElementById('branch').value.trim();
    const token  = document.getElementById('token').value.trim();
    const file   = document.getElementById('file').files[0];
    if(!repo||!branch||!token||!file){ alert('Falta repo/branch/token/archivo'); return; }
    log('Leyendo archivo...');
    let text = await file.text();
    // Si es KMZ, no descomprimimos aquí (subimos tal cual si es KML; KMZ no compatible como texto)
    // Publicamos como baches.kml
    const path='baches.kml';
    const api='https://api.github.com/repos/'+repo+'/contents/'+path;
    // get sha if exists
    let sha=null;
    const r0=await fetch(api+'?ref='+branch); if(r0.ok){ const j=await r0.json(); sha=j.sha; }
    const body={ message:'publish: baches.kml', content:btoa(unescape(encodeURIComponent(text))), branch };
    if(sha) body.sha=sha;
    log('Subiendo a GitHub...');
    const r=await fetch(api,{method:'PUT',headers:{'Authorization':'token '+token,'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok){ const t=await r.text(); throw new Error(t); }
    log('✅ Publicado. Abre el visor y pulsa "Actualizar".');
  }catch(e){ log('❌ Error: '+e.message); }
};
</script>
</body>
</html>
