<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Â· Publicar KML (auto UTMâ†’WGS84) a GitHub</title>
<meta name="description" content="Arrastra tu KML/KMZ desde Trimble. Convierte UTM Zona 12N a WGS84 automÃ¡ticamente y publica baches.kml en tu repo para que todos lo vean.">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<style>
  :root{--bg:#0b1220;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--ok:#34d399;--err:#ef4444;--brand:#06b6d4}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:24px}
  h1{margin:0 0 14px;font-size:22px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin-bottom:16px}
  label{display:block;margin:8px 0 6px;color:#cbd5e1}
  input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:var(--text)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .drop{border:1px dashed rgba(255,255,255,.2);border-radius:14px;padding:26px;text-align:center;color:var(--muted)}
  .drop.drag{border-color:var(--brand);background:rgba(6,182,212,.08)}
  .btn{cursor:pointer;background:#14213b;border:1px solid rgba(255,255,255,.15)}
  .btn:hover{background:#1b2b4b}
  .hint{color:var(--muted);font-size:12px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .log{white-space:pre-wrap;background:#0b1220;border-radius:10px;padding:10px;font:12px ui-monospace,Menlo,Consolas;border:1px solid rgba(255,255,255,.08);max-height:260px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>Publicar KML (convierte UTM 12N â†’ WGS84) â†’ <span style="color:#67e8f9">baches.kml</span></h1>
  <div class="card">
    <div class="row">
      <div>
        <label>Repo (owner/name)</label>
        <input id="repo" value="gerardo0503/Nogales">
      </div>
      <div>
        <label>Branch</label>
        <input id="branch" value="main">
      </div>
    </div>
    <label>Token de GitHub (Contents: Read & Write)</label>
    <input id="token" type="password" placeholder="Pega tu token aquÃ­">
    <label><input type="checkbox" id="remember"> Recordar token (no en equipos compartidos)</label>
    <div class="hint">El token se usa localmente en tu navegador para subir el archivo por API a tu repo.</div>
  </div>

  <div class="card">
    <label>CRS de entrada</label>
    <select id="crs">
      <option value="auto" selected>Auto (detecta WGS84 vs UTM 12N por los nÃºmeros)</option>
      <option value="utm12">UTM Zona 12N (EPSG:32612)</option>
      <option value="wgs84">WGS84 (lat, lon en grados)</option>
    </select>
    <div class="drop" id="drop">
      Arrastra aquÃ­ tu <b>KML</b> o <b>KMZ</b> de Trimble<br>
      <small class="hint">o haz clic para elegir un archivoâ€¦</small>
      <input id="file" type="file" accept=".kml,.kmz" hidden>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnPublish" class="btn">ðŸ“¤ Publicar como <b>baches.kml</b></button>
      <button id="btnOpen" class="btn">Abrir visor pÃºblico</button>
    </div>
    <div class="hint" style="margin-top:8px">
      El visor estÃ¡ en: <code>https://gerardo0503.github.io/Nogales/</code> â†’ pulsa <b>Actualizar</b> para ver el nuevo archivo.
    </div>
  </div>

  <div class="card">
    <label>BitÃ¡cora</label>
    <div id="log" class="log"></div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>

<script>
  const $ = s => document.querySelector(s);
  const log = (m)=>{ const el=$('#log'); el.textContent += (m+'\\n'); el.scrollTop = el.scrollHeight; };

  // Persiste token si el usuario quiere
  (function(){ const t = localStorage.getItem('gh_token'); if(t){ $('#token').value=t; $('#remember').checked=true; } })();
  $('#remember').addEventListener('change', e=>{ if(e.target.checked) localStorage.setItem('gh_token', $('#token').value); else localStorage.removeItem('gh_token'); });
  $('#token').addEventListener('input', ()=>{ if($('#remember').checked) localStorage.setItem('gh_token', $('#token').value); });

  // Drag & drop
  const drop = $('#drop'); const fileInput = $('#file');
  drop.addEventListener('click', ()=> fileInput.click());
  ['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', e=>{ if(e.dataTransfer.files[0]) fileInput.files = e.dataTransfer.files; });
  
  // CRS helpers
  const projUTM12 = '+proj=utm +zone=12 +datum=WGS84 +units=m +no_defs';
  const projWGS84 = '+proj=longlat +datum=WGS84 +no_defs';
  const toLonLat = (x,y) => proj4(projUTM12, projWGS84, [x,y]);

  function looksLikeUTM(coordsText){
    // HeurÃ­stica: si encuentra nÃºmeros grandes (easting ~ 200000â€“800000) separados por coma y espacio
    const m = coordsText.match(/-?\\d+\\.?\\d*,\\s*-?\\d+\\.?\\d*/);
    if(!m) return false;
    const [a,b] = m[0].split(',').map(s=>parseFloat(s));
    // si parecen grados (abs <= 180 y <= 90) => no es UTM
    if(Math.abs(a)<=180 && Math.abs(b)<=90) return false;
    // si ambos son > 10000 probablemente UTM
    return (Math.abs(a) > 10000 && Math.abs(b) > 10000);
  }

  function convertKmlUTMtoWGS84(kmlText){
    const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
    const coordsNodes = xml.getElementsByTagName('coordinates');
    let changed=0;
    for(let i=0;i<coordsNodes.length;i++){
      const node = coordsNodes[i];
      const text = (node.textContent||'').trim();
      if(!text) continue;
      // separa por espacios/lineas
      const tuples = text.split(/\\s+/).filter(Boolean);
      const converted = tuples.map(tok=>{
        const parts = tok.split(',');
        if(parts.length < 2) return tok;
        const x = parseFloat(parts[0]); const y = parseFloat(parts[1]); const z = parts[2] ? parseFloat(parts[2]) : 0;
        // detecta si es UTM (x,y muy grandes)
        if(Math.abs(x) > 10000 && Math.abs(y) > 10000){
          const [lon, lat] = toLonLat(x,y);
          return [lon.toFixed(7), lat.toFixed(7), z||0].join(',');
        } else {
          // ya parece lon,lat
          return tok;
        }
      }).join(' ');
      if(converted !== text){ node.textContent = converted; changed++; }
    }
    if(changed>0){
      log('Reproyectado ' + changed + ' bloque(s) de <coordinates> UTMâ†’WGS84.');
    }else{
      log('No se detectaron coordenadas UTM por convertir (ya parecen lon/lat).');
    }
    return new XMLSerializer().serializeToString(xml);
  }

  async function readKmlFromFile(f){
    const ext = (f.name.split('.').pop()||'').toLowerCase();
    if(ext==='kmz'){
      log('Abriendo KMZâ€¦');
      const buf = await f.arrayBuffer();
      const zip = await JSZip.loadAsync(buf);
      const kmlFile = Object.values(zip.files).find(x => /\\.kml$/i.test(x.name));
      if(!kmlFile) throw new Error('KMZ sin KML interno');
      return await kmlFile.async('text');
    }else if(ext==='kml'){
      return await f.text();
    }else{
      throw new Error('Formato no soportado: ' + ext);
    }
  }

  async function ghGet(path){
    const url = `https://api.github.com/repos/${$('#repo').value}/contents/${path}?ref=${$('#branch').value}`;
    const res = await fetch(url, { headers: { Authorization: `Bearer ${$('#token').value}`, Accept: 'application/vnd.github+json' } });
    if(res.status===404) return null;
    if(!res.ok) throw new Error('GET '+path+': '+res.status+' '+await res.text());
    return await res.json();
  }
  async function ghPut(path, contentText, sha=null, message='publish: baches.kml'){
    const url = `https://api.github.com/repos/${$('#repo').value}/contents/${path}`;
    const body = { message, content: btoa(unescape(encodeURIComponent(contentText))), branch: $('#branch').value };
    if(sha) body.sha = sha;
    const res = await fetch(url, { method:'PUT', headers: { Authorization: `Bearer ${$('#token').value}`, Accept: 'application/vnd.github+json' }, body: JSON.stringify(body) });
    if(!res.ok) throw new Error('PUT '+path+': '+res.status+' '+await res.text());
    return await res.json();
  }

  async function publish(){
    try{
      const f = $('#file').files[0];
      if(!f){ alert('Primero arrastra o elige un KML/KMZ'); return; }
      log('Leyendo archivo: '+f.name);
      let kml = await readKmlFromFile(f);

      const mode = $('#crs').value;
      if(mode==='utm12' || (mode==='auto' && looksLikeUTM(kml))){
        log('Detectado UTM 12N (o forzado por usuario). Convirtiendo a WGS84â€¦');
        kml = convertKmlUTMtoWGS84(kml);
      }else{
        log('Se asume WGS84 (lat/lon). No se reproyecta.');
      }

      log('Subiendo a GitHub como baches.kmlâ€¦');
      const existing = await ghGet('baches.kml');
      await ghPut('baches.kml', kml, existing?.sha || null, 'publish: '+f.name+' â†’ baches.kml');
      log('âœ… Publicado. Abre el visor pÃºblico y pulsa â€œActualizarâ€.');
      alert('Publicado. Abre el visor pÃºblico y pulsa â€œActualizarâ€.');
    }catch(err){
      console.error(err);
      log('âŒ Error: '+(err.message||err));
      alert('Error: '+(err.message||err));
    }
  }

  $('#btnPublish').addEventListener('click', publish);
  $('#btnOpen').addEventListener('click', ()=> window.open('https://gerardo0503.github.io/Nogales/?v=pro', '_blank'));
</script>
</body>
</html>