<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ¬∑ Publicar baches.kml en GitHub</title>
  <meta name="description" content="Sube un KML/KMZ y publ√≠calo en el repo como baches.kml para que el mapa se actualice solo.">
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --ok:#34d399; --err:#ef4444; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,Segoe UI,Roboto,Arial}
    .app{max-width:900px;margin:0 auto;padding:24px}
    h1{margin:0 0 16px;font-size:22px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:6px 0 4px;color:#cbd5e1}
    input,button,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0f172a;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hint{color:var(--muted);font-size:12px}
    .drop{border:2px dashed rgba(255,255,255,.15);border-radius:12px;padding:24px;text-align:center;cursor:pointer}
    .btn{cursor:pointer;background:#1e293b;border:1px solid rgba(255,255,255,.15)}
    .btn:hover{background:#243449}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .log{white-space:pre-wrap;background:#0b1220;border-radius:8px;padding:10px;font-size:12px;border:1px solid rgba(255,255,255,.08);max-height:220px;overflow:auto}
  </style>
</head>
<body>
  <div class="app">
    <h1>Publicar <code>baches.kml</code> en GitHub (admin)</h1>
    <div class="card">
      <div class="row">
        <div>
          <label>Repo (owner/name)</label>
          <input id="repo" value="gerardo0503/Nogales">
        </div>
        <div>
          <label>Branch</label>
          <input id="branch" value="main">
        </div>
      </div>
      <label>Token de GitHub (permiso <b>contents:write</b>)</label>
      <input id="token" type="password" placeholder="Pega tu token aqu√≠">
      <label><input type="checkbox" id="remember"> Recordar token en este navegador (no recomendado en equipos compartidos)</label>
      <div class="hint">Crea un token en GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens. Usa un token fino-grained con acceso solo a este repo y permiso <b>Contents: Read & Write</b>.</div>
    </div>

    <div class="card">
      <label>Arrastra aqu√≠ tu archivo KML/KMZ o elige uno</label>
      <div id="drop" class="drop">Suelta el archivo aqu√≠</div>
      <div style="margin:10px 0;text-align:center">o</div>
      <input id="file" type="file" accept=".kml,.kmz">
      <div class="hint">Solo KML o KMZ exportados de Trimble Connect. Si subes KMZ, aqu√≠ se extrae el KML interno autom√°ticamente.</div>
    </div>

    <div class="card">
      <button id="publish" class="btn">üì§ Publicar como <code>baches.kml</code></button>
      <div id="msg" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Enlace del mapa</label>
          <input id="mapUrl" value="https://gerardo0503.github.io/Nogales/" readonly>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="openMap">Abrir mapa</button>
        </div>
      </div>
      <div class="hint">Cuando publiques, el mapa toma el nuevo archivo autom√°ticamente. Si ya estaba abierto, usa el bot√≥n <b>Actualizar</b> del visor.</div>
    </div>

    <div class="card">
      <label>Bit√°cora</label>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    const $=s=>document.querySelector(s);
    const log = (m)=>{ const el=$('#log'); el.textContent += (m+'\n'); el.scrollTop = el.scrollHeight; };
    const b64 = (txt)=> btoa(unescape(encodeURIComponent(txt))); // base64 seguro para texto
    const repoEl=$('#repo'), branchEl=$('#branch'), tokenEl=$('#token'), drop=$('#drop'), fileInput=$('#file'), msg=$('#msg');

    // persistencia opcional del token
    const saved = localStorage.getItem('gh_token');
    if(saved) tokenEl.value = saved;
    $('#remember').checked = !!saved;
    $('#remember').addEventListener('change', e=>{
      if(e.target.checked) localStorage.setItem('gh_token', tokenEl.value);
      else localStorage.removeItem('gh_token');
    });
    tokenEl.addEventListener('input', ()=>{ if($('#remember').checked) localStorage.setItem('gh_token', tokenEl.value); });

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); drop.style.background='#0b1220'; }));
    ;['dragleave','drop'].forEach(evt=> drop.addEventListener(evt, e=>{ e.preventDefault(); drop.style.background=''; }));
    drop.addEventListener('drop', e=>{ const f = e.dataTransfer.files?.[0]; if(f) fileInput.files = e.dataTransfer.files; });

    async function extractKml(file){
      const name = file.name.toLowerCase();
      if(name.endsWith('.kml')){
        log('Leyendo KML‚Ä¶');
        return await file.text();
      }
      if(name.endsWith('.kmz')){
        log('Extrayendo KML desde KMZ‚Ä¶');
        const buf = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(buf);
        const kmlEntry = Object.values(zip.files).find(f => /\.kml$/i.test(f.name));
        if(!kmlEntry) throw new Error('El KMZ no contiene KML');
        return await kmlEntry.async('text');
      }
      throw new Error('Formato no soportado; usa KML o KMZ');
    }

    async function githubGet(path){
      const url = `https://api.github.com/repos/${repoEl.value}/contents/${path}?ref=${branchEl.value}`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${tokenEl.value}`, Accept: 'application/vnd.github+json' } });
      if(res.status===404) return null;
      if(!res.ok){ throw new Error('GET '+path+': '+res.status+' '+await res.text()); }
      return await res.json();
    }

    async function githubPut(path, contentB64, sha=null, message='update baches.kml'){
      const url = `https://api.github.com/repos/${repoEl.value}/contents/${path}`;
      const body = { message, content: contentB64, branch: branchEl.value };
      if(sha) body.sha = sha;
      const res = await fetch(url, {
        method: 'PUT',
        headers: { Authorization: `Bearer ${tokenEl.value}`, Accept: 'application/vnd.github+json' },
        body: JSON.stringify(body)
      });
      if(!res.ok){ throw new Error('PUT '+path+': '+res.status+' '+await res.text()); }
      return await res.json();
    }

    async function publish(){
      try{
        msg.textContent = ''; log('‚Äî ‚Äî ‚Äî');
        const file = fileInput.files?.[0];
        if(!file){ msg.innerHTML = '<span class="err">Selecciona un archivo KML o KMZ</span>'; return; }
        if(!tokenEl.value){ msg.innerHTML = '<span class="err">Pega tu token de GitHub</span>'; return; }

        const kmlText = await extractKml(file);
        const shaInfo = await githubGet('baches.kml');
        const sha = shaInfo?.sha || null;

        log('Subiendo a GitHub como baches.kml‚Ä¶');
        await githubPut('baches.kml', b64(kmlText), sha, `publish: ${file.name} ‚Üí baches.kml`);
        msg.innerHTML = '<span class="ok">¬°Publicado! Abre el mapa y pulsa ‚ÄúActualizar‚Äù.</span>';
      }catch(err){
        console.error(err);
        msg.innerHTML = '<span class="err">Error: '+(err.message||err)+'</span>';
        log('ERROR: '+(err.message||err));
      }
    }

    $('#publish').addEventListener('click', publish);
    $('#openMap').addEventListener('click', ()=> window.open($('#mapUrl').value, '_blank'));
  </script>
</body>
</html>
