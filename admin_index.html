<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Publicar KML a GitHub → baches.kml</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
  :root{color-scheme:dark light}
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0;padding:24px}
  h1{font-size:clamp(18px,3vw,24px);margin:0 0 16px}
  .card{max-width:980px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:14px;padding:20px;box-shadow:0 10px 30px rgb(0 0 0 / .35)}
  label{display:block;margin:12px 0 6px;color:#93c5fd}
  input,button{font:inherit}
  input[type=text],input[type=password]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e2e8f0}
  input[type=file]{display:block;margin-top:6px}
  button{background:#2563eb;border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .row-3{display:grid;gap:12px;grid-template-columns:2fr 1fr 1fr}
  .hint{color:#9ca3af;font-size:.9rem;margin-top:6px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  textarea{width:100%;min-height:160px;background:#0b1220;color:#e2e8f0;border:1px solid #334155;border-radius:10px;padding:12px}
  .ok{color:#86efac}
  .bad{color:#fca5a5}
</style>
</head>
<body>
  <div class="card">
    <h1>Publicar KML a GitHub → <code>baches.kml</code></h1>

    <div class="row-3">
      <div>
        <label>Repo (owner/nombre)</label>
        <input id="repo" type="text" value="Gerardo0503/Nogales" autocomplete="off">
      </div>
      <div>
        <label>Branch</label>
        <input id="branch" type="text" value="main" autocomplete="off">
      </div>
      <div>
        <label>Ruta destino</label>
        <input id="path" type="text" value="baches.kml" autocomplete="off">
      </div>
    </div>

    <label>Token GitHub (scope: <code>contents:write</code>)</label>
    <input id="token" type="password" placeholder="github_pat_… o ghp_…" autocomplete="off">

    <label>Archivo KML/KMZ</label>
    <input id="file" type="file" accept=".kml,.kmz" />

    <div class="actions">
      <button id="btnUpload">Publicar como <code>baches.kml</code></button>
      <button id="btnViewer" type="button">Abrir visor público</button>
      <button id="btnRaw" type="button">Ver raw</button>
    </div>

    <div class="hint">Si no ves cambios en el visor, pulsa “Abrir visor público”; agrega <code>?t=timestamp</code> para romper caché.</div>

    <label>Bitácora</label>
    <textarea id="log" readonly></textarea>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const log = (msg, cls='')=>{
  const el = $('log');
  el.value += (cls ? `[${cls}] ` : '') + msg + '\n';
  el.scrollTop = el.scrollHeight;
};

function toBase64Utf8(str){
  return btoa(unescape(encodeURIComponent(str)));
}

async function fetchSha(repo, path){
  const url = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: { 'Accept':'application/vnd.github+json' }});
  if(res.status === 404) return null;
  if(!res.ok){
    const t = await res.text();
    throw new Error(`GET sha fallo (${res.status}): ${t}`);
  }
  const j = await res.json();
  return j.sha || null;
}

async function putFile({repo, path, branch, token, content, message}){
  const url = `https://api.github.com/repos/${repo}/contents/${encodeURIComponent(path)}`;
  const sha = await fetchSha(repo, path);
  const body = {
    message,
    branch,
    content: toBase64Utf8(content),
    sha: sha || undefined
  };
  const res = await fetch(url, {
    method:'PUT',
    headers:{
      'Accept':'application/vnd.github+json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const t = await res.text();
    throw new Error(`PUT fallo (${res.status}): ${t}`);
  }
  return res.json();
}

async function readKmlFromFile(file){
  const name = file.name.toLowerCase();
  if(name.endsWith('.kml')){
    return await file.text();
  }
  if(name.endsWith('.kmz')){
    const ab = await file.arrayBuffer();
    const zip = await JSZip.loadAsync(ab);
    const kmlEntry = Object.values(zip.files).find(f => f.name.toLowerCase().endsWith('.kml'));
    if(!kmlEntry) throw new Error('KMZ sin KML interno.');
    return await kmlEntry.async('string');
  }
  throw new Error('Formato no soportado. Sube .kml o .kmz.');
}

$('btnUpload').addEventListener('click', async ()=>{
  const repo = $('repo').value.trim();
  const branch = $('branch').value.trim();
  const path = $('path').value.trim() || 'baches.kml';
  const token = $('token').value.trim();
  const file = $('file').files[0];

  $('btnUpload').disabled = true;
  try{
    if(!repo || !branch || !path) throw new Error('Falta repo/branch/ruta.');
    if(!token) throw new Error('Falta token.');
    if(!file)  throw new Error('Selecciona un archivo KML/KMZ.');

    log(`Leyendo archivo: ${file.name}`);
    const kmlText = await readKmlFromFile(file);

    log('Subiendo a GitHub...');
    const msg = `publish: ${file.name} → ${path} @ ${new Date().toISOString()}`;
    const r = await putFile({repo, path, branch, token, content:kmlText, message:msg});
    log('✅ Publicado. Abre el visor y pulsa "Actualizar".', 'ok');
    log(`commit: ${r.commit && r.commit.sha ? r.commit.sha.slice(0,7) : '(sin sha)''}`);
  }catch(err){
    console.error(err);
    log(`❌ ${err.message}`, 'bad');
  }finally{
    $('btnUpload').disabled = false;
  }
});

$('btnViewer').addEventListener('click', ()=>{
  const bust = Date.now();
  const u = `https://gerardo0503.github.io/Nogales/?t=${bust}`;
  window.open(u, '_blank');
});

$('btnRaw').addEventListener('click', ()=>{
  const bust = Date.now();
  const u = `https://raw.githubusercontent.com/${$('repo').value.trim()}/main/${$('path').value.trim()||'baches.kml'}?t=${bust}`;
  window.open(u, '_blank');
});
</script>
</body>
</html>
