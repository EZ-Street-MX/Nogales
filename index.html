<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>EZ Street MX · Mapa de Bacheo (Responsive)</title>

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --chip: #1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { height: 100%; display: grid; grid-template-columns: 340px 1fr 380px; grid-template-rows: 56px 1fr; grid-template-areas: "top top top" "left map right"; }
    header { grid-area: top; display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: #0b1220; border-bottom: 1px solid #1f2937; }
    header .brand { font-weight: 700; white-space: nowrap; }
    header .spacer { flex: 1; }
    header .input, header button, .chip { height: 36px; border-radius: 10px; border: 1px solid #263244; background: #0b1220; color: var(--text); padding: 0 12px; }
    header .input { min-width: 240px; outline: none; }
    header button { cursor: pointer; }
    header .btn { display: inline-flex; align-items: center; gap: 8px; }
    header .ghost { border-color: #22344c; background: #0b1220; }
    #toggleList, #togglePanel { display: none; } /* shown on mobile */

    /* Left (Listado) */
    #left { grid-area: left; border-right: 1px solid #1f2937; background: #0d1424; display: flex; flex-direction: column; min-width: 0; }
    #left .searchWrap { padding: 10px; border-bottom: 1px solid #1f2937; }
    #left input[type="search"] { width: 100%; height: 38px; border-radius: 10px; border: 1px solid #263244; background: #0b1220; color: var(--text); padding: 0 12px; outline: none; }
    #list { overflow: auto; }
    .item { border-bottom: 1px solid #142031; padding: 10px 12px; cursor: pointer; }
    .item:hover { background: #0a1325; }
    .item .name { font-weight: 600; }
    .item .sub { color: var(--muted); font-size: 12px; }

    /* Map */
    #map { grid-area: map; }
    #map .leaflet-control-attribution { background: rgba(15, 23, 42, .55); backdrop-filter: blur(6px); }

    /* Right (Panel) */
    #right { grid-area: right; border-left: 1px solid #1f2937; background: #0d1424; display: flex; flex-direction: column; min-width: 0; }
    #right .panelTitle { padding: 10px 12px; border-bottom: 1px solid #1f2937; display: flex; align-items: center; justify-content: space-between; }
    #right .content { padding: 10px; overflow: auto; }
    .row { display: grid; grid-template-columns: 120px 1fr; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #1d2a3e; }
    .row b { color: var(--muted); }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip { display: inline-flex; align-items: center; border: 1px dashed #2b3c58; background: #0b1220; color: var(--accent); }
    .photos { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .photos img { width: 100%; aspect-ratio: 4 / 3; object-fit: cover; border-radius: 10px; border: 1px solid #1d2a3e; cursor: pointer; }

    /* Drawer buttons (mobile only) */
    .floating-toggle { position: absolute; z-index: 999; top: 66px; left: 10px; }
    .floating-toggle.right { left: auto; right: 10px; }
    .fab { height: 40px; border-radius: 10px; border: 1px solid #263244; background: rgba(11, 18, 32, .8); padding: 0 12px; display: none; align-items: center; gap: 8px; color: var(--text); backdrop-filter: blur(6px); }

    /* Mobile */
    @media (max-width: 1024px) {
      #app { grid-template-columns: 1fr; grid-template-rows: 56px 1fr; grid-template-areas: "top" "map"; }
      #left, #right { position: fixed; top: 56px; bottom: 0; width: min(90vw, 380px); z-index: 998; transform: translateX(-105%); transition: transform .25s ease; box-shadow: 0 6px 40px rgba(0,0,0,.4); }
      #right { right: 0; left: auto; transform: translateX(105%); }
      #left.open { transform: translateX(0); }
      #right.open { transform: translateX(0); }
      #toggleList, #togglePanel { display: inline-flex; }
      .fab { display: inline-flex; }
    }
  </style>
</head>
<body>
<div id="app">
  <header>
    <button id="toggleList" class="btn ghost">Lista</button>
    <div class="brand">EZ Street MX · Mapa de Bacheo</div>
    <div class="spacer"></div>
    <input id="kmlUrl" class="input" type="url" placeholder="URL del KML (por defecto: baches.kml)" />
    <button id="btnLoadUrl" class="btn">Cargar URL</button>
    <input id="kmlFile" type="file" accept=".kml,.kmz" style="display:none">
    <button id="btnLoadFile" class="btn ghost">KML local</button>
    <button id="togglePanel" class="btn ghost">Panel</button>
  </header>

  <aside id="left">
    <div class="searchWrap">
      <input id="txtFilter" type="search" placeholder="Buscar bache..." />
    </div>
    <div id="list"></div>
  </aside>

  <main id="map"></main>

  <aside id="right">
    <div class="panelTitle">
      <div id="titleSel">Selecciona un bache del mapa o de la lista</div>
    </div>
    <div class="content" id="detail"></div>
  </aside>
</div>

<!-- Mobile floating toggles -->
<div class="floating-toggle"><button class="fab" id="fabList">Lista</button></div>
<div class="floating-toggle right"><button class="fab" id="fabPanel">Panel</button></div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // UI elements
  const elLeft = $('#left');
  const elRight = $('#right');
  const elList = $('#list');
  const elDetail = $('#detail');
  const elTitleSel = $('#titleSel');
  const elKmlUrl = $('#kmlUrl');
  const elBtnLoadUrl = $('#btnLoadUrl');
  const elKmlFile = $('#kmlFile');
  const elBtnLoadFile = $('#btnLoadFile');
  const elTxtFilter = $('#txtFilter');
  const elToggleList = $('#toggleList');
  const elTogglePanel = $('#togglePanel');
  const elFabList = $('#fabList');
  const elFabPanel = $('#fabPanel');

  // Map
  const map = L.map('map', { zoomControl: true, preferCanvas: true }).setView([31.3, -110.93], 12);
  const sat = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3'],
    maxZoom: 20,
    attribution: '&copy; Google'
  });
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  });
  sat.addTo(map);
  L.control.layers({ 'Satélite': sat, 'Calles': osm }).addTo(map);

  let cluster = L.markerClusterGroup({
    showCoverageOnHover: false,
    chunkedLoading: true
  }).addTo(map);

  let features = []; // store parsed features

  // Helpers
  const qs = new URLSearchParams(location.search);
  const defaultKml = qs.get('data') || 'baches.kml';
  const cacheBust = qs.get('t') || Date.now();
  elKmlUrl.value = defaultKml;

  function clearAll(){
    cluster.clearLayers();
    features = [];
    elList.innerHTML = '';
    elDetail.innerHTML = '';
    elTitleSel.textContent = 'Selecciona un bache del mapa o de la lista';
  }

  function fitToMarkers(){
    if (features.length < 1) return;
    const group = L.featureGroup(features.map(f => f.marker));
    try { map.fitBounds(group.getBounds().pad(0.2)); } catch(e){}
  }

  function parseCoords(text){
    // KML Point->coordinates typically: lon,lat[,alt]
    const arr = (text || '').trim().split(',');
    if (arr.length < 2) return null;
    const lon = parseFloat(arr[0]);
    const lat = parseFloat(arr[1]);
    if (Number.isFinite(lat) && Number.isFinite(lon)) return [lat, lon];
    return null;
  }

  function parseDescription(html){
    // Extract up to 3 image links from anchor tags
    const out = [];
    try {
      const tmp = document.createElement('div');
      tmp.innerHTML = html || '';
      const links = tmp.querySelectorAll('a[href]');
      links.forEach(a => {
        const href = a.getAttribute('href');
        if (/^https?:\/\//i.test(href)) out.push(href);
      });
    } catch (e) {}
    return out.slice(0, 6);
  }

  function valOfSimpleData(node, name){
    const el = node.querySelector(`ExtendedData SchemaData SimpleData[name="${name}"]`);
    return el ? el.textContent.trim() : '';
  }

  function buildPopup(props){
    const lines = [];
    if (props.name) lines.push(`<b>${props.name}</b>`);
    const keys = ['Tipo de trabajo','TipoTrabajo','Ancho','Largo','Colonia','Calle','EntreCalles'];
    keys.forEach(k => {
      if (props[k]) lines.push(`<div>${k}: <b>${props[k]}</b></div>`);
    });
    if (props.coord) {
      const [lat, lon] = props.coord;
      const url = `https://www.google.com/maps?q=${lat},${lon}`;
      lines.push(`<div style="margin-top:6px"><a href="${url}" target="_blank" rel="noopener">Ver en Maps</a></div>`);
    }
    return lines.join('');
  }

  function selectFeature(f){
    // open right panel in mobile
    if (window.matchMedia('(max-width: 1024px)').matches) {
      elRight.classList.add('open');
    }
    const p = f.props;
    elTitleSel.textContent = p.name || 'Bache';
    const rows = [];
    const show = (label, key) => { if (p[key]) rows.push(`<div class="row"><b>${label}</b><div>${p[key]}</div></div>`); };
    show('Tipo de trabajo', 'Tipo de trabajo'); show('Tipo', 'TipoTrabajo');
    show('Ancho', 'Ancho'); show('Largo', 'Largo');
    show('Colonia', 'Colonia'); show('Calle', 'Calle'); show('Entre calles', 'EntreCalles');
    const chips = [];
    if (p.coord) chips.push(`<span class="chip">${p.coord[0].toFixed(6)}, ${p.coord[1].toFixed(6)}</span>`);
    const gmaps = p.coord ? `<a class="chip" href="https://www.google.com/maps?q=${p.coord[0]},${p.coord[1]}" target="_blank" rel="noopener">Ver en Maps</a>` : '';
    const photoGrid = (p.photos || []).map(h => `<img src="${h}" loading="lazy" />`).join('');
    elDetail.innerHTML = `
      <div class="chips">${chips.join(' ')} ${gmaps}</div>
      <div style="height:6px"></div>
      ${rows.join('')}
      ${photoGrid ? `<div class="photos">${photoGrid}</div>` : ''}
    `;
    // Pan & open popup
    f.marker.openPopup();
    map.setView(f.marker.getLatLng(), Math.max(16, map.getZoom()));
  }

  function addItemToList(f){
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `<div class="name">${f.props.name || 'sin nombre'}</div>
                    <div class="sub">${(f.props.coord || []).join(', ')}</div>`;
    el.onclick = () => selectFeature(f);
    elList.appendChild(el);
  }

  function addMarker(p){
    const marker = L.marker(p.coord, { title: p.name || '' });
    marker.bindPopup(buildPopup(p));
    marker.on('click', () => {
      const f = features.find(x => x.marker === marker);
      if (f) selectFeature(f);
    });
    cluster.addLayer(marker);
    const f = { marker, props: p };
    features.push(f);
    addItemToList(f);
  }

  async function loadKmlFromText(txt){
    clearAll();
    const xml = new DOMParser().parseFromString(txt, 'text/xml');
    const placemarks = Array.from(xml.getElementsByTagName('Placemark'));
    placemarks.forEach(pm => {
      const name = (pm.querySelector('name') || {}).textContent || '';
      const coordText = (pm.querySelector('Point > coordinates') || {}).textContent || '';
      const coord = parseCoords(coordText);
      if (!coord) return;
      const props = {
        name,
        coord,
        'Tipo de trabajo': valOfSimpleData(pm, 'TipodeTrabajo') || valOfSimpleData(pm, 'TipoTrabajo'),
        'TipoTrabajo': valOfSimpleData(pm, 'TipoTrabajo'),
        'Ancho': valOfSimpleData(pm, 'Ancho'),
        'Largo': valOfSimpleData(pm, 'Largo'),
        'Colonia': valOfSimpleData(pm, 'Colonia'),
        'Calle': valOfSimpleData(pm, 'Calle'),
        'EntreCalles': valOfSimpleData(pm, 'EntreCalles')
      };
      const desc = (pm.querySelector('description') || {}).textContent || '';
      const photos = parseDescription(desc);
      if (photos.length) props.photos = photos;
      addMarker(props);
    });
    fitToMarkers();
    // Update list count
    const badge = document.createElement('div');
    badge.textContent = `Listo: ${features.length}`;
    badge.style = 'position:sticky;top:0;background:#0b1220;border-bottom:1px solid #1f2937;padding:6px 12px;color:#9fb3c8';
    elList.prepend(badge);
  }

  async function loadKmlFromUrl(url){
    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      await loadKmlFromText(txt);
      console.log('KML cargado:', url);
    } catch(err){
      alert('No se pudo cargar el KML: '+err.message);
    }
  }

  // Search filter
  elTxtFilter.addEventListener('input', () => {
    const q = elTxtFilter.value.toLowerCase().trim();
    $$('#list .item').forEach((it) => {
      const txt = it.textContent.toLowerCase();
      it.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  // Buttons
  elBtnLoadUrl.onclick = () => {
    const url = elKmlUrl.value.trim() || defaultKml;
    loadKmlFromUrl(url);
  };
  elBtnLoadFile.onclick = () => elKmlFile.click();
  elKmlFile.onchange = async () => {
    const f = elKmlFile.files[0];
    if (!f) return;
    const txt = await f.text();
    await loadKmlFromText(txt);
  };

  // Drawer toggles (mobile)
  const toggleLeft = () => elLeft.classList.toggle('open');
  const toggleRight = () => elRight.classList.toggle('open');
  elToggleList.onclick = toggleLeft;
  elTogglePanel.onclick = toggleRight;
  elFabList.onclick = toggleLeft;
  elFabPanel.onclick = toggleRight;

  // Click on map closes drawers on mobile
  map.on('click', () => {
    if (window.matchMedia('(max-width: 1024px)').matches) {
      elLeft.classList.remove('open');
      elRight.classList.remove('open');
    }
  });

  // Initial load
  loadKmlFromUrl(`${defaultKml}${defaultKml.includes('?') ? '&' : '?'}t=${cacheBust}`);
})();
</script>
</body>
</html>
