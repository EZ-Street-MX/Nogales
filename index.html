<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>EZ Street MX · Mapa de Bacheo</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root {
      --bg:#0f1720;
      --panel:#0b1220;
      --muted:#9aa4b2;
      --text:#e5edf5;
      --accent:#22d3ee;
      --chip:#172033;
      --card:#0f1a2a;
      --border:#1f2a3a;
      --red:#ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    #app { display:flex; height:100%; width:100%; overflow:hidden; }
    /* left list (toggleable) */
    .sidebar {
      width: 320px; min-width: 260px; max-width: 360px;
      border-right: 1px solid var(--border);
      background: var(--panel);
      display:flex; flex-direction:column; gap:8px; padding:10px;
    }
    .sidebar header { display:flex; gap:8px; align-items:center; }
    .sidebar h1 { font-size:16px; margin:0; color:#cfe8ff; letter-spacing:.2px; }
    .search { width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:var(--text); }
    .list { overflow:auto; padding-right:4px; }
    .item { padding:10px; border-radius:12px; background:var(--card); margin-bottom:8px; cursor:pointer; border:1px solid transparent; }
    .item:hover { border-color: var(--border); }
    .coords { color: var(--muted); font-size:12px; }
    /* map */
    #map { flex:1 1 auto; height:100%; }
    .leaflet-container { background:#000; }
    /* right detail panel */
    .detail {
      width: 420px; min-width: 320px; max-width: 520px;
      border-left: 1px solid var(--border);
      background: var(--panel);
      display:flex; flex-direction:column; gap:8px; padding:12px;
    }
    .row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .btn { background:var(--chip); color:#cce7ff; padding:8px 12px; border-radius:999px; border:1px solid var(--border); cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .grid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
    figure { margin:0; }
    .ph {
      background:#0a111d;
      border:1px dashed #2a3a55;
      height:110px; border-radius:12px;
      display:grid; place-items:center; color:#6b7990; font-size:12px;
      overflow:hidden;
    }
    .ph img { width:100%; height:100%; object-fit:cover; display:block; }
    .meta { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .meta .kv { background:#0d1626; border:1px solid var(--border); border-radius:12px; padding:10px; }
    .kv .k { color:var(--muted); font-size:12px; }
    .kv .v { font-weight:600; margin-top:2px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); }
    .dot { width:8px; height:8px; background:var(--red); border-radius:50%; box-shadow: 0 0 0 2px rgba(239,68,68,.25); }
    .empty { color:var(--muted); font-size:13px; }
    .hidden { display:none; }
    /* mobile */
    @media (max-width: 1024px) {
      .sidebar { display:none; }
      .detail { max-width: 100vw; width: 100vw; position: absolute; right:0; bottom:0; top:auto; z-index:999; border-left: none; border-top:1px solid var(--border); border-radius:16px 16px 0 0; }
      .detail .grid { grid-template-columns: repeat(3, 1fr); }
    }
    /* small helper control buttons */
    .floating {
      position: absolute; z-index: 500; left:10px; top:10px; display:flex; gap:8px;
    }
    .fbtn { background: var(--chip); border:1px solid var(--border); color:#d2eaff; padding:7px 10px; border-radius:10px; cursor:pointer; }
  </style>
</head>
<body>
<div id="app">
  <aside class="sidebar" id="sidebar">
    <header>
      <h1>EZ Street MX · Mapa de Bacheo <span class="badge"><span class="dot"></span> Baches</span></h1>
    </header>
    <input id="q" class="search" placeholder="Buscar bache… (por id, calle, colonia)">
    <div id="list" class="list"></div>
  </aside>
  <div id="map"></div>

  <aside class="detail" id="detail">
    <div class="row">
      <strong id="title">Baches</strong>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="openMaps">Ver en Maps</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:600; margin-bottom:8px;">FOTOS</div>
      <div class="grid">
        <figure class="ph"><img id="imgAntes" alt="Foto antes"></figure>
        <figure class="ph"><img id="imgRef"   alt="Foto referencia"></figure>
        <figure class="ph"><img id="imgFinal" alt="Foto final"></figure>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:600; margin-bottom:8px;">MEDIDAS</div>
      <div class="meta">
        <div class="kv"><div class="k">Ancho</div><div class="v" id="vAncho">—</div></div>
        <div class="kv"><div class="k">Largo</div><div class="v" id="vLargo">—</div></div>
        <div class="kv"><div class="k">Tipo</div><div class="v" id="vTipo">—</div></div>
        <div class="kv"><div class="k"># Bache</div><div class="v" id="vNum">—</div></div>
        <div class="kv"><div class="k">Cadenamiento</div><div class="v" id="vCad">—</div></div>
        <div class="kv"><div class="k">Colonia</div><div class="v" id="vColonia">—</div></div>
        <div class="kv"><div class="k">Calle</div><div class="v" id="vCalle">—</div></div>
        <div class="kv"><div class="k">Entre calles</div><div class="v" id="vEntre">—</div></div>
      </div>
    </div>
    <div class="empty" id="emptyMsg">Selecciona un bache del mapa o de la lista</div>
  </aside>
</div>

<!-- helper buttons -->
<div class="floating">
  <button class="fbtn" id="toggleList">Lista</button>
  <button class="fbtn" id="togglePanel">Panel</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@5.7.0/dist/togeojson.umd.min.js"></script>

<script>
(function () {
  // --- UI helpers
  const $ = (s) => document.querySelector(s);
  const listEl = $('#list');
  const qEl = $('#q');
  const sidebarEl = $('#sidebar');
  const detailEl = $('#detail');
  const emptyMsgEl = $('#emptyMsg');

  const imgAntes = $('#imgAntes');
  const imgRef = $('#imgRef');
  const imgFinal = $('#imgFinal');
  const titleEl = $('#title');

  const vAncho = $('#vAncho');
  const vLargo = $('#vLargo');
  const vTipo = $('#vTipo');
  const vNum = $('#vNum');
  const vCad = $('#vCad');
  const vColonia = $('#vColonia');
  const vCalle = $('#vCalle');
  const vEntre = $('#vEntre');

  // Toggle UI
  $('#toggleList').onclick = () => {
    sidebarEl.style.display = (getComputedStyle(sidebarEl).display === 'none') ? 'flex' : 'none';
  };
  $('#togglePanel').onclick = () => {
    detailEl.style.display = (getComputedStyle(detailEl).display === 'none') ? 'flex' : 'none';
  };

  // --- Map
  const map = L.map('map', {
    zoomControl: false, // pinch/scroll to zoom; avoids on-screen +/-
    minZoom: 2,
    maxZoom: 22, // allow deeper zoom
    preferCanvas: true,
  }).setView([31.3, -110.94], 13);

  // High-zoom satellite tiles
  const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 21,
    subdomains:['mt0','mt1','mt2','mt3'],
    attribution: '&copy; Google / contributors'
  });

  const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap'
  });

  satellite.addTo(map);

  // --- KML loading
  function getParam(name, def) {
    const url = new URL(location.href);
    return url.searchParams.get(name) ?? def;
  }
  const kmlUrl = getParam('data', 'baches.kml');

  async function loadKML(url) {
    const res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('No se pudo leer KML: ' + res.status);
    const text = await res.text();
    const dom = new DOMParser().parseFromString(text, 'text/xml');
    // Convert to GeoJSON
    const gj = toGeoJSON.kml(dom);
    return gj;
  }

  function firstOf(obj, keys, fallback='') {
    for (const k of keys) {
      if (obj && obj[k] != null && String(obj[k]).trim() !== '') return obj[k];
    }
    return fallback;
  }

  function tryHttpsOrProxy(rawUrl) {
    if (!rawUrl) return '';
    let u = (''+rawUrl).trim();
    if (!u) return '';
    // Prefer https
    if (u.startsWith('http://')) u = 'https://' + u.slice(7);
    // If still http or blocked (mixed content), we can proxy
    // Avoid double encoding domain for weserv
    try {
      const https = new URL(u);
      if (https.protocol === 'https:') return u;
    } catch(e) {}
    // Fallback proxy (handles CORS + mixed content)
    const clean = u.replace(/^https?:\/\//,'');
    return 'https://images.weserv.nl/?url=' + encodeURIComponent(clean);
  }

  let geoLayer, cluster;
  let features = [];
  let byId = new Map();

  function renderList(items) {
    listEl.innerHTML = '';
    for (const f of items) {
      const li = document.createElement('div');
      li.className = 'item';
      li.innerHTML = '<div style="font-weight:600;">' + (f._title || f.id || f.properties.name || 'Bache') + '</div>' +
                     (f.geometry?.coordinates ? '<div class="coords">'+ f.geometry.coordinates[1].toFixed(6)+', '+ f.geometry.coordinates[0].toFixed(6) +'</div>' : '');
      li.onclick = () => selectFeature(f, true);
      listEl.appendChild(li);
    }
  }

  function makeTitle(props) {
    return props.name || props.id || firstOf(props, ['kml_','kml','Name','Nombre'], 'Baches');
  }

  function selectFeature(f, fromList=false) {
    const p = f.properties || {};
    titleEl.textContent = makeTitle(p);

    vAncho.textContent = firstOf(p, ['Ancho','ancho','WIDTH','XPosition'], '—');
    vLargo.textContent = firstOf(p, ['Largo','largo','LENGTH','YPosition'], '—');
    vTipo.textContent  = firstOf(p, ['TipoDeTrabajo','Tipo','tipodetrabajo','Tipo Bache','TipodeTrabajo'], '—');
    vNum.textContent   = firstOf(p, ['NumerodeBache','NumeroBache','NumBache','#Bache','numeroDeBache'], '—');
    vCad.textContent   = firstOf(p, ['Cadenamiento','cadenamiento','Cadenamiento0'], '—');
    vColonia.textContent = firstOf(p, ['Colonia','colonia'], '—');
    vCalle.textContent = firstOf(p, ['Calle','calle'], '—');
    vEntre.textContent = firstOf(p, ['EntreCalles','EntreCalles ' ,'entreCalles','entrecalles','Entre calles'], '—');

    const imgA = tryHttpsOrProxy(firstOf(p, ['Fotoantes','FotoAntes','Foto_antes','FotoAntesUrl','Foto antes']));
    const imgR = tryHttpsOrProxy(firstOf(p, ['FotoReferencia','Fotoreferencia','Foto Ref','Foto_ref']));
    const imgF = tryHttpsOrProxy(firstOf(p, ['FotoFinal','Fotofinal','Foto final','Foto_final']));

    function setImg(imgEl, url) {
      if (url) {
        imgEl.src = url;
        imgEl.parentElement.onclick = () => window.open(url, '_blank');
        imgEl.alt = 'foto';
      } else {
        imgEl.removeAttribute('src');
        imgEl.parentElement.onclick = null;
      }
    }
    setImg(imgAntes, imgA);
    setImg(imgRef, imgR);
    setImg(imgFinal, imgF);

    emptyMsgEl.classList.add('hidden');

    if (f._latlng && fromList) {
      map.setView(f._latlng, Math.max(map.getZoom(), 19), {animate:true});
    }
  }

  function buildLayers(gj) {
    if (cluster) { map.removeLayer(cluster); }
    cluster = L.markerClusterGroup({
      disableClusteringAtZoom: 18,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      maxClusterRadius: 40
    });

    geoLayer = L.geoJSON(gj, {
      pointToLayer: (feat, latlng) => {
        // Small red dots instead of default markers
        const m = L.circleMarker(latlng, {
          radius: 5,
          color: '#ff3344',
          weight: 1,
          fillColor: '#ff3344',
          fillOpacity: 0.9
        });
        // Keep reference for selection
        m.feature = feat;
        m.on('click', () => selectFeature(m.feature));
        // store quick access
        m.feature._latlng = latlng;
        return m;
      },
      onEachFeature: (feat, layer) => {
        // compute display title
        feat._title = makeTitle(feat.properties || {});
        // index by id if exists
        const id = feat.id || feat.properties?.name || feat._title;
        if (id) byId.set(id, feat);
      }
    });

    cluster.addLayer(geoLayer);
    cluster.addTo(map);

    // Fit map to data
    try {
      map.fitBounds(cluster.getBounds().pad(0.15));
    } catch(e) {}

    // Build side list
    features = geoLayer.getLayers().map(l => l.feature);
    renderList(features);
  }

  function filterList(text) {
    const t = text.trim().toLowerCase();
    if (!t) return renderList(features);
    const items = features.filter(f => {
      const p = f.properties || {};
      const hay = [f._title, p.Calle, p.Colonia, p.Cadenamiento, p.NumerodeBache]
        .map(x => (x||'')+'').join(' ').toLowerCase();
      return hay.includes(t);
    });
    renderList(items);
  }

  qEl.addEventListener('input', () => filterList(qEl.value));

  // Load KML now
  loadKML(kmlUrl)
    .then(buildLayers)
    .catch(err => {
      console.error(err);
      alert('No se pudo cargar el KML: ' + err.message);
    });

  // External link button
  document.getElementById('openMaps').onclick = () => {
    const center = map.getCenter();
    const z = Math.round(map.getZoom());
    const url = `https://www.google.com/maps/@${center.lat},${center.lng},${z}z`;
    window.open(url, '_blank');
  };

  // Base layer switch (optional via keyboard: s to toggle streets/satellite)
  document.addEventListener('keydown', (e) => {
    if (e.key.toLowerCase() === 's') {
      if (map.hasLayer(satellite)) {
        map.removeLayer(satellite); streets.addTo(map);
      } else {
        map.removeLayer(streets); satellite.addTo(map);
      }
    }
  });
})();</script>
</body>
</html>
