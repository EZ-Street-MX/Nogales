<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>EZ Street MX · Mapa de Bacheo (satélite)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- toGeoJSON (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@5.7.0/dist/togeojson.umd.js"></script>
  <!-- JSZip para leer KMZ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root{
      --bg:#0f1720;
      --panel:#111b27;
      --text:#e6eef8;
      --muted:#9fb3c8;
      --accent:#16a34a;
      --accent-2:#0ea5e9;
      --chip:#1f2a37;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent-2);text-decoration:none} a:hover{text-decoration:underline}

    /* Layout */
    .topbar{
      height:44px;display:flex;gap:.5rem;align-items:center;
      padding:.4rem .6rem;border-bottom:1px solid #1c2a37;background:var(--panel);
      position:sticky;top:0;z-index:900;
    }
    .title{font-weight:600;margin-left:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .grow{flex:1}
    .btn{background:#1f2a37;border:1px solid #2b3b4f;color:var(--text);
         padding:.45rem .65rem;border-radius:.5rem;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .input{background:#0d1620;border:1px solid #253547;color:var(--text);
           padding:.45rem .6rem;border-radius:.5rem;min-width:220px}
    @media (max-width:1000px){
      .input{display:none}
      .title{display:none}
    }

    .wrap{height:calc(100% - 44px);display:grid;grid-template-columns: 290px 1fr 360px}
    @media (max-width:1200px){
      .wrap{grid-template-columns: 270px 1fr 320px}
    }
    @media (max-width:980px){
      .wrap{grid-template-columns: 1fr}
      .left{position:absolute;z-index:850;inset:44px auto 0 0;width:min(86vw,360px);transform:translateX(-100%);transition:.2s}
      .left.open{transform:none}
      .right{position:absolute;z-index:850;inset:44px 0 0 auto;width:min(86vw,360px);transform:translateX(100%);transition:.2s}
      .right.open{transform:none}
    }

    .left{background:var(--panel);border-right:1px solid #1c2a37;display:flex;flex-direction:column;min-height:0}
    .left-header{display:flex;gap:.5rem;align-items:center;padding:.5rem;border-bottom:1px solid #1c2a37}
    .search{flex:1}
    .list{overflow:auto;padding:.25rem 0}
    .row{padding:.65rem .75rem;border-bottom:1px dashed #1c2a37;cursor:pointer}
    .row:hover{background:#0d1620}
    .row .sub{color:var(--muted);font-size:12px;margin-top:.15rem}

    #map{height:100%;width:100%}

    .right{background:var(--panel);border-left:1px solid #1c2a37;display:flex;flex-direction:column;min-height:0}
    .right-header{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-bottom:1px solid #1c2a37}
    .detail{overflow:auto;padding:.75rem}
    .dl{display:grid;grid-template-columns:130px 1fr;gap:.4rem .8rem}
    .dl b{color:#9ec5ff}
    .chips{display:flex;gap:.4rem;flex-wrap:wrap;margin:.35rem 0 .6rem}
    .chip{background:var(--chip);border:1px solid #2b3b4f;border-radius:999px;padding:.15rem .55rem;font-size:12px;color:#cfe2ff}
    .photos{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
    .photos a{display:block;aspect-ratio:4/3;background:#0b121a;border:1px solid #1c2a37;border-radius:.5rem;overflow:hidden}
    .photos img{width:100%;height:100%;object-fit:cover;display:block}

    /* Toggle handles (mobile) */
    .handle-left,.handle-right{
      position:absolute;top:52px;z-index:860;background:var(--panel);border:1px solid #1c2a37;
      width:20px;height:48px;display:none;align-items:center;justify-content:center;border-radius:0 6px 6px 0
    }
    .handle-right{right:0;border-radius:6px 0 0 6px}
    @media (max-width:980px){
      .handle-left,.handle-right{display:flex}
    }

    /* Dot marker */
    .dot{background:#dc2626;border:2px solid #fff;border-radius:50%;width:10px;height:10px;box-shadow:0 0 0 1px #0003}
    .dot-selected{background:#22d3ee;border-color:#fff;width:12px;height:12px}

    /* Cluster style – sutil y ligero */
    .marker-cluster-small{background:#16653433;border:2px solid #16a34a}
    .marker-cluster-small div{background:#16a34a;color:#fff}
    .marker-cluster-medium{background:#16653433;border:2px solid #16a34a}
    .marker-cluster-medium div{background:#16a34a;color:#fff}
    .marker-cluster-large{background:#16653433;border:2px solid #16a34a}
    .marker-cluster-large div{background:#16a34a;color:#fff}
  </style>
</head>
<body>
  <div class="topbar">
    <button id="btnList" class="btn">☰ Lista</button>
    <div class="title">EZ Street MX · Mapa de Bacheo</div>
    <input id="urlInput" class="input grow" placeholder="URL del KML (por defecto: baches.kml)" />
    <button id="btnUrl" class="btn">Cargar URL</button>
    <input id="fileInput" type="file" accept=".kml,.kmz" style="display:none" />
    <button id="btnLocal" class="btn">KML local</button>
    <button id="btnRefresh" class="btn">Actualizar</button>
    <button id="btnInfo" class="btn">Panel</button>
  </div>

  <div class="wrap">
    <div class="left" id="left">
      <div class="left-header">
        <input id="search" class="input search" placeholder="Buscar bache…" />
        <span id="count" class="chip">Listo: 0</span>
      </div>
      <div class="list" id="list"></div>
    </div>

    <div id="map"></div>

    <div class="right" id="right">
      <div class="right-header">
        <div id="featTitle">Selecciona un bache del mapa o de la lista</div>
        <div class="chips">
          <span id="coordChip" class="chip" style="display:none"></span>
          <a id="mapsLink" target="_blank" class="chip" style="display:none">Ver en Maps</a>
        </div>
      </div>
      <div class="detail" id="detail"></div>
    </div>

    <div class="handle-left" id="handleLeft">❯</div>
    <div class="handle-right" id="handleRight">❮</div>
  </div>

<script>
(() => {
  // ---------- Utilidades ----------
  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const detailEl = $('#detail');
  const featTitleEl = $('#featTitle');
  const coordChip = $('#coordChip');
  const mapsLink = $('#mapsLink');

  function getParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }
  function setParam(name, value){
    const u = new URL(location.href);
    if(value==null) u.searchParams.delete(name);
    else u.searchParams.set(name, value);
    history.replaceState(null,'',u.toString());
  }

  // ---------- Mapa + capas ----------
  const map = L.map('map', {
    zoomControl: false,
    minZoom: 3,
    maxZoom: 22,          // más zoom para separar baches
    worldCopyJump: true
  }).setView([31.307, -110.937], 12);

  // Controles de zoom más grandes (útiles en móvil)
  L.control.zoom({ position:'topleft' }).addTo(map);

  const sat = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { maxNativeZoom: 19, maxZoom: 22, attribution:'&copy; Esri, Maxar, Earthstar Geographics' }
  ).addTo(map);

  const streets = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 20, attribution: '&copy; OpenStreetMap' }
  );

  // Botoncitos simples de capas
  const switcher = L.control({position:'bottomright'});
  switcher.onAdd = () => {
    const div = L.DomUtil.create('div','');
    div.innerHTML = `
      <div style="display:flex;gap:.5rem;background:var(--panel);border:1px solid #1c2a37;border-radius:.6rem;padding:.4rem">
        <button id="satBtn" class="btn">Satélite</button>
        <button id="strBtn" class="btn">Calles</button>
      </div>`;
    return div;
  }
  switcher.addTo(map);
  $('#satBtn').onclick = () => { map.removeLayer(streets); sat.addTo(map); };
  $('#strBtn').onclick = () => { map.removeLayer(sat); streets.addTo(map); };

  // Icono puntito rojo
  const dotIcon = L.divIcon({ className:'dot', iconSize:[10,10] });
  const dotIconSel = L.divIcon({ className:'dot-selected', iconSize:[12,12] });

  // Grupo de clusters (muy liviano)
  const clusters = L.markerClusterGroup({
    spiderfyOnMaxZoom: true,
    disableClusteringAtZoom: 19,
    maxClusterRadius: 55
  }).addTo(map);

  let featureMarkers = [];   // para búsquedas
  let currentMarker = null;

  // ---------- Lista lateral ----------
  function renderList(items){
    const q = ($('#search').value||'').trim().toLowerCase();
    const frag = document.createDocumentFragment();
    let visible = 0;
    items.forEach((m,i)=>{
      const nm = (m.feature?.properties?.name || `bache_${i+1}`);
      if(q && !nm.toLowerCase().includes(q)) return;
      const li = document.createElement('div');
      li.className='row';
      const c = m.getLatLng();
      li.innerHTML = `<div>${nm}</div><div class="sub">${c.lat.toFixed(6)}, ${c.lng.toFixed(6)}</div>`;
      li.onclick = () => focusMarker(m);
      frag.appendChild(li);
      visible++;
    });
    listEl.innerHTML='';
    listEl.appendChild(frag);
    $('#count').textContent = `Listo: ${visible}`;
  }
  $('#search').addEventListener('input', () => renderList(featureMarkers));

  // ---------- Detalle ----------
  function focusMarker(m){
    if(!m) return;
    if(currentMarker) currentMarker.setIcon(dotIcon);
    currentMarker = m;
    m.setIcon(dotIconSel);
    const c = m.getLatLng();
    map.setView(c, Math.max(map.getZoom(), 18), {animate:true});
    showDetail(m.feature, c);
  }

  function showDetail(feat, latlng){
    const p = feat?.properties || {};
    const nm = p.name || 'bache';
    featTitleEl.textContent = nm;
    coordChip.style.display='inline-block';
    coordChip.textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
    mapsLink.style.display='inline-block';
    mapsLink.href = `https://maps.google.com/?q=${latlng.lat},${latlng.lng}`;

    // Detectar posibles campos de interés
    const labelOrder = ['Tipo de Trabajo','TipoDeTrabajo','Ancho','Largo','Colonia','Calle','Entrecalles','Entre calles','Cadenamiento','Collector','Createdon','Workspace','Numero de Bache','NumerodeBache'];
    const fotosKeys = Object.keys(p||{}).filter(k=>/foto/i.test(k));

    let html = '<div class="dl">';
    labelOrder.forEach(key=>{
      if(p[key]!=null && String(p[key]).trim()!==''){
        html += `<b>${key}</b><div>${p[key]}</div>`;
      }
    });
    // Mostrar el resto (sin duplicar)
    Object.keys(p||{}).forEach(k=>{
      if(k==='name') return;
      if(labelOrder.includes(k)) return;
      if(/foto/i.test(k)) return;
      const v = p[k];
      if(v==null || String(v).trim()==='') return;
      html += `<b>${k}</b><div>${v}</div>`;
    });
    html += '</div>';

    if(fotosKeys.length){
      html += `<h4 style="margin:.9rem 0 .4rem">Fotos</h4><div class="photos">`;
      fotosKeys.forEach(k=>{
        const val = (p[k]||'').toString();
        const url = (val.match(/https?:\/\/\S+/) || [val])[0];
        if(!url) return;
        html += `<a href="${url}" target="_blank" rel="noopener">
                   <img loading="lazy" src="${url}" alt="${k}"/>
                 </a>`;
      });
      html += `</div>`;
    }
    detailEl.innerHTML = html;
  }

  // ---------- Carga de KML/KMZ ----------
  async function fetchAsText(url){
    const isKmz = /\.kmz(\?|$)/i.test(url);
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    if(isKmz){
      const ab = await res.arrayBuffer();
      const zip = await JSZip.loadAsync(ab);
      const kmlFile = zip.file(/\.kml$/i)[0];
      if(!kmlFile) throw new Error('KMZ sin .kml interno');
      return await kmlFile.async('string');
    }else{
      return await res.text();
    }
  }

  function kmlTextToGeoJSON(kmlText){
    const xml = new DOMParser().parseFromString(kmlText,'text/xml');
    return toGeoJSON.kml(xml);
  }

  function clearMap(){
    clusters.clearLayers();
    featureMarkers = [];
    listEl.innerHTML='';
    $('#count').textContent = 'Listo: 0';
    detailEl.innerHTML='';
    featTitleEl.textContent='Selecciona un bache del mapa o de la lista';
    coordChip.style.display='none';
    mapsLink.style.display='none';
  }

  function addGeoJSON(geo){
    // Pueden venir Multipoints de KML; normalizamos a features puntuales
    const feats = (geo?.features || []).filter(f=>f.geometry);
    feats.forEach((f, idx) => {
      // nombre legible
      if(!f.properties) f.properties = {};
      if(!f.properties.name) f.properties.name = 'kml_'+(idx+1);

      const ll = getLatLngFromGeom(f.geometry);
      if(!ll) return;
      const marker = L.marker(ll, { icon: dotIcon });
      marker.feature = f;
      marker.on('click', () => focusMarker(marker));
      featureMarkers.push(marker);
      clusters.addLayer(marker);
    });
    renderList(featureMarkers);
  }

  function getLatLngFromGeom(g){
    if(!g) return null;
    if(g.type === 'Point') return L.latLng(g.coordinates[1], g.coordinates[0]);
    if(g.type === 'MultiPoint' && g.coordinates.length){
      return L.latLng(g.coordinates[0][1], g.coordinates[0][0]);
    }
    // si llega otra geometría, la ignoramos
    return null;
  }

  async function loadKmlFromUrl(url){
    try{
      clearMap();
      const kmlText = await fetchAsText(url);
      const gj = kmlTextToGeoJSON(kmlText);
      addGeoJSON(gj);
      if(featureMarkers.length){
        const g = L.featureGroup(featureMarkers);
        map.fitBounds(g.getBounds().pad(0.2));
      }
    }catch(err){
      alert('No se pudo cargar el KML: '+err.message);
    }
  }

  async function loadKmlFromFile(file){
    if(!file) return;
    try{
      clearMap();
      const isKmz = /\.kmz$/i.test(file.name);
      let kmlText = '';
      if(isKmz){
        const ab = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(ab);
        const kmlFile = zip.file(/\.kml$/i)[0];
        if(!kmlFile) throw new Error('KMZ sin .kml interno');
        kmlText = await kmlFile.async('string');
      }else{
        kmlText = await file.text();
      }
      const gj = kmlTextToGeoJSON(kmlText);
      addGeoJSON(gj);
      if(featureMarkers.length){
        const g = L.featureGroup(featureMarkers);
        map.fitBounds(g.getBounds().pad(0.2));
      }
    }catch(err){
      alert('No se pudo cargar el KML local: '+err.message);
    }
  }

  // ---------- Controles ----------
  const defaultUrl = getParam('data') || 'baches.kml';
  $('#urlInput').value = defaultUrl;

  $('#btnUrl').onclick = () => {
    const u = $('#urlInput').value.trim() || 'baches.kml';
    setParam('data', u);
    setParam('t', Date.now()); // rompecaché
    loadKmlFromUrl(u + (u.includes('?')?'&':'?') + 't=' + Date.now());
  };
  $('#btnLocal').onclick = () => $('#fileInput').click();
  $('#fileInput').onchange = e => {
    const f = e.target.files?.[0];
    if(f) loadKmlFromFile(f);
  };
  $('#btnRefresh').onclick = () => {
    const u = $('#urlInput').value.trim() || defaultUrl;
    setParam('t', Date.now());
    loadKmlFromUrl(u + (u.includes('?')?'&':'?') + 't=' + Date.now());
  };

  // Mostrar/ocultar paneles (recordando preferencia)
  const left = $('#left'), right = $('#right');
  const btnList = $('#btnList'), btnInfo = $('#btnInfo');
  const handleLeft = $('#handleLeft'), handleRight = $('#handleRight');

  function setLeft(open){
    left.classList.toggle('open', open);
    localStorage.setItem('ui_left', open ? '1':'0');
  }
  function setRight(open){
    right.classList.toggle('open', open);
    localStorage.setItem('ui_right', open ? '1':'0');
  }

  btnList.onclick = () => setLeft(!left.classList.contains('open'));
  btnInfo.onclick = () => setRight(!right.classList.contains('open'));
  handleLeft.onclick = () => setLeft(!left.classList.contains('open'));
  handleRight.onclick = () => setRight(!right.classList.contains('open'));

  // Estado inicial
  setLeft(localStorage.getItem('ui_left') !== '0');   // abierto la primera vez
  setRight(localStorage.getItem('ui_right') === '1'); // cerrado por defecto en móvil

  // Carga inicial del KML por URL (?data=...)
  loadKmlFromUrl(defaultUrl + (defaultUrl.includes('?')?'&':'?') + 't=' + (getParam('t') || Date.now()));
})();
</script>
</body>
</html>
