<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>EZ Street MX · Mapa de Bacheo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
  :root{
    --bg: #0f1620;
    --panel:#0d1a28;
    --muted:#8aa2b7;
    --card:#0b1521;
    --accent:#19a5ff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e7eef6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
  #app{display:grid;grid-template-columns: 1fr 380px; grid-template-rows: 56px 1fr; height:100%}
  header{
    grid-column: 1 / span 2; grid-row: 1;
    display:flex; align-items:center; gap:12px;
    padding:10px 14px; background:#0b1521; border-bottom:1px solid #102030;
  }
  .brand{font-weight:600}
  .data-url{flex:1; min-width:180px; border:1px solid #10324a; background:#0a1724; color:#dce8f3; border-radius:10px; padding:10px 12px;}
  .pill{padding:6px 10px; border-radius:999px; background:#0a1724; border:1px solid #123447; color:#cfe7ff; font-size:12px}
  .ghost{background:transparent; border:1px solid #17344a; color:#a9c7de}
  .right{margin-left:auto}
  #map{grid-column:1; grid-row: 2; height:100%; width:100%}
  #panel{
    grid-column:2; grid-row: 2; height:100%; overflow:auto;
    background:var(--panel); border-left:1px solid #102030;
  }

  .panel-inner{padding:14px}
  .h-row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .title{font-weight:700}
  .btn{cursor:pointer; border:1px solid #17344a; background:#0b1f2d; color:#e8f3ff; padding:8px 10px; border-radius:10px; font-size:13px}
  .measure-card{background:#0a1724; border:1px solid #11324a; border-radius:14px; padding:12px;}
  .kv{display:grid; grid-template-columns: 140px 1fr; gap:8px 14px; font-size:14px}
  .kv .k{color:var(--muted)}
  .photos{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin:6px 0 14px}
  .ph{
    position:relative; height:110px; border:1px dashed #1c4863; border-radius:12px; overflow:hidden; background:linear-gradient(180deg,#0a1724,#07121b);
    display:flex; align-items:center; justify-content:center; color:#6aaad8; font-size:12px;
  }
  .ph img{width:100%; height:100%; object-fit:cover; display:block}
  .ph a{position:absolute; inset:0; display:block}
  .hint{font-size:12px; color:#89a9bf; margin-top:4px}
  .cluster-green{background:#5fb75f; color:#001; border:2px solid #e6ffe6}
  .cluster-green div{background:#9df09d; color:#003; border-radius:999px}
  .leaflet-control-attribution{display:none}
  @media (max-width: 980px){
    #app{grid-template-columns: 1fr; grid-template-rows: 56px minmax(320px,1fr) auto}
    #map{grid-column:1; grid-row: 2;}
    #panel{grid-column:1; grid-row: 3; height:auto}
  }
</style>
</head>
<body>
  <div id="app">
    <header>
      <span class="brand">EZ Street MX · Mapa de Bacheo</span>
      <input id="kmlInput" class="data-url" placeholder="KML (por defecto: baches.kml)" value="">
      <button id="btnLoad" class="btn">Cargar</button>
      <button id="btnRefresh" class="btn ghost">Actualizar</button>
      <span class="right pill" id="count">Listo: 0</span>
    </header>
    <div id="map"></div>
    <aside id="panel">
      <div class="panel-inner">
        <div class="h-row">
          <div class="title" id="recTitle">Selecciona un bache…</div>
          <a id="mapsLink" class="btn" href="#" target="_blank" rel="noopener">Ver en Maps</a>
        </div>

        <div>
          <div class="photos">
            <div class="ph"><span id="phA_lbl">Antes</span><img id="phA" alt="Foto antes" style="display:none"><a id="phA_a" target="_blank" rel="noopener"></a></div>
            <div class="ph"><span id="phR_lbl">Referencia</span><img id="phR" alt="Foto referencia" style="display:none"><a id="phR_a" target="_blank" rel="noopener"></a></div>
            <div class="ph"><span id="phF_lbl">Final</span><img id="phF" alt="Foto final" style="display:none"><a id="phF_a" target="_blank" rel="noopener"></a></div>
          </div>
          <div class="measure-card">
            <div class="kv">
              <div class="k">Ancho</div><div id="vAncho">—</div>
              <div class="k">Largo</div><div id="vLargo">—</div>
              <div class="k">Tipo</div><div id="vTipo">—</div>
              <div class="k"># Bache</div><div id="vNum">—</div>
              <div class="k">Cadenamiento</div><div id="vCad">—</div>
              <div class="k">Colonia</div><div id="vCol">—</div>
              <div class="k">Calle</div><div id="vCalle">—</div>
              <div class="k">Entre calles</div><div id="vEntre">—</div>
            </div>
          </div>
          <div class="hint">* Si una foto no aparece, revisa que el enlace del KML sea público. Usamos un proxy seguro para sortear CORS.</div>
        </div>
      </div>
    </aside>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@4.5.0/dist/togeojson.umd.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const qs = (n, arr)=> arr.find(k=>n[k] != null && n[k] !== '') ?? '';

  function getParam(name, def=''){
    const u = new URL(location.href);
    return u.searchParams.get(name) ?? def;
  }

  // Proxy helper (fix for CORS + bad protocols)
  function driveFix(url){
    // Google Drive shared link -> direct
    const m = String(url).match(/drive\\.google\\.com\\/file\\/d\\/([^/]+)/i);
    if(m){ return `https://drive.google.com/uc?export=view&id=${m[1]}`; }
    return url;
  }
  function proxify(url){
    if(!url) return '';
    let u = String(url).trim();
    if(/^data:image\\//i.test(u)) return u; // data URL ok
    u = driveFix(u);
    // images.weserv.nl expects domain/path without protocol
    u = u.replace(/^https?:\\/\\//i,'').replace(/^\\/+/, '');
    return 'https://images.weserv.nl/?url=' + encodeURIComponent(u);
  }

  // Map
  const map = L.map('map', {
    zoomControl: false, // oculta +/-
    preferCanvas: true
  });
  const esri = L.tileLayer(
    'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
    { attribution:'&copy; Esri', maxNativeZoom: 19, maxZoom: 22, detectRetina:true }
  ).addTo(map);

  // MarkerCluster
  const cluster = L.markerClusterGroup({
    disableClusteringAtZoom: 20,
    spiderfyOnMaxZoom: true,
    spiderfyDistanceMultiplier: 1.2,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true,
    maxClusterRadius: 40,
    removeOutsideVisibleBounds: true,
    chunkedLoading: true
  }).addTo(map);

  const redStyle = {
    radius: 5, color: '#ff4d4d', fillColor:'#ff4d4d', fillOpacity: 0.9, weight: 1
  };

  let features = [];

  function field(obj, keys, fallback='—'){
    if(!obj) return fallback;
    for(const k of keys){
      if(obj[k] != null && String(obj[k]).trim() !== '') return String(obj[k]);
    }
    return fallback;
  }

  function imgFromProps(p, keys){
    const raw = field(p, keys, '');
    if(!raw) return '';
    return proxify(raw);
  }

  function fillPanel(f){
    const p = f.properties || {};
    $('#recTitle').textContent = p.name || p.Nombre || f.id || 'Baches';

    // Fotos
    const before = imgFromProps(p, ['Fotoantes','FotoAntes','fotoantes','Foto_antes','Foto antes','FOTOANTES','Foto Antes']);
    const ref    = imgFromProps(p, ['FotoReferencia','Foto_Referencia','fotoReferencia','Foto ref','FotoRef']);
    const final  = imgFromProps(p, ['FotoFinal','Foto_Final','fotofinal','Foto final','Foto Final']);

    const setPh = (imgId, linkId, labelId, url)=>{
      const img = $(imgId), a = $(linkId), lbl = $(labelId);
      if(url){
        img.src = url; img.style.display='block'; a.href = url; lbl.style.display='none';
      }else{
        img.removeAttribute('src'); img.style.display='none'; a.removeAttribute('href'); lbl.style.display='inline';
      }
    }
    setPh('#phA','#phA_a','#phA_lbl', before);
    setPh('#phR','#phR_a','#phR_lbl', ref);
    setPh('#phF','#phF_a','#phF_lbl', final);

    // Medidas
    $('#vAncho').textContent = field(p, ['Ancho','ancho','Anchura'], '—');
    $('#vLargo').textContent = field(p, ['Largo','largo','Longitud'], '—');
    $('#vTipo').textContent  = field(p, ['Tipodetrabajo','Tipo','TipodeTrabajo','Tipodebache','Tipo de trabajo'], '—');
    $('#vNum').textContent   = field(p, ['NumerodeBache','NumBache','NumeroBache','#Bache','NoBaches'], '—');
    $('#vCad').textContent   = field(p, ['Cadenamiento','cadenamiento','Cadena','Cadenamiento (m)'], '—');
    $('#vCol').textContent   = field(p, ['Colonia','colonia'], '—');
    $('#vCalle').textContent = field(p, ['Calle','calle'], '—');
    $('#vEntre').textContent = field(p, ['Entrecalles','Entre calles','entreCalles','entre calles'], '—');

    // Link a Google Maps
    const [lng,lat] = f.geometry.coordinates;
    $('#mapsLink').href = `https://www.google.com/maps?q=${lat},${lng}`;
  }

  function addFeature(f){
    // Coordinates in GeoJSON are [lng,lat]
    const [lng, lat] = f.geometry.coordinates;
    const m = L.circleMarker([lat,lng], redStyle);
    m.on('click', ()=> fillPanel(f));
    cluster.addLayer(m);
  }

  async function loadKML(url){
    // resolve relative for GH pages
    const res = await fetch(url, {cache:'no-store'});
    const text = await res.text();
    const dom = new DOMParser().parseFromString(text, 'text/xml');
    const gj = toGeoJSON.kml(dom);
    features = (gj.features || []).filter(ft => ft.geometry && ft.geometry.type === 'Point');

    cluster.clearLayers();
    features.forEach(addFeature);
    $('#count').textContent = `Listo: ${features.length}`;

    if(features.length){
      const bbox = L.geoJSON(gj).getBounds();
      map.fitBounds(bbox, {padding:[20,20]});
    }
  }

  // UI events
  $('#btnLoad').addEventListener('click', ()=>{
    const u = $('#kmlInput').value.trim() || 'baches.kml';
    loadKML(u);
  });
  $('#btnRefresh').addEventListener('click', ()=>{
    const u = $('#kmlInput').value.trim() || 'baches.kml';
    loadKML(u + (u.includes('?')?'&':'?') + 't=' + Date.now());
  });

  // Startup
  const startKml = getParam('data', 'baches.kml');
  $('#kmlInput').value = startKml;
  loadKML(startKml);

})();
</script>
</body>
</html>
