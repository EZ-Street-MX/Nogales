<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>EZ Street MX · Mapa de Bacheo</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
:root{
  --bg:#0f1720;
  --panel:#111a24;
  --panel-2:#0b131b;
  --muted:#9fb0c3;
  --accent:#60a5fa;
  --chip:#1f2937;
}
*{box-sizing:border-box}
html,body,#app{height:100%;margin:0;background:var(--bg);color:#e5edf5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
a{color:var(--accent);text-decoration:none}
header{
  position:fixed;left:0;right:0;top:0;height:56px;
  display:flex;align-items:center;gap:12px;padding:8px 12px;
  background:linear-gradient(180deg,rgba(9,14,20,.9),rgba(9,14,20,.65) 60%,transparent);
  z-index:900;
  backdrop-filter:saturate(140%) blur(6px);
}
.brand{font-weight:700;white-space:nowrap}
.input, .btn{
  height:38px;border-radius:10px;border:1px solid #263341;
  background:#0b141f;color:#e5edf5;padding:0 12px;
}
.btn{cursor:pointer}
.btn.primary{background:#1b2430;border-color:#2b3a4b}
.btn.ghost{background:#0b141f;border-color:#253443}
#map{position:absolute;inset:56px 0 0 0}
/* Side panels (desktop) */
.panel{
  position:fixed;top:56px;bottom:0;width:360px;background:linear-gradient(180deg,var(--panel),var(--panel-2));
  overflow:auto;border-right:1px solid #1e2a36;z-index:800;transition:transform .25s ease;
}
.panel.right{right:0;left:auto;border-right:none;border-left:1px solid #1e2a36}
.panel.hidden{transform:translateX(-105%)}
.panel.right.hidden{transform:translateX(105%)}
.panel h3{margin:10px 14px 8px 14px;font-size:13px;letter-spacing:.08em;color:#c2d1e0;text-transform:uppercase}
.listItem{padding:12px 14px;border-bottom:1px solid #1a2530;cursor:pointer}
.listItem:hover{background:#0b141d}
.prop{display:flex;gap:12px;padding:8px 14px;border-top:1px solid #15202b}
.prop label{width:120px;color:var(--muted)}
.prop.hidden{display:none}
.chips{display:flex;gap:8px;margin:8px 14px 10px 14px;flex-wrap:wrap}
.chips .chip{background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px}
.photos{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:12px 14px}
.photos img{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid #1e2a36;background:#0b141b}
.toolbar{display:flex;gap:8px;margin-left:auto}
/* Floating mobile buttons */
.fab{position:fixed;z-index:910;bottom:18px;padding:10px 14px;border-radius:999px;background:#0b141f;border:1px solid #263341;color:#e5edf5}
.fab.left{left:14px} .fab.right{right:14px}
/* Drawers on mobile */
@media (max-width: 900px){
  .panel{width:100%;top:auto;bottom:0;height:62vh;border:none;border-top:1px solid #1e2a36;
    transform:translateY(105%);left:0;right:0}
  .panel.right{height:66vh}
  .panel.open{transform:translateY(0)}
  .panel.hidden{transform:translateY(105%)}
  .panel.right.hidden{transform:translateY(105%)}
  .fab{display:inline-flex}
  header{gap:8px;flex-wrap:wrap;height:auto;padding-bottom:10px}
  #map{top:72px}
}
/* Cluster numbers dark theme tweak */
.marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{
  background: rgba(32, 82, 31, 0.6);
}
.marker-cluster div{
  background:#47a447;border:2px solid #0e2a0e;color:#fff;font-weight:700;
}
/* red dot markers */
.leaflet-interactive.red-dot{stroke:#000;stroke-opacity:.7;stroke-width:2px;fill:#e34a4a;fill-opacity:0.92}
/* panel togglers (desktop) */
.toggler{
  position:fixed;top:64px;z-index:850;background:#0b141f;border:1px solid #253443;color:#e5edf5;
  border-radius:999px;padding:6px 10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.25)
}
.toggler.left{left:12px} .toggler.right{right:12px}
@media (max-width:900px){ .toggler{display:none} }
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">EZ Street MX · Mapa de Bacheo</div>
  <input id="kmlUrl" class="input" style="min-width:280px;flex:1" placeholder="KML (por defecto: baches.kml)">
  <div class="toolbar">
    <button id="btnLoad" class="btn primary">Cargar</button>
    <button id="btnLocal" class="btn ghost">KML local</button>
    <button id="btnRefresh" class="btn ghost">Actualizar</button>
  </div>
</header>

<div id="map"></div>

<!-- Desktop togglers -->
<button class="toggler left" id="toggleList">Lista</button>
<button class="toggler right" id="toggleDetail">Panel</button>

<!-- Left: list -->
<aside id="list" class="panel hidden" style="left:0">
  <h3 style="display:flex;align-items:center;gap:10px">
    <span style="font-weight:600">Baches</span>
    <span id="count" class="small"></span>
  </h3>
  <div style="padding:8px 14px">
    <input id="search" class="input" style="width:100%" placeholder="Buscar bache..." />
    <label style="display:flex;align-items:center;gap:8px;margin-top:8px" class="small">
      <input type="checkbox" id="autoHideList"> Ocultar lista al seleccionar
    </label>
  </div>
  <div id="listBody"></div>
</aside>

<!-- Right: details -->
<aside id="detail" class="panel right hidden">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #1a2530">
    <div style="display:flex;align-items:center;gap:8px">
      <span id="title" style="font-weight:700">—</span>
      <span class="chip" style="background:#1e2937;border-radius:999px;padding:6px 10px" id="layerChip">Baches</span>
    </div>
    <a id="mapsLink" target="_blank" rel="noopener" class="btn ghost">Ver en Maps</a>
  </div>

  <h3>Fotos</h3>
  <div id="photos" class="photos"></div>

  <h3>Medidas</h3>
  <div class="prop" id="pW"><label>Ancho</label><div id="vW">—</div></div>
  <div class="prop" id="pL"><label>Largo</label><div id="vL">—</div></div>
  <div class="prop" id="pT"><label>Tipo</label><div id="vT">—</div></div>
  <div class="prop" id="pN"><label># Bache</label><div id="vN">—</div></div>
  <div class="prop" id="pC"><label>Cadenamiento</label><div id="vC">—</div></div>
  <div class="prop" id="pCol"><label>Colonia</label><div id="vCol">—</div></div>
  <div class="prop" id="pCa"><label>Calle</label><div id="vCa">—</div></div>
  <div class="prop" id="pEC"><label>Entre calles</label><div id="vEC">—</div></div>
  <div style="height:16px"></div>
</aside>

<!-- Mobile floating buttons -->
<button class="fab left" id="fabList" aria-label="Abrir lista" style="display:none">Lista</button>
<button class="fab right" id="fabDetail" aria-label="Abrir panel" style="display:none">Panel</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script>
const isMobile = matchMedia('(max-width: 900px)').matches;
const map = L.map('map', { zoomControl: false, preferCanvas: true, tap:false }).setView([31.3,-110.94], 14);

// basemap (esri world imagery)
L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 22, attribution: '&copy; Esri'
}).addTo(map);

// UI elements
const els = {
  list: document.getElementById('list'),
  detail: document.getElementById('detail'),
  listBody: document.getElementById('listBody'),
  title: document.getElementById('title'),
  mapsLink: document.getElementById('mapsLink'),
  photos: document.getElementById('photos'),
  count: document.getElementById('count'),
  search: document.getElementById('search'),
  autoHideList: document.getElementById('autoHideList'),
  // value nodes
  vW: document.getElementById('vW'), vL: document.getElementById('vL'), vT: document.getElementById('vT'),
  vN: document.getElementById('vN'), vC: document.getElementById('vC'), vCol: document.getElementById('vCol'),
  vCa: document.getElementById('vCa'), vEC: document.getElementById('vEC'),
  pW: document.getElementById('pW'), pL: document.getElementById('pL'), pT: document.getElementById('pT'),
  pN: document.getElementById('pN'), pC: document.getElementById('pC'), pCol: document.getElementById('pCol'),
  pCa: document.getElementById('pCa'), pEC: document.getElementById('pEC'),
  // buttons
  kmlUrl: document.getElementById('kmlUrl'), btnLoad: document.getElementById('btnLoad'),
  btnLocal: document.getElementById('btnLocal'), btnRefresh: document.getElementById('btnRefresh'),
  toggleList: document.getElementById('toggleList'), toggleDetail: document.getElementById('toggleDetail'),
  fabList: document.getElementById('fabList'), fabDetail: document.getElementById('fabDetail')
};

// show mobile fabs only on mobile
if(isMobile){ els.fabList.style.display='inline-flex'; els.fabDetail.style.display='inline-flex'; }

function openList(){ els.list.classList.remove('hidden'); els.list.classList.add('open'); }
function closeList(){ els.list.classList.add('hidden'); els.list.classList.remove('open'); }
function openDetail(){ els.detail.classList.remove('hidden'); els.detail.classList.add('open'); }
function closeDetail(){ els.detail.classList.add('hidden'); els.detail.classList.remove('open'); }

els.toggleList.addEventListener('click', ()=> els.list.classList.toggle('hidden'));
els.toggleDetail.addEventListener('click', ()=> els.detail.classList.toggle('hidden'));
els.fabList.addEventListener('click', ()=> (els.list.classList.contains('open') ? closeList() : openList()));
els.fabDetail.addEventListener('click', ()=> (els.detail.classList.contains('open') ? closeDetail() : openDetail()));
els.btnRefresh.addEventListener('click', ()=> location.reload());

// KML LOADING -------------------------------------------------
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
const defaultKml = 'baches.kml';
const initialUrl = getParam('data') || defaultKml;
els.kmlUrl.value = initialUrl;

let cluster = L.markerClusterGroup({ spiderLegPolylineOptions:{opacity:.6, weight:1.5} }).addTo(map);
let allMarkers = [];

async function loadKmlFrom(url){
  try{
    // fetch as text, parse as XML
    const res = await fetch(url, {cache:'no-store'});
    const txt = await res.text();
    const xml = new DOMParser().parseFromString(txt, 'text/xml');
    const gj = toGeoJSON.kml(xml);
    cluster.clearLayers(); allMarkers = [];
    els.listBody.innerHTML = "";
    let count = 0;
    const features = gj.features || [];
    features.forEach((f, idx)=>{
      if(!f.geometry) return;
      const c = f.geometry.coordinates;
      const latlng = [c[1], c[0]];
      const props = (f.properties||{});
      // Extract fields (robust to different names)
      function pick(...names){
        for(const n of names){ if(props[n]!=null && String(props[n]).trim()!=="") return String(props[n]).trim(); }
        return "";
      }
      const ancho = pick('Ancho','ancho','width','ANCHO');
      const largo = pick('Largo','largo','length','LARGO');
      const tipo = pick('TipodeTrabajo','Tipo','tipo');
      const numero = pick('NumerodeBache','# Bache','NumBache','NumeroBache');
      const caden = pick('Cadenamiento','cadenamiento','Cadena','Cadenamientoo');
      const colonia = pick('Colonia');
      const calle = pick('Calle');
      const entre = pick('Entrecalles','EntreCalles','entre calles');

      const fotoA = pick('Fotoantes','FotoAntes','Fotoantes_','fotoantes','FotoantesLink');
      const fotoR = pick('Fotoreferencia','FotoReferencia','fotoRef');
      const fotoF = pick('FotoFinal','fotofinal','Foto_final');

      const name = pick('name') || (`kml_${idx+1}`);
      const item = document.createElement('div');
      item.className='listItem';
      item.innerHTML = `<div style="font-weight:600">${name}</div>
                        <div class="small">${latlng[0].toFixed(6)}, ${latlng[1].toFixed(6)} ${calle?(' · '+calle):''}</div>`;
      item.addEventListener('click', ()=>{
        map.flyTo(latlng, 20, {duration:.7});
        selectMarker(m);
        if(isMobile && els.autoHideList.checked) closeList();
      });
      els.listBody.appendChild(item);

      // Red dot marker
      const m = L.circleMarker(latlng, {
        radius: 6, className:'red-dot', weight:2, color:'#000', fillColor:'#e34a4a', fillOpacity:0.92
      });

      const touchSelect = (ev)=>{ selectMarker(m); };
      m.on('click', touchSelect);
      m.on('touchend', touchSelect);
      m.featureProps = {name, latlng, ancho, largo, tipo, numero, caden, colonia, calle, entre, fotoA, fotoR, fotoF};
      cluster.addLayer(m);
      allMarkers.push(m);
      count++;
    });
    els.count.textContent = `(${count})`;
    if(count>0){
      map.fitBounds(cluster.getBounds().pad(0.2));
    }
  }catch(e){
    console.error(e);
    alert("No se pudo leer el KML. Revisa el enlace o el archivo.");
  }
}

function cleanUrl(u){
  // try to make sure weird characters are encoded; allow already-encoded URLs
  try{
    // if looks like already encoded, just return
    if(/%[0-9A-Fa-f]{2}/.test(u)) return u;
    return encodeURI(u);
  }catch{return u}
}

function imgTag(u){
  if(!u) return "";
  const url = cleanUrl(u);
  return `<img referrerpolicy="no-referrer" loading="lazy" src="${url}" alt="">`;
}

function setRow(rowEl, value, targetEl){
  if(value && String(value).trim()!==""){
    rowEl.classList.remove('hidden');
    targetEl.textContent = value;
  }else{
    rowEl.classList.add('hidden');
    targetEl.textContent = "";
  }
}

function selectMarker(m){
  const p = m.featureProps;
  // fill panel
  els.title.textContent = p.name;
  els.mapsLink.href = `https://www.google.com/maps?q=${p.latlng[0]},${p.latlng[1]}`;
  // photos
  els.photos.innerHTML = [imgTag(p.fotoA), imgTag(p.fotoR), imgTag(p.fotoF)].filter(Boolean).join("");
  setRow(els.pW, p.ancho, els.vW);
  setRow(els.pL, p.largo, els.vL);
  setRow(els.pT, p.tipo, els.vT);
  setRow(els.pN, p.numero, els.vN);
  setRow(els.pC, p.caden, els.vC);
  setRow(els.pCol, p.colonia, els.vCol);
  setRow(els.pCa, p.calle, els.vCa);
  setRow(els.pEC, p.entre, els.vEC);
  if(isMobile) openDetail(); else els.detail.classList.remove('hidden');
}

els.btnLoad.addEventListener('click', ()=>{
  const u = els.kmlUrl.value.trim() || defaultKml;
  const base = new URL(location.href);
  base.searchParams.set('data', u);
  history.replaceState({}, "", base);
  loadKmlFrom(u);
});
els.kmlUrl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') els.btnLoad.click(); });

els.btnLocal.addEventListener('click', ()=>{
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='.kml,.kmz';
  inp.onchange = async () => {
    const file = inp.files[0]; if(!file) return;
    const isKMZ = file.name.toLowerCase().endsWith('.kmz');
    if(isKMZ){
      alert("KMZ no soportado en este cargador rápido. Exporta a KML o usa el admin.");
      return;
    }
    const text = await file.text();
    const xml = new DOMParser().parseFromString(text, 'text/xml');
    const gj = toGeoJSON.kml(xml);
    const dataurl = URL.createObjectURL(new Blob([JSON.stringify(gj)],{type:'application/json'}));
    // load from memory
    cluster.clearLayers(); allMarkers = [];
    els.listBody.innerHTML="";
    gj.features.forEach((f, idx)=>{
      if(!f.geometry) return;
      const c = f.geometry.coordinates;
      const latlng = [c[1], c[0]];
      const p = f.properties || {};
      const name = p.name || `kml_${idx+1}`;
      const m = L.circleMarker(latlng, {radius:6,className:'red-dot',weight:2,color:'#000',fillColor:'#e34a4a',fillOpacity:.92});
      m.featureProps = {name, latlng};
      m.on('click', ()=>selectMarker(m));
      m.on('touchend', ()=>selectMarker(m));
      cluster.addLayer(m);
      const item = document.createElement('div');
      item.className='listItem';
      item.textContent = name;
      item.addEventListener('click', ()=>{ map.flyTo(latlng, 19); selectMarker(m); });
      els.listBody.appendChild(item);
    });
    if(cluster.getLayers().length) map.fitBounds(cluster.getBounds().pad(.2));
  };
  inp.click();
});

// live search
els.search.addEventListener('input', ()=>{
  const q = els.search.value.trim().toLowerCase();
  [...els.listBody.children].forEach(el => {
    const ok = el.textContent.toLowerCase().includes(q);
    el.style.display = ok ? '' : 'none';
  });
});

// initial load
loadKmlFrom(initialUrl);

// Close mobile drawers by tapping map
if(isMobile){
  map.on('click', ()=>{
    // do not close if clicking on a marker; delay to allow marker select to run
    setTimeout(()=>{
      closeList(); // keep detail if just selected
    }, 120);
  });
}
</script>
</body>
</html>
