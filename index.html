<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>EZ Street MX · Mapa de Bacheo</title>

<!-- Leaflet + MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --text:#e5e7eb; --muted:#9fb3c8; --border:#1e2a3d;
  --chip:#162234; --dot:#ef4444; --accent:#15a8ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
#app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr}

/* Topbar */
.topbar{display:flex;gap:.5rem;align-items:center;padding:.55rem .75rem;background:#0b1220;border-bottom:1px solid var(--border)}
.brand{font-weight:700;letter-spacing:.2px}
.input{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:.45rem .6rem;border-radius:.55rem;min-width:260px}
.btn{background:#152335;color:var(--text);border:1px solid var(--border);padding:.45rem .7rem;border-radius:.55rem;cursor:pointer}
.btn:hover{filter:brightness(1.08)}
.spacer{flex:1}

/* Map + Panel */
.main{position:relative}
#map{position:absolute;inset:0}
.leaflet-control-zoom{display:none} /* sin +/− */
.red-dot{width:10px;height:10px;border-radius:999px;background:var(--dot);border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.35)}

/* Panel (derecha en desktop, sheet en móvil) */
.panel{position:absolute;right:0;top:0;bottom:0;width:min(420px,36vw);background:var(--panel);border-left:1px solid var(--border);
       transform:translateX(100%);transition:transform .25s;display:flex;flex-direction:column;z-index:800}
.panel.open{transform:translateX(0)}
.panel-head{display:flex;align-items:center;gap:.5rem;padding:.7rem .8rem;border-bottom:1px solid var(--border)}
.panel-title{font-weight:700}
.panel-close{margin-left:auto}
.panel-body{padding:.8rem;overflow:auto}
.kv{margin:.4rem 0}
.k{color:var(--muted);font-size:.85rem;margin-bottom:.15rem}
.v{font-weight:600}
.photos{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-top:.35rem}
.photos a{display:block;border-radius:.5rem;overflow:hidden;border:1px solid var(--border)}
.photos img{width:100%;height:86px;object-fit:cover;display:block}

@media (max-width:900px){
  .panel{left:0;right:0;top:auto;height:62vh;width:auto;border-left:0;border-top:1px solid var(--border);border-radius:14px 14px 0 0;
         transform:translateY(100%)}
  .panel.open{transform:translateY(0)}
}
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="brand">EZ Street MX · Mapa de Bacheo</div>
    <div class="spacer"></div>
    <input id="url" class="input" placeholder="URL del KML (por defecto: baches.kml)">
    <button id="btnUrl" class="btn">Cargar URL</button>
    <input id="file" type="file" accept=".kml,.kmz" hidden>
    <button id="btnLocal" class="btn">KML local</button>
    <button id="btnPanel" class="btn">Panel</button>
  </div>

  <div class="main">
    <div id="map"></div>
    <aside id="panel" class="panel">
      <div class="panel-head">
        <div class="panel-title">Baches</div>
        <button id="closePanel" class="btn panel-close">Cerrar</button>
      </div>
      <div class="panel-body" id="panelBody">
        Selecciona un bache del mapa.
      </div>
    </aside>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
// -------- Config --------
const DEFAULT_KML = new URLSearchParams(location.search).get('data') || 'baches.kml';
const MAX_ZOOM = 22;

// -------- UI refs --------
const $ = s => document.querySelector(s);
const panel = $('#panel'), panelBody = $('#panelBody');

$('#btnPanel').onclick  = () => panel.classList.toggle('open');
$('#closePanel').onclick= () => panel.classList.remove('open');
$('#btnLocal').onclick  = () => $('#file').click();
$('#file').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  if(/\.kmz$/i.test(f.name)){ alert('KMZ local no soportado aquí. Exporta KML.'); return; }
  const txt = await f.text(); const feats = parseKml(txt); draw(feats, true);
});
$('#btnUrl').onclick = async ()=>{
  const u = $('#url').value.trim() || DEFAULT_KML;
  const txt = await fetchText(u);
  const feats = parseKml(txt);
  draw(feats, true);
};

// -------- Map --------
const map = L.map('map', {zoomControl:false, minZoom: 3, maxZoom: MAX_ZOOM}).setView([31.305,-110.94], 14);
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxNativeZoom: 19, maxZoom: MAX_ZOOM, attribution:'&copy; Esri, Maxar'
}).addTo(map);
const cluster = L.markerClusterGroup({showCoverageOnHover:false, disableClusteringAtZoom:19, maxClusterRadius:50}).addTo(map);
const redIcon = L.divIcon({className:'red-dot', iconSize:[12,12], iconAnchor:[6,6]});

// -------- KML utils (ligero, robusto con Trimble) --------
async function fetchText(url){
  const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status); return await res.text();
}
function parseKml(text){
  const out=[]; let id=0;
  const placemarks = text.match(/<Placemark[\s\S]*?<\/Placemark>/gi) || [];
  for(const b of placemarks){
    // props de SimpleData
    const props={};
    b.replace(/<SimpleData[^>]*name="([^"]+)"[^>]*>([\s\S]*?)<\/SimpleData>/gi,(m,n,v)=>{props[n]=v.replace(/<[^>]*>/g,'').trim();});
    // tabla en description
    const d=b.match(/<description>([\s\S]*?)<\/description>/i);
    if(d){
      const html = d[1].replace(/<!\[CDATA\[|\]\]>/g,'');
      const kv=[...html.matchAll(/<tr[^>]*>\s*<td[^>]*>([\s\S]*?)<\/td>\s*<td[^>]*>([\s\S]*?)<\/td>\s*<\/tr>/gi)];
      for(const m of kv){ const k=m[1].replace(/<[^>]*>/g,'').trim(); const v=m[2].replace(/<[^>]*>/g,'').trim(); if(k) props[k]=v; }
    }
    // nombre
    const nm=b.match(/<name>([\s\S]*?)<\/name>/i); if(nm) props.name=nm[1].trim();
    // coords (solo Point)
    const pt=b.match(/<Point>[\s\S]*?<coordinates>([^<]+)<\/coordinates>[\s\S]*?<\/Point>/i);
    if(!pt) continue; const a=pt[1].trim().split(',').map(Number); if(a.length<2) continue;
    out.push({id:++id, lat:a[1], lon:a[0], p:props});
  }
  return out;
}

// -------- Render --------
function pick(p, keys){ const K=Object.keys(p); const norm=s=>s.toLowerCase().replace(/\s|_/g,''); const want=keys.map(norm); 
  for(const k of K){ if(want.includes(norm(k))) return p[k]; } return ''; }

function renderPanel(p){
  // SOLO estos campos (en este orden):
  const TipoDeTrabajo = pick(p, ['TipodeTrabajo','Tipo de trabajo','Tipo']);
  const NumeroBache   = pick(p, ['NumerodeBache','Número de Bache','NumBache']);
  const FotoAntes     = pick(p, ['Fotoantes','Foto Antes']);
  const Ancho         = pick(p, ['Ancho']);
  const Largo         = pick(p, ['Largo']);
  const FotoRef       = pick(p, ['FotoReferencia','Foto Referencia']);
  const FotoFinal     = pick(p, ['FotoFinal','Foto Final']);
  const Cadenamiento  = pick(p, ['Cadenamiento']);
  const Colonia       = pick(p, ['Colonia']);
  const Calle         = pick(p, ['Calle']);
  const EntreCalles   = pick(p, ['Entrecalles','Entre calles','EntreCalles']);

  const photo = (u)=> u ? `<a href="${u}" target="_blank" rel="noopener"><img loading="lazy" src="${u}"></a>` : '';

  panelBody.innerHTML = `
    <div class="kv"><div class="k">Tipo de trabajo</div><div class="v">${TipoDeTrabajo||'-'}</div></div>
    <div class="kv"><div class="k">Número de Bache</div><div class="v">${NumeroBache||'-'}</div></div>

    <div class="kv"><div class="k">Foto antes</div><div class="photos">${photo(FotoAntes)}</div></div>

    <div class="kv" style="display:flex;gap:1rem">
      <div><div class="k">Ancho</div><div class="v">${Ancho||'-'}</div></div>
      <div><div class="k">Largo</div><div class="v">${Largo||'-'}</div></div>
    </div>

    <div class="kv"><div class="k">Foto Referencia</div><div class="photos">${photo(FotoRef)}</div></div>
    <div class="kv"><div class="k">Foto Final</div><div class="photos">${photo(FotoFinal)}</div></div>

    <div class="kv"><div class="k">Cadenamiento</div><div class="v">${Cadenamiento||'-'}</div></div>
    <div class="kv"><div class="k">Colonia</div><div class="v">${Colonia||'-'}</div></div>
    <div class="kv"><div class="k">Calle</div><div class="v">${Calle||'-'}</div></div>
    <div class="kv"><div class="k">Entre calles</div><div class="v">${EntreCalles||'-'}</div></div>
  `;
  panel.classList.add('open');
}

function draw(feats, fit){
  cluster.clearLayers();
  const ms=[];
  feats.forEach(f=>{
    const m=L.marker([f.lat,f.lon],{icon:redIcon,title:f.p?.name||('kml_'+f.id)});
    m.on('click', ()=> renderPanel(f.p||{}));
    cluster.addLayer(m); ms.push(m);
  });
  if(fit && ms.length){
    const g=L.featureGroup(ms); const b=g.getBounds(); if(b && b.isValid()) map.fitBounds(b.pad(.2));
  }
}

// -------- Start --------
(async () => {
  try{
    $('#url').value = DEFAULT_KML;
    const txt = await fetchText(DEFAULT_KML);
    const feats = parseKml(txt);
    draw(feats, true);
  }catch(e){
    console.error(e);
    panelBody.textContent = 'No se pudo cargar el KML.';
  }
  // cerrar panel tocando fuera (móvil)
  map.on('click', ()=> panel.classList.remove('open'));
})();
</script>
</body>
</html>
