<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>EZ Street MX · Mapa de Bacheo</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  :root{
    --bg:#0f1720;
    --panel:#121b26;
    --card:#0c141d;
    --txt:#e6eef8;
    --muted:#9fb2c7;
    --accent:#09f;
    --pill:#1f2a36;
  }
  html,body,#map{height:100%;margin:0;background:var(--bg);color:var(--txt);}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:#6cc0ff}
  /* Header */
  .topbar{
    position:fixed;left:0;top:0;right:0;height:52px;display:flex;gap:.5rem;
    align-items:center;padding:.5rem .75rem;background:rgba(10,16,23,.85);backdrop-filter: blur(6px);
    z-index:1000;border-bottom:1px solid rgba(255,255,255,.08);
  }
  .title{font-weight:700;white-space:nowrap;margin-right:.5rem}
  .spacer{flex:1}
  .input{background:var(--pill);border:1px solid rgba(255,255,255,.08);color:var(--txt);
         padding:.4rem .55rem;border-radius:.6rem;min-width:280px;max-width:46vw}
  .btn{background:#1b2734;border:1px solid rgba(255,255,255,.1);color:var(--txt);
       padding:.4rem .7rem;border-radius:.6rem;cursor:pointer}
  .btn:hover{background:#223242}
  .btn.secondary{background:#14202d}
  .hidden{display:none !important}

  #map{position:absolute;left:0;right:0;top:52px;bottom:0}
  /* hide leaflet zoom buttons */
  .leaflet-control-zoom{display:none}

  /* Side / bottom panel */
  #info{
    position:fixed;right:0;top:52px;bottom:0;width:360px;max-width:40vw;background:var(--panel);
    border-left:1px solid rgba(255,255,255,.08);z-index:950;display:none;overflow:auto
  }
  #info.open{display:block}
  #info .wrap{padding:14px}
  .h{font-weight:700;margin:2px 0 10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:6px 0}
  .field{background:var(--card);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.06)}
  .label{font-size:12px;color:var(--muted);margin-bottom:2px}
  .value{font-weight:600;word-break:break-word}
  .photos{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .photos a{display:block;background:#000;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
  .photos img{width:100%;height:86px;object-fit:cover;display:block}
  .chip{display:inline-flex;gap:6px;align-items:center;background:var(--pill);padding:.3rem .55rem;border-radius:999px;border:1px solid rgba(255,255,255,.06);color:var(--muted);font-size:12px}
  .toolbar{display:flex;gap:.5rem;align-items:center;margin:0 0 .5rem}
  .close{margin-left:auto}
  .gmaps{margin-top:8px}

  /* Mobile bottom sheet */
  @media (max-width: 900px){
    #info{left:0;right:0;bottom:0;top:auto;width:auto;max-width:none;height:55vh;border-left:0;border-top:1px solid rgba(255,255,255,.08);border-radius:16px 16px 0 0}
    #map{top:52px}
  }

  /* Marker red dot */
  .dot{
    width:10px;height:10px;background:#e63b3b;border:2px solid #fff;border-radius:50%;
    box-shadow:0 0 0 2px rgba(230,59,59,.5);
  }
  /* Cluster color */
  .marker-cluster-small{background:rgba(46,204,113,.35)}
  .marker-cluster-small div{background:#2ecc71;color:#0d2a1b}
  .marker-cluster-medium{background:rgba(241,196,15,.35)}
  .marker-cluster-medium div{background:#f1c40f;color:#2d2402}
  .marker-cluster-large{background:rgba(230,126,34,.35)}
  .marker-cluster-large div{background:#e67e22;color:#2d1402}
</style>
</head>
<body>
  <div class="topbar">
    <div class="title">EZ Street MX · Mapa de Bacheo</div>
    <input id="url" class="input" placeholder="URL del KML (por defecto: baches.kml)" />
    <button class="btn" id="btnUrl">Cargar URL</button>
    <input type="file" id="file" accept=".kml,.kmz" class="hidden">
    <button class="btn secondary" id="btnLocal">KML local</button>
    <div class="spacer"></div>
    <button class="btn" id="btnToggle">Panel</button>
  </div>
  <div id="map"></div>

  <aside id="info">
    <div class="wrap">
      <div class="toolbar">
        <span class="chip" id="chipName">Bache</span>
        <span class="chip" id="chipCoords">—</span>
        <button class="btn close" id="btnClose">Cerrar</button>
      </div>
      <div id="content"></div>
    </div>
  </aside>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  const DEFAULT_KML = params.get('data') || 'baches.kml';
  const bust = params.get('t') || (Date.now().toString().slice(0,10));
  const $ = sel => document.querySelector(sel);
  const content = $('#content');
  const info = $('#info');

  // Map
  const map = L.map('map', {zoomControl:false, minZoom: 3, maxZoom: 22});
  const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'&copy; Esri &mdash; World Imagery', maxNativeZoom: 19, maxZoom:22
  }).addTo(map);

  // Start center (Nogales MX approx)
  map.setView([31.305, -110.939], 14);

  // Cluster layer
  const cluster = L.markerClusterGroup({
    spiderfyOnMaxZoom:true,
    showCoverageOnHover:false,
    disableClusteringAtZoom: 19,
    maxClusterRadius: 40
  }).addTo(map);

  let currentGeo = null;

  // UI events
  $('#btnLocal').onclick = ()=> $('#file').click();
  $('#btnUrl').onclick = async ()=> {
    const u = $('#url').value.trim();
    if(!u) return alert('Pega una URL a un KML');
    await loadKML(u);
  };
  $('#btnToggle').onclick = ()=> info.classList.toggle('open');
  $('#btnClose').onclick  = ()=> info.classList.remove('open');
  $('#file').addEventListener('change', async (ev)=>{
    const file = ev.target.files[0];
    if(!file) return;
    const text = await file.text();
    await parseKmlText(text);
  });

  // Helpers
  function getProp(props, list){
    for(const k of list){
      const key = Object.keys(props).find(p => p.toLowerCase() === k.toLowerCase());
      if(key) return props[key];
    }
    return "";
  }
  function redDot(){
    return L.divIcon({className:'dot', iconSize:[10,10]});
  }
  function formatVal(v){
    if(v==null) return '—';
    if(typeof v === 'number'){
      return Number.isFinite(v) ? (Math.round(v*100)/100).toString() : '—';
    }
    return (String(v).trim() || '—');
  }
  function toGMapsLink(lat,lng){
    return `https://www.google.com/maps?q=${lat},${lng}`;
  }

  // Panel rendering
  function renderPanel(props, latlng){
    const pairs = [
      ['Tipo',            getProp(props, ['Tipodetrabajo','Tipo','TipoTrab'])],
      ['# Bache',         getProp(props, ['NumerodeBache','NumBache','Bache','NumeroBache'])],
      ['Ancho (m)',       getProp(props, ['Ancho'])],
      ['Largo (m)',       getProp(props, ['Largo'])],
      ['Cadenamiento',    getProp(props, ['Cadenamiento','Cadenamientoxto','Cadena'])],
      ['Colonia',         getProp(props, ['Colonia'])],
      ['Calle',           getProp(props, ['Calle'])],
      ['Entre calles',    getProp(props, ['Entrecalles','EntreCalles'])]
    ];

    const photos = [
      ['Antes',      getProp(props, ['Fotoantes','FotoAntes'])],
      ['Referencia', getProp(props, ['FotoReferencia','FotoRef'])],
      ['Final',      getProp(props, ['FotoFinal','FotoDespues'])]
    ].filter(([_,url]) => url && String(url).startsWith('http'));

    const name = getProp(props,['name','Nombre','title']) || 'Bache';
    $('#chipName').textContent = name;
    $('#chipCoords').textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;

    let html = '';
    // Basic fields
    html += '<div class="row">';
    for(const [label, val] of pairs){
      html += `<div class="field"><div class="label">${label}</div><div class="value">${formatVal(val)}</div></div>`;
    }
    html += '</div>';

    // Photos
    if(photos.length){
      html += `<div class="h">Fotos</div><div class="photos">`;
      for(const [label,url] of photos){
        html += `<a href="${url}" target="_blank" title="${label}"><img loading="lazy" src="${url}"></a>`;
      }
      html += `</div>`;
    }

    // Maps link
    html += `<div class="gmaps"><a class="btn" href="${toGMapsLink(latlng.lat,latlng.lng)}" target="_blank">Ver en Google Maps</a></div>`;

    content.innerHTML = html;
    info.classList.add('open');
  }

  // Loaders
  async function loadKML(url){
    try{
      const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + bust);
      if(!res.ok) throw new Error('No se pudo descargar el KML');
      const text = await res.text();
      await parseKmlText(text);
    }catch(e){
      console.error(e);
      alert('No se pudo cargar el KML: ' + e.message);
    }
  }
  async function parseKmlText(text){
    try{
      const xml = new DOMParser().parseFromString(text, 'text/xml');
      const gj = togeojson.kml(xml); // GeoJSON FeatureCollection
      currentGeo = gj;
      drawGeo(gj);
    }catch(e){
      console.error(e);
      alert('Error al convertir KML: ' + e.message);
    }
  }

  function drawGeo(gj){
    cluster.clearLayers();
    if(!gj || !gj.features) return;

    const markers = [];
    gj.features.forEach((f,i)=>{
      if(!f.geometry) return;
      let latlng = null;
      if(f.geometry.type === 'Point'){
        const [lng,lat] = f.geometry.coordinates;
        latlng = L.latLng(lat,lng);
      }else{
        // fallback: take first coord of first ring
        const c = f.geometry.coordinates;
        const first = (Array.isArray(c) && Array.isArray(c[0])) ? c[0] : c;
        if(Array.isArray(first) && first.length>=2){
          const [lng,lat] = Array.isArray(first[0])? first[0] : first;
          latlng = L.latLng(lat,lng);
        }
      }
      if(!latlng) return;

      const m = L.marker(latlng,{icon:redDot(), title: f.properties?.name || ('kml_' + (i+1))});
      m.on('click', ()=> renderPanel(f.properties||{}, latlng));
      cluster.addLayer(m);
      markers.push(m);
    });

    if(markers.length){
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.15), {maxZoom:18});
    }
  }

  // Initial
  $('#url').value = DEFAULT_KML;
  loadKML(DEFAULT_KML);
})(); 
</script>
</body>
</html>
