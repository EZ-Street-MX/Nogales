<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EZ Street MX · Mapa de Bacheo</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--sub:#94a3b8;--border:#223046;--accent:#22c55e;--red:#ef4444}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
  #layout{position:fixed;inset:0;display:grid;grid-template-columns:1fr 420px;grid-template-rows:auto 1fr}
  header{grid-column:1/3;display:flex;gap:8px;align-items:center;padding:8px 10px;background:#0b1220;border-bottom:1px solid var(--border)}
  .title{font-weight:700;color:#c7d2fe;margin-right:auto}
  .btn{background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#04150a}
  .inp{background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;min-width:260px}
  #map{width:100%;height:100%}
  #right{border-left:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;overflow:auto}
  .panel{padding:12px}
  .section{margin-bottom:16px}
  .section h3{margin:0 0 10px 0;font-size:15px;letter-spacing:.02em;color:#cbd5e1}
  .photos{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .ph{background:#0b1220;border:1px solid var(--border);border-radius:10px;height:120px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .ph img{width:100%;height:100%;object-fit:cover;display:block;border-radius:10px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:6px;padding:10px;background:#0b1220;border:1px solid var(--border);border-radius:12px}
  .kv div{padding:2px 0}
  .lbl{color:var(--sub)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:#0b1220;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .maptools{display:flex;gap:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111827;color:#fff;border:1px solid #374151;border-radius:10px;padding:10px 14px;z-index:6000;box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:90vw}
  .loader{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(11,18,32,.55);backdrop-filter:blur(2px);z-index:3500}
  .spinner{width:36px;height:36px;border:3px solid #94a3b8;border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media (max-width: 860px){
    #layout{grid-template-columns:1fr}
    #right{grid-column:1/2;max-height:46vh}
  }
</style>
</head>
<body>
<div id="layout">
  <header>
    <div class="title">EZ Street MX · Mapa de Bacheo</div>
    <input id="inUrl" class="inp" placeholder="URL del KML (por defecto: baches.kml)">
    <button id="btnUrl" class="btn primary">Cargar URL</button>
    <label class="btn">KML local<input id="file" type="file" accept=".kml,.kmz" style="display:none"></label>
    <button id="btnReload" class="btn">Actualizar</button>
  </header>
  <div id="map" style="position:relative"><div id="loader" class="loader"><div class="spinner"></div></div></div>
  <aside id="right">
    <div class="panel" id="panel">
      <div class="row" style="justify-content:space-between">
        <div class="row"><span id="pm_name" class="pill">Baches</span></div>
        <div class="maptools">
          <a id="mapsLink" class="btn" target="_blank" rel="noopener">Ver en Maps</a>
        </div>
      </div>
      <div class="section">
        <h3>FOTOS</h3>
        <div class="photos">
          <a class="ph" id="ph_antes" target="_blank" rel="noopener"></a>
          <a class="ph" id="ph_ref"   target="_blank" rel="noopener"></a>
          <a class="ph" id="ph_final" target="_blank" rel="noopener"></a>
        </div>
      </div>
      <div class="section">
        <h3>MEDIDAS</h3>
        <div class="kv" id="kv"></div>
      </div>
    </div>
  </aside>
</div>
<div id="toast" class="toast" style="display:none"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ===== util =====
const LS = localStorage;
const toastBox=document.getElementById('toast');
function toast(msg,ms=3200){toastBox.textContent=msg;toastBox.style.display='block';setTimeout(()=>toastBox.style.display='none',ms);}
const loader=document.getElementById('loader');
function showLoader(v){loader.style.display=v?'flex':'none';}

// ===== mapa base (Satélite por defecto; Calles fallback) =====
const map=L.map('map',{preferCanvas:true,zoomControl:false}).setView([31.303,-110.94],13);
const esri=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxNativeZoom:19,maxZoom:22,attribution:'&copy; Esri'}).addTo(map);
const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:22,attribution:'&copy; OSM',subdomains:'abc'});
esri.on('tileerror',()=>{ if(!map.hasLayer(osm)){ osm.addTo(map); toast('Satélite no disponible; usando Calles (OSM).',5000);} });

// ===== estilos =====
const dotStyle={radius:4, color:'#000', weight:0, fillColor:'var(--red)'.replace('var(--red)', getComputedStyle(document.documentElement).getPropertyValue('--red')), fillOpacity:0.95};
const cluster=L.markerClusterGroup({showCoverageOnHover:false,disableClusteringAtZoom:19,maxClusterRadius:38});
const lines=L.featureGroup(), polys=L.featureGroup();
cluster.addTo(map); lines.addTo(map); polys.addTo(map);

// ===== KML parsing =====
async function kmzToText(file){
  if(typeof JSZip==='undefined'){
    await new Promise(r=>{const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';s.onload=r;document.body.appendChild(s);});
  }
  const zip=await JSZip.loadAsync(file);
  const entry=Object.keys(zip.files).find(n=>/\.kml$/i.test(n));
  if(!entry) throw new Error('KMZ sin .kml interno');
  return await zip.files[entry].async('string');
}
function parseKml(txt){
  const feats=[]; let seq=0;
  const placemarks=txt.match(/<Placemark[\\s\\S]*?<\\/Placemark>/gi)||[];
  for(const block of placemarks){
    const p={};
    block.replace(/<SimpleData[^>]*name="([^"]+)"[^>]*>([\\s\\S]*?)<\\/SimpleData>/gi,(a,n,v)=>{p[n]=v.replace(/<[^>]*>/g,'').trim();});
    const desc=block.match(/<description>([\\s\\S]*?)<\\/description>/i);
    if(desc){
      const html=desc[1].replace(/<!\\[CDATA\\[|\\]\\]>/g,'');
      const kv=[...html.matchAll(/<tr[^>]*>\\s*<td[^>]*>([\\s\\S]*?)<\\/td>\\s*<td[^>]*>([\\s\\S]*?)<\\/td>\\s*<\\/tr>/gi)];
      for(const m of kv){const k=m[1].replace(/<[^>]*>/g,'').trim();const v=m[2].replace(/<[^>]*>/g,'').trim();if(k) p[k]=v;}
      // busca URLs de fotos dentro de la descripción
      const urls=html.match(/https?:\\/\\/[^"'<>()\\s]+/g)||[]; if(urls.length){ p.__urls=(p.__urls||[]).concat(urls);}
    }
    const nm=block.match(/<name>([\\s\\S]*?)<\\/name>/i); if(nm) p.name=nm[1].trim();

    // Point
    const pts=block.match(/<Point>[\\s\\S]*?<\\/Point>/gi)||[];
    for(const pt of pts){
      const m=pt.match(/<coordinates>([^<]+)<\\/coordinates>/i);
      if(m){const a=m[1].trim().split(',').map(Number); if(a.length>=2&&isFinite(a[0])&&isFinite(a[1])) feats.push({id:++seq,t:'Point',c:[a[1],a[0]],p});}
    }
    // LineString
    const lns=block.match(/<LineString>[\\s\\S]*?<\\/LineString>/gi)||[];
    for(const ln of lns){
      const m=ln.match(/<coordinates>([^<]+)<\\/coordinates>/i);
      if(m){
        const arr=m[1].trim().split(/\\s+/).map(s=>s.split(',').map(Number)).filter(a=>a.length>=2&&isFinite(a[0])&&isFinite(a[1])).map(a=>[a[1],a[0]]);
        if(arr.length>1) feats.push({id:++seq,t:'Line',c:arr,p});
      }
    }
    // Polygon
    const pgs=block.match(/<Polygon>[\\s\\S]*?<\\/Polygon>/gi)||[];
    for(const pg of pgs){
      const m=pg.match(/<outerBoundaryIs>[\\s\\S]*?<LinearRing>[\\s\\S]*?<coordinates>([^<]+)<\\/coordinates>[\\s\\S]*?<\\/LinearRing>[\\s\\S]*?<\\/outerBoundaryIs>/i);
      if(m){
        const arr=m[1].trim().split(/\\s+/).map(s=>s.split(',').map(Number)).filter(a=>a.length>=2&&isFinite(a[0])&&isFinite(a[1])).map(a=>[a[1],a[0]]);
        if(arr.length>2) feats.push({id:++seq,t:'Poly',c:[arr],p});
      }
    }
  }
  // centers
  for(const f of feats){
    try{
      if(f.t==='Point') f.center=f.c;
      else{ const lyr=f.t==='Line'?L.polyline(f.c):L.polygon(f.c); const b=lyr.getBounds(); if(b&&b.isValid()) f.center=b.getCenter(); }
    }catch(_){}
  }
  return feats;
}

// ===== panel =====
function norm(p, keys){ for(const k of keys){ if(p[k]) return p[k]; } return '';}
function firstUrl(list){ for(const u of list){ if(/\\.(jpg|jpeg|png|webp)(\\?|$)/i.test(u)||/forms\\/images\\//.test(u)) return u; } return '';}
function photoSet(anchor, url){ anchor.innerHTML=''; if(!url) return; const img=new Image(); img.loading='lazy'; img.referrerPolicy='no-referrer'; img.crossOrigin='anonymous'; img.src=url; anchor.href=url; anchor.appendChild(img);}
function showPanel(f){
  const p=f.p||{}; document.getElementById('pm_name').textContent=p.name||('kml_'+f.id);
  const ancho=norm(p,['Ancho','ancho']); const largo=norm(p,['Largo','largo']); const tipo=norm(p,['TipodeTrabajo','Tipo','tipo']);
  const nb=norm(p,['NumerodeBache','#Bache','NumeroBache','NumeroBache2']);
  const cad=norm(p,['Cadenamiento','cadenamiento']); const col=norm(p,['Colonia','colonia']); const calle=norm(p,['Calle','calle']); const entre=norm(p,['EntreCalles','Entre calles','Entrecalles','entre calles']);
  const fotos=[];
  // claves más comunes
  const keysFoto=['FotoAntes','Foto antes','Foto antes ','Fotoantes','fotoantes','Foto Referencia','FotoReferencia','Foto Final','FotoFinal'];
  for(const k of keysFoto){ if(p[k]) fotos.push(p[k]); }
  if(p.__urls) fotos.push(...p.__urls);
  // únicos y sanitizados
  const u=[...new Set(fotos.map(s=>String(s)).filter(Boolean))];
  photoSet(document.getElementById('ph_antes'), firstUrl(u));
  photoSet(document.getElementById('ph_ref'),   firstUrl(u.slice(1)));
  photoSet(document.getElementById('ph_final'), firstUrl(u.slice(2)));
  const kv=document.getElementById('kv'); kv.innerHTML='';
  const add=(k,v)=>{ if(!v) return; const K=document.createElement('div'); K.className='lbl'; K.textContent=k; const V=document.createElement('div'); V.textContent=v; kv.appendChild(K); kv.appendChild(V); };
  add('Ancho', ancho); add('Largo', largo); add('Tipo', tipo); add('# Bache', nb);
  add('Cadenamiento', cad); add('Colonia', col); add('Calle', calle); add('Entre calles', entre);
  // maps link
  const m=document.getElementById('mapsLink'); if(f.center){ m.href=`https://www.google.com/maps?q=${f.center.lat},${f.center.lng}`;} else { m.removeAttribute('href'); }
}

// ===== render =====
let features=[];
function clearLayers(){ cluster.clearLayers(); lines.clearLayers(); polys.clearLayers();}
function draw(){
  clearLayers();
  for(const f of features){
    if(f.t==='Point'){
      const m=L.circleMarker(f.c, dotStyle).on('click',()=>showPanel(f)); cluster.addLayer(m);
    }else if(f.t==='Line'){
      L.polyline(f.c,{color:'#38bdf8',weight:6,opacity:.85}).on('click',()=>showPanel(f)).addTo(lines);
    }else if(f.t==='Poly'){
      L.polygon(f.c,{color:'#22c55e',weight:2,fillOpacity:.25}).on('click',()=>showPanel(f)).addTo(polys);
    }
  }
  try{
    const g=L.featureGroup([cluster,lines,polys]); const b=g.getBounds(); if(b&&b.isValid()) map.fitBounds(b.pad(.12));
  }catch(_){}
}

// ===== cargar KML desde URL o archivo local =====
const qs=new URLSearchParams(location.search);
let currentURL=qs.get('data')||LS.getItem('kml:url')||'baches.kml';
document.getElementById('inUrl').value=currentURL;

async function loadURL(u){
  try{
    showLoader(true);
    const url=u+(u.includes('?')?'&':'?')+'t='+(Date.now());
    const res=await fetch(url);
    if(!res.ok) throw new Error('HTTP '+res.status);
    let txt='', type=res.headers.get('content-type')||'';
    if(/application\\/zip|kmz/i.test(type)||/\\.kmz(\\?|$)/i.test(u)){ const blob=await res.blob(); txt=await kmzToText(blob); }
    else{ txt=await res.text(); }
    features=parseKml(txt);
    draw();
    if(features.length){ showPanel(features.find(f=>f.t==='Point')||features[0]); }
  }catch(e){ console.error(e); toast('No se pudo cargar el KML: '+e.message,6000); }
  finally{ showLoader(false); }
}

document.getElementById('btnUrl').onclick=()=>{ const u=document.getElementById('inUrl').value.trim(); if(u){ currentURL=u; LS.setItem('kml:url',u); loadURL(currentURL);} };
document.getElementById('btnReload').onclick=()=> loadURL(currentURL);
document.getElementById('file').addEventListener('change',async ev=>{
  const f=ev.target.files[0]; if(!f) return;
  try{
    showLoader(true);
    let txt=''; if(/\\.kmz$/i.test(f.name)){ txt=await kmzToText(f);} else { txt=await f.text(); }
    features=parseKml(txt); draw(); if(features.length){ showPanel(features.find(f=>f.t==='Point')||features[0]); }
    toast('KML local cargado (solo visible en este navegador)');
  }catch(e){ console.error(e); toast('Error con archivo local: '+e.message); }
  finally{ showLoader(false); }
});

// arranque
loadURL(currentURL);
</script>
</body>
</html>
