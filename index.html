<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EZ Street MX · Mapa de Bacheo (Satélite)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--fg:#e5e7eb;--mut:#9ca3af;--line:#1f2937;--accent:#60a5fa}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Arial}
  #wrap{display:grid;grid-template-columns:300px 1fr 360px;height:100%}
  #left{border-right:1px solid var(--line);display:flex;flex-direction:column}
  #map{height:100%}
  #right{border-left:1px solid var(--line);background:var(--panel);display:flex;flex-direction:column}
  .top{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid var(--line);background:var(--panel)}
  .btn{background:#0b1220;border:1px solid var(--line);color:#e5e7eb;border-radius:8px;padding:8px 10px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .search{background:#0b1220;border:1px solid var(--line);border-radius:8px;padding:8px 10px;color:#e5e7eb;outline:none;width:100%}
  .list{overflow:auto;padding:6px 8px}
  .item{padding:10px 6px;border-bottom:1px solid #0b1220;cursor:pointer}
  .item small{display:block;color:var(--mut)}
  .panel{overflow:auto;padding:12px}
  h3{margin:6px 0 8px 0}
  .pill{display:inline-block;background:#0b1220;border:1px solid var(--line);border-radius:999px;padding:4px 8px;margin-right:6px;color:#a5b4fc}
  .kv{margin-bottom:8px}
  .kv b{color:#93c5fd}
  .photos{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .photos img{width:100%;height:90px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  #baselayers{position:absolute;right:16px;bottom:14px;z-index:600;display:flex;gap:10px}
  #baselayers .btn{background:#0b1220cc}
  #hud{position:fixed;left:8px;bottom:8px;z-index:700;background:#111827;color:#e5e7eb;border:1px solid #233146;border-radius:10px;padding:8px 10px;display:none;max-width:500px}
  .tokenBox{display:none;gap:8px;align-items:center}
  .tokenBox input{background:#0b1220;border:1px solid var(--line);border-radius:8px;padding:8px 10px;color:#e5e7eb;outline:none}
  @media (max-width:1100px){ #wrap{grid-template-columns:1fr}; #left{display:none} #right{position:absolute;right:0;top:0;width:96%;height:64%;display:none;border-radius:12px;overflow:hidden} #right.show{display:flex} #toggleRight{display:inline-block} }
</style>
<!-- libs -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/togeojson@0.16.0/dist/togeojson.umd.js"></script>
<script>if(!window.toGeoJSON&&!window.togeojson)document.write('<script src=\"https://unpkg.com/togeojson/dist/togeojson.umd.js\"><\\/script>');</script>
</head>
<body>
<div class="top">
  <button id="toggleRight" class="btn" style="display:none">Panel</button>
  <input id="inRaw" class="search" placeholder="URL de KML (o usa KML local)" />
  <button id="btnUrl" class="btn">Cargar URL</button>
  <label class="btn">
    KML local
    <input type="file" id="file" accept=\".kml,.kmz\" style="display:none">
  </label>
  <button id="btnRefresh" class="btn">Actualizar</button>
  <div class="tokenBox" id="tokenBox">
    <input id="repo" placeholder="owner/repo" style="width:160px">
    <input id="branch" value="main" style="width:90px">
    <input id="token" placeholder="token GitHub (contents:write)" style="width:210px">
    <button id="btnPublish" class="btn">Publicar</button>
  </div>
  <button id="btnAdmin" class="btn">Admin</button>
</div>

<div id="wrap">
  <aside id="left">
    <div style="padding:8px;border-bottom:1px solid var(--line)">
      <input id="q" class="search" placeholder="Buscar bache..." />
    </div>
    <div id="list" class="list"></div>
  </aside>

  <div id="map"></div>

  <aside id="right">
    <div class="panel" id="panel">
      <div class="pill">Selecciona un bache</div>
      <p>Haz clic en un punto/trazo del mapa o elige en la lista.</p>
    </div>
  </aside>
</div>

<div id="baselayers">
  <button class="btn" id="btnSat">Satélite</button>
  <button class="btn" id="btnStreets">Calles</button>
</div>

<div id="hud"></div>

<script>
const isMobile=matchMedia('(max-width:1100px)').matches;
const $right=document.getElementById('right');
const $toggleRight=document.getElementById('toggleRight'); if(isMobile) $toggleRight.style.display='inline-block';
$toggleRight.onclick=()=>{ $right.classList.toggle('show'); };

const hud=document.getElementById('hud');
function tip(s){ hud.innerHTML=s; hud.style.display='block'; setTimeout(()=>hud.style.display='none', 5000); }
function prettyKV(k,v){ if(!v) return ''; return '<div class=\"kv\"><b>'+k+':</b> '+v+'</div>'; }
function getFirstUrl(s){ if(!s) return null; const m=String(s).match(/https?:\/\/[^\s\"'<>\)]+/); return m?m[0]:null; }

// basemaps
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19});
const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:20});
const map = L.map('map', {preferCanvas:true, layers:[esri]}).setView([31.307,-110.948], 13);
document.getElementById('btnSat').onclick=()=>{ map.addLayer(esri); map.removeLayer(osm); };
document.getElementById('btnStreets').onclick=()=>{ map.addLayer(osm); };

// data
const qs = new URLSearchParams(location.search);
const defaultURL = 'baches.kml';
let currentURL = qs.get('data') || defaultURL;
document.getElementById('inRaw').value = currentURL;

let features = []; // GeoJSON features
let layerGroup = null;
const markers = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:60 });

function parseKmlFallbackAll(txt){
  const feats=[];
  const pmRx=/<Placemark[\s\S]*?<\/Placemark>/gi;
  let m; let i=0;
  while((m=pmRx.exec(txt))){
    const block=m[0];
    const props={ _id: ++i };
    // SimpleData props
    block.replace(/<SimpleData[^>]*name=\"([^"]+)\"[^>]*>([\s\S]*?)<\/SimpleData>/gi,(a,n,v)=>{props[n]=v.replace(/<[^>]+>/g,'').trim();});
    const nm=/<name>([\s\S]*?)<\/name>/i.exec(block); if(nm) props.name=nm[1].trim();
    const pt=/<Point>[\s\S]*?<coordinates>([^<]+)<\/coordinates>[\s\S]*?<\/Point>/i.exec(block);
    if(pt){
      const p=pt[1].trim().split(',').map(Number);
      if(p.length>=2 && isFinite(p[0]) && isFinite(p[1])){
        feats.push({type:'Feature',geometry:{type:'Point',coordinates:[p[0],p[1]]},properties:props}); continue;
      }
    }
    const ln=/<LineString>[\s\S]*?<coordinates>([^<]+)<\/coordinates>[\s\S]*?<\/LineString>/i.exec(block);
    if(ln){
      const coords=ln[1].trim().split(/\s+/).map(t=>t.split(',').map(Number)).filter(a=>a.length>=2).map(a=>[a[0],a[1]]);
      feats.push({type:'Feature',geometry:{type:'LineString',coordinates:coords},properties:props}); continue;
    }
    const pg=/<Polygon>[\s\S]*?<outerBoundaryIs>[\s\S]*?<LinearRing>[\s\S]*?<coordinates>([^<]+)<\/coordinates>[\s\S]*?<\/LinearRing>[\s\S]*?<\/outerBoundaryIs>[\s\S]*?<\/Polygon>/i.exec(block);
    if(pg){
      const coords=pg[1].trim().split(/\s+/).map(t=>t.split(',').map(Number)).filter(a=>a.length>=2).map(a=>[a[0],a[1]]);
      feats.push({type:'Feature',geometry:{type:'Polygon',coordinates:[coords]},properties:props}); continue;
    }
  }
  return {type:'FeatureCollection',features:feats};
}

async function loadURL(u){
  tip('Cargando '+u+' ...');
  const res = await fetch(u + (u.includes('?')?'&':'?') + 't=' + Date.now());
  if(!res.ok){ tip('No se pudo cargar ('+res.status+')'); return; }
  const txt = await res.text();
  const TG = window.toGeoJSON || window.togeojson;
  let gj=null;
  try{ if(TG){ const xml=new DOMParser().parseFromString(txt,'text/xml'); gj = TG.kml(xml); } }catch(_){}
  if(!gj || !gj.features || gj.features.length===0) gj = parseKmlFallbackAll(txt);
  features = gj.features || [];
  render();
  tip('Cargado '+features.length+' elementos');
}

function centroidLngLat(coords){
  let sx=0,sy=0,n=coords.length; for(const [x,y] of coords){ sx+=x; sy+=y; } return [sx/n, sy/n];
}

function render(){
  if(layerGroup){ map.removeLayer(layerGroup); markers.clearLayers(); }
  layerGroup = L.geoJSON({type:'FeatureCollection',features}, {
    style: ()=>({ color:'#3b82f6', weight:6, opacity:0.85 }),
    pointToLayer: (f,latlng)=>L.marker(latlng),
    onEachFeature: (f,layer)=>{
      layer.on('click', ()=>showFeature(f,layer));
    }
  });
  features.forEach(f=>{
    if(f.geometry && f.geometry.type==='Point'){
      const latlng = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
      const m = L.marker(latlng);
      m.on('click', ()=>showFeature(f,m));
      markers.addLayer(m);
    }else if(f.geometry && f.geometry.type==='LineString'){
      const c = centroidLngLat(f.geometry.coordinates);
      const latlng = L.latLng(c[1], c[0]);
      const m = L.marker(latlng);
      m.on('click', ()=>showFeature(f,m));
      markers.addLayer(m);
    }else if(f.geometry && f.geometry.type==='Polygon'){
      const c = centroidLngLat(f.geometry.coordinates[0]);
      const latlng = L.latLng(c[1], c[0]);
      const m = L.marker(latlng);
      m.on('click', ()=>showFeature(f,m));
      markers.addLayer(m);
    }
  });
  markers.addTo(map);
  map.addLayer(layerGroup);
  try{ const b = layerGroup.getBounds(); if(b && b.isValid()) map.fitBounds(b.pad(0.2)); }catch(_){}
  buildList();
}

function buildList(){
  const $list=document.getElementById('list'); $list.innerHTML='';
  features.forEach((f,i)=>{
    const props=f.properties||{};
    const title = props.name || ('kml_'+(i+1));
    const c = f.geometry && f.geometry.type==='Point' ? (f.geometry.coordinates[1].toFixed(6)+', '+f.geometry.coordinates[0].toFixed(6))
            : '—';
    const div=document.createElement('div'); div.className='item'; div.innerHTML='<div>'+title+'</div><small>'+c+'</small>';
    div.onclick=()=>{
      if(f.geometry && f.geometry.type==='Point'){
        const latlng=[f.geometry.coordinates[1], f.geometry.coordinates[0]];
        map.flyTo(latlng,18); showFeature(f,null,latlng);
      }else{
        // zoom to bounds of feature
        const lyr = L.geoJSON(f); map.fitBounds(lyr.getBounds().pad(0.2)); showFeature(f);
      }
    };
    $list.appendChild(div);
  });
}

function showFeature(f,layer,latlngOverride){
  const p = f.properties||{};
  const foto1=getFirstUrl(p.Fotoantes||p.FotoAntes||p.fotoantes||p.Foto_antes||'');
  const foto2=getFirstUrl(p.FotoReferencia||p.fotoreferencia||'');
  const foto3=getFirstUrl(p.FotoFinal||p.fotofinal||'');

  const html = `
    <h3>${p.name || 'Bache'}</h3>
    <div class="pill">${p.TipodeTrabajo||p.TipoDeTrabajo||p.Tipo||'—'}</div>
    <div class="pill"># ${p.NumeroDeBache||p.Numero||p.No||'—'}</div>
    ${prettyKV('Ancho', p.Ancho)}
    ${prettyKV('Largo', p.Largo)}
    ${prettyKV('Cadenamiento', p.Cadenamiento||p.Cadenamientox)}
    ${prettyKV('Colonia', p.Colonia)}
    ${prettyKV('Calle', p.Calle)}
    ${prettyKV('Entre calles', p.Entrecalles||p.EntreCalles)}
    ${prettyKV('Collector', p.Collector)}
    ${prettyKV('Creado', p.Createdon||p.Creado||p.Fecha)}
    <div style="margin:10px 0">
      <a class="btn" target="_blank" id="gmaps">Ver en Maps</a>
    </div>
    <h3>Fotos</h3>
    <div class="photos">
      ${foto1?`<a href="${foto1}" target="_blank"><img src="${foto1}"/></a>`:''}
      ${foto2?`<a href="${foto2}" target="_blank"><img src="${foto2}"/></a>`:''}
      ${foto3?`<a href="${foto3}" target="_blank"><img src="${foto3}"/></a>`:''}
    </div>`;
  document.getElementById('panel').innerHTML=html;
  if(isMobile) $right.classList.add('show');

  let latlng=null;
  if(latlngOverride) latlng = L.latLng(latlngOverride[0], latlngOverride[1]);
  else if(layer && layer.getLatLng) latlng = layer.getLatLng();
  else try{ const b=L.geoJSON(f).getBounds(); latlng=b.getCenter(); }catch(_){}

  if(latlng){ map.flyTo(latlng,18,{duration:.6}); document.getElementById('gmaps').href='https://www.google.com/maps?q='+latlng.lat+','+latlng.lng; }
}

// search
document.getElementById('q').addEventListener('input', e=>{
  const s=e.target.value.trim().toLowerCase();
  const $list=document.getElementById('list'); $list.childNodes.forEach((el,i)=>{
    const f=features[i]; const txt=JSON.stringify(f.properties||{}).toLowerCase();
    el.style.display = (!s || txt.includes(s)) ? '' : 'none';
  });
});

// actions
document.getElementById('btnUrl').onclick=()=>{ currentURL=document.getElementById('inRaw').value.trim(); if(!currentURL) return; loadURL(currentURL); };
document.getElementById('file').addEventListener('change', async (ev)=>{
  const f=ev.target.files[0]; if(!f) return;
  const txt = await f.text();
  const blobURL = URL.createObjectURL(new Blob([txt],{type:'application/vnd.google-earth.kml+xml'}));
  currentURL = blobURL;
  document.getElementById('inRaw').value = '(KML local)';
  loadURL(currentURL);
  window._lastLocalKmlText = txt; // para publicar
});
document.getElementById('btnRefresh').onclick=()=>loadURL(currentURL);

// admin publish
const tokenBox=document.getElementById('tokenBox');
document.getElementById('btnAdmin').onclick=()=>{
  tokenBox.style.display = tokenBox.style.display==='flex' ? 'none' : 'flex';
  // valores por defecto
  if(!repo.value) repo.value = (location.pathname.split('/')[1]||'') + '/' + (location.pathname.split('/')[2]||'');
  if(!branch.value) branch.value='main';
};
document.getElementById('btnPublish').onclick=async()=>{
  const ownerRepo = document.getElementById('repo').value.trim();
  const branch = document.getElementById('branch').value.trim()||'main';
  const token  = document.getElementById('token').value.trim();
  if(!ownerRepo || !token){ alert('Falta repo o token'); return; }

  // KML fuente: si hay uno local cargado, úsalo; si no, baja currentURL
  let kmlText = window._lastLocalKmlText;
  if(!kmlText){
    const r = await fetch(currentURL); if(!r.ok){ alert('No pude leer el KML actual'); return; }
    kmlText = await r.text();
  }

  // Commit a baches.kml (root)
  const path='baches.kml';
  const api='https://api.github.com/repos/'+ownerRepo+'/contents/'+path;
  // obtener sha si ya existe
  let sha=null;
  const r0=await fetch(api+'?ref='+branch); if(r0.ok){ const j=await r0.json(); sha=j.sha; }
  const body={ message:'publish: KML via viewer', content:btoa(unescape(encodeURIComponent(kmlText))), branch };
  if(sha) body.sha=sha;
  const r1=await fetch(api,{ method:'PUT', headers:{'Authorization':'token '+token,'Content-Type':'application/json'}, body:JSON.stringify(body)});
  if(!r1.ok){ const t=await r1.text(); alert('Error al publicar: '+t); return; }
  tip('✅ Publicado como baches.kml · Abre el visor público y pulsa Actualizar');
};

// init
loadURL(currentURL);
</script>
</body>
</html>
