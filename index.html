<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EZ Street MX · Mapa de Bacheo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet.markercluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Leaflet Omnivore para KML -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width: 100%; height: 100%; }
    .leaflet-popup-content img {
      max-width: 250px;
      height: auto;
      display: block;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Inicializar mapa
    var map = L.map('map', {
      zoomControl: true
    }).setView([31.3, -110.93], 13); // Coordenadas base de Nogales

    // Capa base (Google Satélite vía leaflet-providers)
    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      maxZoom: 22,
      attribution: '&copy; Google'
    }).addTo(map);

    // Cluster optimizado
    var markers = L.markerClusterGroup({
      disableClusteringAtZoom: 18,
      maxClusterRadius: 40
    });

    // Cargar KML
    omnivore.kml('baches.kml')
      .on('ready', function() {
        this.eachLayer(function(layer) {
          var props = layer.feature.properties;

          // Contenido popup optimizado
          var popupContent = "<b>" + (props.name || "Bache") + "</b><br>" +
              (props.description || "");

          // Si hay imágenes en la descripción
          if (props.description) {
            var imgMatches = props.description.match(/(https?:\/\/[^\s"]+\.(?:jpg|jpeg|png|gif))/gi);
            if (imgMatches) {
              imgMatches.forEach(function(url) {
                popupContent += `<a href="${url}" target="_blank"><img loading="lazy" src="${url}"></a>`;
              });
            }
          }

          layer.bindPopup(popupContent);
          markers.addLayer(layer);
        });
        map.addLayer(markers);
        map.fitBounds(markers.getBounds());
      })
      .on('error', function() {
        alert('No se pudo cargar el archivo baches.kml');
      });
  </script>
</body>
</html>
