<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EZ Street MX · Mapa de Bacheo</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Cluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
:root{
  --bg:#0f172a;        /* slate-900 */
  --panel:#0b1220;     /* darker */
  --muted:#94a3b8;     /* slate-400 */
  --text:#e2e8f0;      /* slate-200 */
  --accent:#22d3ee;    /* cyan-400 */
  --chip:#0ea5e9;      /* sky-500 */
}
*{box-sizing:border-box}
html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{
  position:fixed;inset:10px 10px auto 10px;height:46px;
  display:flex;gap:8px;align-items:center;z-index:1000;
  background:rgba(15,23,42,.8);backdrop-filter:saturate(140%) blur(6px);
  border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:6px 10px;
}
header .title{font-weight:600;margin-right:8px;white-space:nowrap}
header input[type="text"]{
  width:360px;max-width:42vw;background:#0b1220;border:1px solid rgba(148,163,184,.25);
  color:var(--text);padding:8px 10px;border-radius:10px;outline:none;
}
header button, header label.btn{
  background:#0b1220;border:1px solid rgba(148,163,184,.25);
  color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;
}
label.btn input{display:none}

#map{height:100%;width:100%}

/* Panel lateral / bottom sheet */
#panel{
  position:fixed;top:0;right:0;width:360px;height:100%;z-index:1000;
  background:var(--panel);border-left:1px solid rgba(148,163,184,.18);
  display:flex;flex-direction:column;gap:10px;padding:14px;overflow:auto;
}
#panel .h{display:flex;align-items:center;justify-content:space-between;gap:10px}
#panel .h .name{font-weight:700}
#panel .chip{font-size:12px;background:rgba(56,189,248,.15);color:#7dd3fc; padding:3px 8px;border-radius:999px;border:1px solid rgba(56,189,248,.25)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row .box{background:#0e1729;border:1px solid rgba(148,163,184,.18);border-radius:10px;padding:10px}
.box h4{margin:.2rem 0 .6rem 0;font-size:13px;color:var(--muted)}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 12px}
.kv div.key{color:var(--muted)}
a.btn{
  display:inline-flex;align-items:center;gap:8px;
  background:#0b1220;border:1px solid rgba(148,163,184,.25);color:var(--text);
  padding:8px 10px;border-radius:10px;text-decoration:none
}
.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.gallery .imgbox{
  aspect-ratio:1/1;border-radius:10px;overflow:hidden;background:#0b1220;border:1px solid rgba(148,163,184,.18);
  position:relative
}
.gallery .imgbox img{width:100%;height:100%;object-fit:cover;display:block}
.gallery .imgbox a.fallback{position:absolute;inset:auto 8px 8px 8px;background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.35);color:#cbd5e1;border-radius:8px;padding:4px 6px;text-decoration:none;font-size:12px;text-align:center}
.empty{color:var(--muted);font-size:13px}

.leaflet-control-zoom{display:none} /* sin + / - */

/* Mobile bottom sheet */
@media (max-width: 920px){
  header{left:8px;right:8px}
  header input[type="text"]{width:38vw;max-width:42vw}
  #panel{
    width:100%;height:45%;right:0;left:0;top:auto;bottom:0;border-left:none;border-top:1px solid rgba(148,163,184,.18);
    border-radius:14px 14px 0 0;
  }
}
/* tiny */
@media (max-width:480px){
  header .title{display:none}
  header input[type="text"]{display:none}
}

</style>
</head>
<body>
<div id="app">
  <header>
    <div class="title">EZ Street MX · Mapa de Bacheo</div>
    <input id="kmlUrl" type="text" placeholder="URL del KML (por defecto: baches.kml)"/>
    <button id="btnLoadUrl">Cargar URL</button>
    <label class="btn">KML local<input id="fileKML" type="file" accept=".kml,.kmz"/></label>
  </header>

  <div id="map"></div>

  <aside id="panel">
    <div class="h">
      <div class="name">Selecciona un bache…</div>
      <a class="btn" id="btnMaps" target="_blank" rel="noopener">Ver en Maps</a>
    </div>
    <div class="row">
      <div class="box">
        <h4>Fotos</h4>
        <div class="gallery" id="gal"></div>
      </div>
      <div class="box">
        <h4>Medidas</h4>
        <div class="kv" id="kv">
          <div class="key">Ancho</div><div id="kvAncho" class="val empty">—</div>
          <div class="key">Largo</div><div id="kvLargo" class="val empty">—</div>
          <div class="key">Tipo</div><div id="kvTipo" class="val empty">—</div>
          <div class="key"># Bache</div><div id="kvNum" class="val empty">—</div>
          <div class="key">Cadenamiento</div><div id="kvCad" class="val empty">—</div>
          <div class="key">Colonia</div><div id="kvCol" class="val empty">—</div>
          <div class="key">Calle</div><div id="kvCal" class="val empty">—</div>
          <div class="key">Entre calles</div><div id="kvEnt" class="val empty">—</div>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
const qs = (s,p=document)=>p.querySelector(s);
const qsa = (s,p=document)=>[...p.querySelectorAll(s)];

// Map
const map = L.map('map',{zoomControl:false}).setView([31.3,-110.94], 14);
const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  maxZoom: 22, attribution: '&copy; Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
}).addTo(map);

// cluster group
const cluster = L.markerClusterGroup({
  spiderfyOnMaxZoom:true,
  showCoverageOnHover:false,
  disableClusteringAtZoom: 19,
  maxClusterRadius: 40,
});

map.addLayer(cluster);

function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
const defaultUrl = getParam('data') || 'baches.kml';
qs('#kmlUrl').value = defaultUrl;

function parseKML(text){
  const dom = new DOMParser().parseFromString(text,'text/xml');
  const places = dom.getElementsByTagName('Placemark');
  const feats = [];
  for(const pm of places){
    // coordinates
    const coordsNode = pm.querySelector('Point > coordinates, LineString > coordinates, Polygon outerBoundaryIs coordinates');
    if(!coordsNode) continue;
    const coordStr = coordsNode.textContent.trim().split(/\s+/)[0]; // first coord
    const parts = coordStr.split(',');
    if(parts.length < 2) continue;
    const lon = parseFloat(parts[0]), lat = parseFloat(parts[1]);
    if(!isFinite(lat) || !isFinite(lon)) continue;

    // props
    const props = {};
    const name = pm.querySelector('name'); if(name) props.name = name.textContent.trim();

    // ExtendedData: <Data name=""><value>...</value></Data>
    pm.querySelectorAll('ExtendedData Data').forEach(d=>{
      const k = (d.getAttribute('name')||'').trim();
      const v = (d.querySelector('value')?.textContent || '').trim();
      if(k) props[k] = v;
    });
    // ExtendedData: <SchemaData><SimpleData name=""></SimpleData></SchemaData>
    pm.querySelectorAll('ExtendedData SimpleData').forEach(sd=>{
      const k = (sd.getAttribute('name')||'').trim();
      const v = (sd.textContent || '').trim();
      if(k) props[k] = v;
    });

    // description HTML (buscar imágenes y pares clave/valor)
    const desc = pm.querySelector('description')?.textContent || '';
    if(desc){
      props.description = desc;
      // kp: parse pares "Campo: Valor" básicos
      const tmp = document.createElement('div'); tmp.innerHTML = desc;
      const txt = tmp.textContent || '';
      // intentar extraer "Campo: Valor" simples
      txt.split(/[\r\n]+/).forEach(line=>{
        const m = line.match(/^\s*([^:]{3,30})\s*:\s*(.+?)\s*$/);
        if(m){
          const k = m[1].trim(); const v = m[2].trim();
          if(!props[k]) props[k] = v;
        }
      });
      // imágenes por src/href
      const imgs = [...tmp.querySelectorAll('img')].map(i=>i.src).filter(Boolean);
      const links = [...tmp.querySelectorAll('a')].map(a=>a.href).filter(u=>/\.(jpg|jpeg|png|gif|webp)(\?|$)/i.test(u));
      const all = [...imgs, ...links];
      if(all.length){
        props._imagesFromDesc = all;
      }
    }

    feats.push({type:'Feature', geometry:{type:'Point', coordinates:[lon,lat]}, properties:props});
  }
  return feats;
}

function valOf(props, keys){
  for(const k of keys){
    if(props[k] && String(props[k]).trim()) return String(props[k]).trim();
  }
  // buscar en claves normalizadas
  const norm = {};
  Object.entries(props).forEach(([k,v])=>norm[k.toLowerCase()] = v);
  for(const k of keys){
    const kk = k.toLowerCase();
    if(norm[kk]) return String(norm[kk]).trim();
  }
  return '';
}
function setText(id, text){
  const el = qs(id);
  if(!el) return;
  if(text){ el.textContent = text; el.classList.remove('empty'); }
  else { el.textContent = '—'; el.classList.add('empty'); }
}

function thumbSlot(url, label){
  const box = document.createElement('div');
  box.className = 'imgbox';
  if(url){
    const img = new Image();
    img.loading = 'lazy';
    img.decoding = 'async';
    img.src = url;
    let failed = false;
    img.onerror = ()=>{
      if(failed) return;
      failed = true;
      img.remove();
      const a = document.createElement('a');
      a.className = 'fallback';
      a.href = url; a.target = '_blank'; a.rel='noopener';
      a.textContent = 'Abrir ' + (label||'foto');
      box.appendChild(a);
    };
    box.appendChild(img);
  }else{
    const span = document.createElement('div');
    span.className = 'fallback';
    span.textContent = 'Sin ' + (label||'foto');
    span.style.pointerEvents = 'none';
    box.appendChild(span);
  }
  return box;
}

// construir galería con prioridad: campos -> desc -> nada
function buildGallery(props){
  const gal = qs('#gal');
  gal.innerHTML = '';
  const pick = (names)=>{
    const v = valOf(props, names);
    if(v) return v;
    return '';
  }

  // nombres posibles
  const fAntes = pick(['Foto antes','FotoAntes','Antes','Foto_antes','foto_antes']);
  const fRef   = pick(['FotoReferencia','Foto Referencia','Referencia','Foto_Referencia','foto_referencia']);
  const fFinal = pick(['Foto Final','FotoFinal','Final','Foto_final','foto_final']);

  // si no hay de campos, intentar desde descripción
  const descImgs = props._imagesFromDesc || [];

  const a = fAntes || descImgs[0] || '';
  const r = fRef   || descImgs[1] || '';
  const f = fFinal || descImgs[2] || '';
  gal.appendChild(thumbSlot(a,'antes'));
  gal.appendChild(thumbSlot(r,'referencia'));
  gal.appendChild(thumbSlot(f,'final'));
}

function onFeatureClick(feat){
  const p = feat.properties || {};
  const name = p.name || valOf(p,['Numero de Bache','NumeroBache','Bache','id','title']) || 'Baches';
  qs('#panel .name').textContent = name;

  // medidas + datos
  setText('#kvAncho', valOf(p, ['Ancho','ancho']));
  setText('#kvLargo', valOf(p, ['Largo','largo']));
  setText('#kvTipo',  valOf(p, ['Tipo de trabajo','TipoTrabajo','Tipo','Trabajo']));
  setText('#kvNum',   valOf(p, ['Numero de Bache','NumeroBache','NumBache','Bache']));
  setText('#kvCad',   valOf(p, ['Cadenamiento','cadenamiento']));
  setText('#kvCol',   valOf(p, ['Colonia','colonia']));
  setText('#kvCal',   valOf(p, ['Calle','calle']));
  setText('#kvEnt',   valOf(p, ['Entre calles','EntreCalles','entre calles']));

  buildGallery(p);

  // maps
  const [lon,lat] = feat.geometry.coordinates;
  const u = `https://www.google.com/maps?q=${lat},${lon}`;
  const btn = qs('#btnMaps');
  btn.href = u;

  // focus
  map.flyTo([lat,lon], Math.max(19, map.getZoom()));
}

function addFeatures(features){
  cluster.clearLayers();
  const group = L.featureGroup();
  for(const feat of features){
    const [lon,lat] = feat.geometry.coordinates;
    const m = L.circleMarker([lat,lon], {
      radius: 4, color:'#ef4444', weight: 2, fillColor:'#ef4444', fillOpacity:.9
    });
    m.on('click', ()=> onFeatureClick(feat));
    group.addLayer(m);
  }
  cluster.addLayer(group);
  if(features.length){
    map.fitBounds(group.getBounds(), {padding:[40,40]});
    onFeatureClick(features[0]);
  }
}

async function loadUrl(u){
  try{
    const res = await fetch(u, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const text = await res.text();
    const feats = parseKML(text);
    addFeatures(feats);
  }catch(e){
    alert('No se pudo cargar el KML: '+e.message);
    console.error(e);
  }
}

function loadLocal(file){
  const reader = new FileReader();
  reader.onload = (ev)=>{
    try{
      const text = ev.target.result;
      const feats = parseKML(text);
      addFeatures(feats);
    }catch(e){
      alert('No se pudo leer el archivo: '+e.message);
      console.error(e);
    }
  };
  reader.readAsText(file);
}

// UI events
qs('#btnLoadUrl').addEventListener('click',()=>{
  const u = qs('#kmlUrl').value.trim() || 'baches.kml';
  loadUrl(u);
});
qs('#fileKML').addEventListener('change',ev=>{
  const f = ev.target.files?.[0];
  if(f) loadLocal(f);
});

// first load
loadUrl(defaultUrl);
</script>
</body>
</html>
