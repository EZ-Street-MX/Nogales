<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EZ Street MX · Mapa de Bacheo</title>
<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://server.arcgisonline.com" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
<style>
:root{
  --bg:#0f172a;      /* fondo slate-900 */
  --panel:#0b1220;  /* panel lateral */
  --muted:#94a3b8;  /* slate-400 */
  --text:#e2e8f0;   /* slate-200 */
  --acc:#22c55e;    /* verde ok */
  --chip:#334155;   /* slate-700 */
}
*{box-sizing:border-box}
html,body,#app{height:100%;margin:0;background:#0d1117;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
#app{display:grid;grid-template-columns:1fr 360px;grid-template-rows:auto 1fr;grid-template-areas:"hdr hdr" "map details"}
header{grid-area:hdr;display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.6rem .8rem;background:#0b1220;border-bottom:1px solid #1f2937}
header .title{font-weight:700;letter-spacing:.2px}
header .pill{background:var(--chip);border-radius:999px;padding:.2rem .6rem;font-size:.8rem;}

#map{grid-area:map}
#details{grid-area:details;background:var(--panel);border-left:1px solid #1f2937;display:flex;flex-direction:column;min-width:0}
#details .empty{opacity:.7;color:var(--muted);padding:1rem}
#card{display:none;overflow:auto;height:100%}
#card .head{padding:.6rem .9rem;border-bottom:1px solid #1f2937}
#card h2{margin:.2rem 0 .4rem 0;font-size:1.05rem}
.grid{display:grid;grid-template-columns:1fr;gap:.75rem;padding:.8rem .9rem}
.field{background:#0e1628;border:1px solid #1f2937;border-radius:.6rem;padding:.55rem}
.field h4{margin:.1rem 0 .35rem 0;font-size:.83rem;color:var(--muted);font-weight:600}
.field .val{font-size:.95rem;word-break:break-word}

.photos{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
.photo{position:relative;background:#111827;border-radius:.5rem;overflow:hidden;border:1px solid #1f2937;cursor:pointer}
.photo img{width:100%;height:88px;object-fit:cover;display:block}
.photo:active{opacity:.85}

/* botón “Panel” para móvil */
#togglePanel{display:none}
@media (max-width: 980px){
  #app{grid-template-columns:1fr;grid-template-rows:auto minmax(0,1fr) minmax(240px,45vh);grid-template-areas:"hdr" "map" "details"}
  #togglePanel{display:inline-flex}
}

/* marcador: punto rojo */
.dot{width:10px;height:10px;background:#ef4444;border-radius:999px;border:2px solid #ffffffaa;box-shadow:0 0 0 2px #ef444466}
.dot.dot-selected{background:#22c55e;box-shadow:0 0 0 3px #22c55e66}
.leaflet-control-zoom{display:none} /* quita + y - */
.cluster-green{background:#16a34a;color:#fff;border-radius:999px;border:2px solid #fff;box-shadow:0 1px 4px #0005}
.cluster-green div{padding:4px 6px}
/* mini chips */
.chips{display:flex;flex-wrap:wrap;gap:.35rem}
.chip{background:#172033;border:1px solid #223049;border-radius:999px;padding:.15rem .55rem;font-size:.75rem;color:#cbd5e1}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="left" style="display:flex;gap:.6rem;align-items:center">
      <span class="title">EZ Street MX · Mapa de Bacheo</span>
      <span class="pill" title="Archivo por defecto">baches.kml</span>
    </div>
    <button id="togglePanel" class="pill" aria-label="Mostrar/ocultar panel">Panel</button>
  </header>

  <div id="map"></div>

  <aside id="details">
    <div id="placeholder" class="empty">Selecciona un bache del mapa para ver los detalles.</div>
    <div id="card">
      <div class="head">
        <h2 id="cardTitle">Bache</h2>
        <div class="chips" id="chips"></div>
      </div>
      <div class="grid" id="fields">
        <!-- campos -->
      </div>
      <div class="grid">
        <div class="field">
          <h4>Fotos</h4>
          <div class="photos" id="photos"></div>
        </div>
      </div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script>
// --- Mapa base (satélite + calles) sin botones + / - ---
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxNativeZoom: 19,
  maxZoom: 22,
  attribution: '&copy; Esri'
});
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 22,
  attribution: '&copy; OpenStreetMap'
});
const map = L.map('map', { zoomControl:false, layers:[sat] }).setView([31.305, -110.94], 13);
L.control.layers({ 'Satélite':sat, 'Calles':osm }, null, { position:'bottomright' }).addTo(map);

// --- Marcador tipo punto rojo (muy ligero) ---
const dotIcon = L.divIcon({ className:'dot', iconSize:[10,10], iconAnchor:[5,5] });

// --- Grupo con clústeres que se desmontan al acercar ---
const clusters = L.markerClusterGroup({
  disableClusteringAtZoom: 19,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false,
  maxClusterRadius: 44,
  iconCreateFunction: (c) => {
    const count = c.getChildCount();
    const html = `<div>${count}</div>`;
    return L.divIcon({ html, className:'cluster-green', iconSize:[32,32] });
  }
}).addTo(map);

// --- Helpers UI panel ---
const $card = document.getElementById('card');
const $ph   = document.getElementById('placeholder');
const $fields = document.getElementById('fields');
const $title  = document.getElementById('cardTitle');
const $photos = document.getElementById('photos');
const $chips  = document.getElementById('chips');
const $toggle = document.getElementById('togglePanel');
$toggle.addEventListener('click', ()=>{
  const aside = document.getElementById('details');
  aside.style.display = (aside.style.display==='none' ? '' : 'none');
});

function showCard(){
  $ph.style.display='none';
  $card.style.display='block';
  // en móvil, nos aseguramos de bajar al panel
  if (window.innerWidth < 980){
    $card.scrollIntoView({behavior:'smooth', block:'start'});
  }
}
function clearCard(){
  $fields.innerHTML = '';
  $photos.innerHTML = '';
  $chips.innerHTML  = '';
}

// Preferencias de campos a mostrar (en orden)
const FIELD_ORDER = [
  'Tipo de trabajo','Bache','Bache C','TipoTrabajo','Tipo','Tipo de Trabajo',
  'Numero de Bache','Número de Bache','NumBache','Id','ID',
  'Ancho','Largo','Cadenamiento','Colonia','Calle','EntreCalles','Entre calles','Entrecalles','Collector','Createdon','Fecha'
];
// Campos que se consideran “fotos”
function isPhotoKey(k){
  const s = k.toLowerCase();
  return s.includes('foto');
}

// --- Render del panel de un feature ---
function renderDetails(props){
  clearCard();
  // título
  const nm = props.name || props['name'] || props['Nombre'] || 'Bache';
  $title.textContent = nm;

  // chips rápidos: lat/lon si existen
  if (props._lat && props._lon){
    const chip = document.createElement('span');
    chip.className='chip';
    chip.textContent = `${props._lat.toFixed(6)}, ${props._lon.toFixed(6)}`;
    $chips.appendChild(chip);
  }

  // fotos
  const photoEntries = Object.entries(props).filter(([k,v])=> isPhotoKey(k) && typeof v === 'string' && v.trim());
  if (photoEntries.length){
    photoEntries.forEach(([k, url])=>{
      const ph = document.createElement('div');
      ph.className='photo';
      const img = document.createElement('img');
      img.loading='lazy';
      img.referrerPolicy='no-referrer';
      img.src = url;
      ph.appendChild(img);
      ph.title = k;
      ph.addEventListener('click', ()=> window.open(url, '_blank', 'noopener'));
      $photos.appendChild(ph);
    });
  }

  // campos (limpiando y ordenando)
  const entries = Object.entries(props)
    .filter(([k,v])=> !isPhotoKey(k) && typeof v === 'string' && v.trim() && !['_lat','_lon','name'].includes(k));

  // primero los preferidos, luego el resto
  const sorted = [
    ...FIELD_ORDER.map(key=> entries.find(([k])=>k===key)).filter(Boolean),
    ...entries.filter(e=>!FIELD_ORDER.includes(e[0]))
  ];

  sorted.forEach(([k,v])=>{
    const box = document.createElement('div');
    box.className='field';
    const h = document.createElement('h4'); h.textContent=k;
    const p = document.createElement('div'); p.className='val'; p.textContent=v;
    box.appendChild(h); box.appendChild(p);
    $fields.appendChild(box);
  });

  showCard();
}

// --- Parseo de KML a GeoJSON (sin UI de carga) ---
async function loadKMLDefault(){
  const url = (new URLSearchParams(location.search).get('data')) || 'baches.kml';
  const res = await fetch(url + (url.includes('?')?'&':'?') + 't=' + Date.now());
  if(!res.ok){ throw new Error('No se pudo descargar el KML'); }
  const txt = await res.text();
  const dom = new DOMParser().parseFromString(txt,'text/xml');
  const gj  = togeojson.kml(dom);

  clusters.clearLayers();
  const bounds = [];
  gj.features.forEach(f=>{
    if(!f.geometry || f.geometry.type!=='Point') return;
    const [lon,lat] = f.geometry.coordinates;
    const p = f.properties || {};
    p._lat = lat; p._lon = lon;

    // Marcador y click
    const m = L.marker([lat,lon], { icon:dotIcon, title:p.name||'' });
    m.on('click', ()=>{
      // Toggle selección visual del punto
      document.querySelectorAll('.dot-selected').forEach(e=>e.classList.remove('dot-selected'));
      const el = m.getElement();
      if(el) el.classList.add('dot-selected');
      renderDetails(p);
    });
    clusters.addLayer(m);
    bounds.push([lat,lon]);
  });

  if(bounds.length){
    const b = L.latLngBounds(bounds);
    map.fitBounds(b.pad(0.2));
  }
}

loadKMLDefault().catch(err=>{
  console.error(err);
  document.getElementById('placeholder').textContent = 'No se pudo cargar el KML.';
});
</script>
</body>
</html>
