<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EZ Street MX · Mapa de Bacheo</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{
    --bg:#0f1924;
    --panel:#0d1420;
    --muted:#9bb1c9;
    --text:#e6f0ff;
    --accent:#00d0ff;
    --chip:#132235;
  }
  *{box-sizing:border-box}
  html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font:15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  #app{position:fixed; inset:0; display:grid; grid-template-columns: 1fr min(420px, 35vw);}
  #map{height:100%; width:100%}
  #panel{
    border-left:1px solid #142236;
    background:linear-gradient(180deg, #0c1320 0%, #0a121e 100%);
    display:flex; flex-direction:column; min-width:280px; max-width:520px;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; border-bottom:1px solid #15263d; gap:8px;
  }
  header h1{font-size:15px; margin:0; font-weight:600; color:#cfe6ff}
  .kbd{background:#102035; border:1px solid #1c3557; border-radius:10px; padding:4px 8px; color:#aad3ff; font-weight:600}
  .btn{
    background:#0f2138; color:#bfe2ff; border:1px solid #1e3a60; border-radius:10px; padding:6px 10px; cursor:pointer;
  }
  .btn:hover{border-color:#2b5a92}
  #content{padding:10px 12px; overflow:auto}
  .section{margin-bottom:14px;}
  .section h3{margin:0 0 8px 0; font-size:13px; color:#9dc1e6; font-weight:700; text-transform:uppercase; letter-spacing:.04em}
  .grid-info{
    display:grid; grid-template-columns: 1fr auto; gap:8px 12px; background:#0c1a2e; border:1px solid #163055; padding:10px; border-radius:12px;
  }
  .grid-info .lbl{color:#93b3d6}
  .grid-info .val{color:#e7f1ff; font-weight:600}
  .photos{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px}
  .ph{
    aspect-ratio: 1/1; border-radius:10px; overflow:hidden; background:#0b1a2a; border:1px dashed #23446f;
    display:flex; align-items:center; justify-content:center; position:relative;
  }
  .ph img{ width:100%; height:100%; object-fit:cover; display:block }
  .ph .fallback{
    position:absolute; inset:auto 6px 6px 6px; background:#0d233a; color:#9ec6ff; border:1px solid #1b4270; padding:3px 6px; border-radius:8px; font-size:12px; text-decoration:none; text-align:center;
  }

  /* Toggle for narrow screens */
  #toggle{
    position:fixed; right:10px; top:10px; z-index:600;
    display:none;
  }
  @media (max-width: 1024px){
    #app{grid-template-columns: 1fr}
    #panel{ position:fixed; right:0; top:0; height:100%; width:min(92vw, 480px); transform:translateX(100%); transition:transform .25s ease; box-shadow:-20px 0 50px rgba(0,0,0,.25)}
    #panel.open{ transform:translateX(0) }
    #toggle{ display:block }
  }

  /* Red dot markers legend chip */
  .chip{display:inline-flex; align-items:center; gap:8px; background:var(--chip); padding:6px 10px; border-radius:999px; color:#b8d7ff; border:1px solid #1a385e}
  .dot{width:8px; height:8px; border-radius:50%; background:#ff375f; box-shadow:0 0 0 2px rgba(255,55,95,.25)}
</style>
</head>
<body>
<button id="toggle" class="btn">Panel</button>
<div id="app">
  <div id="map"></div>

  <aside id="panel" aria-live="polite">
    <header>
      <h1 id="ptitle">Selecciona un bache</h1>
      <div style="display:flex; gap:8px; align-items:center">
        <span class="chip"><span class="dot"></span> Baches</span>
        <button class="btn" id="openMaps" disabled>Ver en Maps</button>
      </div>
    </header>
    <div id="content">
      <div class="section">
        <h3>Fotos</h3>
        <div class="photos">
          <div class="ph" id="ph-antes"><a class="fallback" target="_blank" hidden>Abrir antes</a></div>
          <div class="ph" id="ph-ref"><a class="fallback" target="_blank" hidden>Abrir referencia</a></div>
          <div class="ph" id="ph-final"><a class="fallback" target="_blank" hidden>Abrir final</a></div>
        </div>
      </div>

      <div class="section">
        <h3>Medidas</h3>
        <div class="grid-info" id="info">
          <div class="lbl">Ancho</div><div class="val" id="v-ancho">—</div>
          <div class="lbl">Largo</div><div class="val" id="v-largo">—</div>
          <div class="lbl">Tipo</div><div class="val" id="v-tipo">—</div>
          <div class="lbl"># Bache</div><div class="val" id="v-num">—</div>
          <div class="lbl">Cadenamiento</div><div class="val" id="v-cad">—</div>
          <div class="lbl">Colonia</div><div class="val" id="v-col">—</div>
          <div class="lbl">Calle</div><div class="val" id="v-calle">—</div>
          <div class="lbl">Entre calles</div><div class="val" id="v-entre">—</div>
        </div>
      </div>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(() => {
  const qs     = (s,el=document) => el.querySelector(s);
  const qsa    = (s,el=document) => [...el.querySelectorAll(s)];
  const params = new URLSearchParams(location.search);
  const dataURL = (params.get('data')||'baches.kml').trim();
  const map = L.map('map', {
    center:[31.301, -110.94],
    zoom: 14,
    minZoom: 3,
    maxZoom: 22,         // permitir acercar un poco más
    zoomSnap: 0.25,
    zoomDelta: 0.5
  });

  // Esri World Imagery + labels opcionales
  L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Imagery © Esri',
    maxZoom: 22
  }).addTo(map);

  // Capa de puntos / estilo rojo
  const dots = L.featureGroup().addTo(map);

  // Panel responsive
  const panel = qs('#panel');
  const btnToggle = qs('#toggle');
  btnToggle.onclick = () => panel.classList.toggle('open');

  // helpers para panel
  function setVal(id, val){ qs(id).textContent = val || '—'; }
  function setImg(holderId, url, label){
    const box = qs(holderId);
    box.innerHTML = '';
    const a = box.querySelector('.fallback') || document.createElement('a');
    a.className = 'fallback'; a.textContent = 'Abrir ' + label; a.target = '_blank';

    if(!url){ a.hidden = true; box.appendChild(a); return; }

    // si la URL no es https o falla por CORS, mostramos el botón Abrir
    try{
      const u = new URL(url, location.href);
      if(u.protocol !== 'https:'){
        a.href = u.href; a.hidden = false; box.appendChild(a); return;
      }
    }catch(e){}

    const img = new Image();
    img.loading = 'lazy';
    img.referrerPolicy = 'no-referrer';
    img.crossOrigin = 'anonymous';
    img.src = url;

    let shown = false;
    img.onload = ()=>{ shown = true; a.hidden = true; box.appendChild(img); };
    img.onerror = ()=>{ a.href = url; a.hidden = false; box.appendChild(a); };
  }

  function normalizeKey(k){
    return (k||'').toLowerCase().replace(/\s|_/g,'');
  }

  function findField(obj, variants){
    const keys = Object.keys(obj||{});
    for(const v of variants){
      const vk = normalizeKey(v);
      const k = keys.find(kk => normalizeKey(kk) === vk);
      if(k) return obj[k];
    }
    return '';
  }

  // Parsear KML manualmente (sin dependencias)
  fetch(dataURL).then(r=>{
    if(!r.ok) throw new Error('No se pudo cargar ' + dataURL);
    return r.text();
  }).then(txt=>{
    const xml = new DOMParser().parseFromString(txt, 'text/xml');
    const placemarks = [...xml.getElementsByTagName('Placemark')];
    if(!placemarks.length) throw new Error('Sin Placemarks en el KML');

    const bounds = L.latLngBounds();
    placemarks.forEach((pm, idx)=>{
      const name = pm.getElementsByTagName('name')[0]?.textContent || ('kml_' + (idx+1));
      const coordsTxt = pm.getElementsByTagName('coordinates')[0]?.textContent?.trim() || '';
      const parts = coordsTxt.split(/[\s,]+/).filter(Boolean);
      let lon=null, lat=null;
      if(parts.length>=2){ lon = parseFloat(parts[0]); lat = parseFloat(parts[1]); }
      if(!(isFinite(lat)&&isFinite(lon))) return;

      // Campos en ExtendedData / SchemaData / SimpleData
      let fields = {};
      qsa('ExtendedData Data', pm).forEach(d=>{
        const k = d.getAttribute('name') || d.getAttribute('Name');
        const v = d.getElementsByTagName('value')[0]?.textContent || d.textContent || '';
        if(k) fields[k] = v;
      });
      qsa('SchemaData SimpleData', pm).forEach(sd=>{
        const k = sd.getAttribute('name'); const v = sd.textContent || '';
        if(k) fields[k] = v;
      });

      // También raspar posibles URLs de fotos en description
      let descHTML = pm.getElementsByTagName('description')[0]?.textContent || '';
      let tmp = document.createElement('div'); tmp.innerHTML = descHTML;
      const imgEl = tmp.querySelectorAll('img');
      const aEl   = tmp.querySelectorAll('a[href]');
      const candidateImgs = [...imgEl].map(i=>i.getAttribute('src')).concat([...aEl].map(a=>a.getAttribute('href')));

      // Construir objeto de datos
      const data = {
        name,
        ancho: findField(fields, ['Ancho']) || '',
        largo: findField(fields, ['Largo']) || '',
        tipo:  findField(fields, ['TipodeTrabajo','Tipo','Tipodetrabajo']) || '',
        num:   findField(fields, ['NumerodeBache','NumeroBache','NumBache','#Bache','Bache']) || '',
        cad:   findField(fields, ['Cadenamiento','Cadenamiento']) || '',
        col:   findField(fields, ['Colonia']) || '',
        calle: findField(fields, ['Calle']) || '',
        entre: findField(fields, ['EntreCalles','Entrecalles','Entre Calles']) || '',
        fotoAntes: findField(fields, ['Fotoantes','Foto Antes','FotoAntes']) || candidateImgs[0] || '',
        fotoRef:   findField(fields, ['FotoReferencia','Foto Referencia','FotoReferencia']) || candidateImgs[1] || '',
        fotoFinal: findField(fields, ['FotoFinal','Foto Final','FotoFinal']) || candidateImgs[2] || ''
      };

      const ll = L.latLng(lat, lon);
      bounds.extend(ll);

      const marker = L.circleMarker(ll, {
        radius: 5,
        color: '#ff375f',
        weight: 1.5,
        opacity: 1,
        fillColor: '#ff375f',
        fillOpacity: 0.9,
        pane: 'markerPane'
      }).addTo(dots);

      marker.on('click', ()=>{
        panel.classList.add('open');
        qs('#ptitle').textContent = data.name;
        setVal('#v-ancho', data.ancho);
        setVal('#v-largo', data.largo);
        setVal('#v-tipo',  data.tipo);
        setVal('#v-num',   data.num);
        setVal('#v-cad',   data.cad);
        setVal('#v-col',   data.col);
        setVal('#v-calle', data.calle);
        setVal('#v-entre', data.entre);

        setImg('#ph-antes', data.fotoAntes, 'antes');
        setImg('#ph-ref',   data.fotoRef,   'referencia');
        setImg('#ph-final', data.fotoFinal, 'final');

        const gmaps = `https://www.google.com/maps?q=${ll.lat},${ll.lng}`;
        const btn = qs('#openMaps');
        btn.disabled = false; btn.onclick = ()=> window.open(gmaps, '_blank');
      });
    });

    if(bounds.isValid()) map.fitBounds(bounds.pad(0.2));
  }).catch(err=>{
    console.error(err);
    alert('No se pudo cargar el KML: ' + err.message);
  });

})();
</script>
</body>
</html>
