<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>EZ Street MX · Mapa de Bacheo (Satélite)</title>

  <!-- Leaflet & MarkerCluster (CDNs muy estables) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#101722;
      --panel:#0f1b2a;
      --panel2:#0c1522;
      --fg:#e7eefc;
      --muted:#9bb0c9;
      --accent:#4cc3ff;
      --badge:#1f2c3d;
      --btn:#1b2a41;
      --btn-hover:#20324c;
      --green:#68d391;
      --blue:#63b3ed;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .app{display:flex;flex-direction:column;height:100%}
    .topbar{
      display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;border-bottom:1px solid #0d2136;background:#0e1724;flex-wrap:wrap;
    }
    .brand{font-weight:700;letter-spacing:.2px;margin-left:.3rem}
    .grow{flex:1}
    input[type="text"]{
      background:var(--panel);color:var(--fg);
      border:1px solid #1e2b3e;border-radius:.5rem;padding:.55rem .7rem;width:100%;
    }
    .btn{
      background:var(--btn);border:1px solid #24354d;color:var(--fg);
      padding:.5rem .75rem;border-radius:.5rem;cursor:pointer;
    }
    .btn:hover{background:var(--btn-hover)}
    .btn.primary{background:#214b6b;border-color:#2b628c}
    .btn.ghost{background:transparent;border-color:#2a3c57}
    .layout{display:flex;min-height:0;flex:1}
    .side{width:310px;min-width:260px;max-width:420px;background:var(--panel2);border-right:1px solid #112339;display:flex;flex-direction:column}
    .side.hidden{display:none}
    .map-wrap{flex:1;min-width:0;position:relative}
    #map{position:absolute;inset:0}
    .details{width:360px;min-width:280px;max-width:520px;background:var(--panel2);border-left:1px solid #112339;display:flex;flex-direction:column}
    .details.hidden{display:none}
    .search{
      padding:.6rem;border-bottom:1px solid #10243d;
    }
    .list{overflow:auto;flex:1}
    .item{
      padding:.65rem .8rem;border-bottom:1px solid #0f233a;cursor:pointer;
    }
    .item:hover{background:#12243a}
    .small{color:var(--muted);font-size:.85rem}
    .badge{
      display:inline-block;padding:.1rem .4rem;background:var(--badge);border-radius:.4rem;font-size:.75rem;color:var(--muted);
    }
    .panel-head{padding:.6rem .8rem;border-bottom:1px solid #10243d}
    .photos{display:flex;gap:.6rem;flex-wrap:wrap;padding:.6rem .8rem}
    .thumb{
      width:140px;height:86px;border-radius:.4rem;object-fit:cover;border:1px solid #233246;display:block
    }
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .pill{padding:.15rem .5rem;border-radius:999px;background:#10243d;border:1px solid #22364d;color:#b6c4d6;font-size:.8rem}
    .basemaps{
      position:absolute;right:.6rem;bottom:.6rem;display:flex;gap:.5rem;background:#0e1724;padding:.3rem;border-radius:.6rem;border:1px solid #15273f
    }
    .bm{padding:.35rem .6rem;border-radius:.4rem;background:#152235;border:1px solid #1f3350;cursor:pointer}
    .bm.active{background:#204161;border-color:#2a628f}
    .toggle-left,.toggle-right{display:none}
    @media (max-width:1100px){
      .details{display:none}
      .toggle-right{display:inline-flex}
    }
    @media (max-width:900px){
      .side{display:none}
      .toggle-left{display:inline-flex}
    }
    .cluster-green div{background:#4CAF50;color:white}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <button class="btn toggle-left" id="btnLista">Lista</button>
    <div class="brand">EZ Street MX · Mapa de Bacheo</div>
    <div class="grow"></div>
    <input id="kmlUrl" class="grow" type="text" placeholder="URL del KML (por defecto: baches.kml)" />
    <button class="btn" id="btnUrl">Cargar URL</button>
    <label class="btn">
      <input id="fileKml" type="file" accept=".kml,.kmz" hidden>
      KML local
    </label>
    <button class="btn" id="btnRefresh">Actualizar</button>
    <button class="btn toggle-right" id="btnPanel">Panel</button>
  </div>

  <div class="layout">
    <aside class="side" id="side">
      <div class="search">
        <input id="q" type="text" placeholder="Buscar bache..." />
        <div class="small" id="status" style="margin-top:.35rem">Predeterminado: <span class="badge">baches.kml</span></div>
      </div>
      <div class="list" id="list"></div>
    </aside>

    <main class="map-wrap">
      <div id="map"></div>
      <div class="basemaps">
        <button class="bm active" id="bmSat">Satélite</button>
        <button class="bm" id="bmSt">Calles</button>
      </div>
    </main>

    <aside class="details" id="details">
      <div class="panel-head">
        <div class="row" style="justify-content:space-between">
          <div>
            <div id="dTitle" style="font-weight:700">Selecciona un bache del mapa o de la lista</div>
            <div class="small" id="dCoord"></div>
          </div>
          <div class="row">
            <a class="btn ghost" id="btnMaps" href="#" target="_blank" rel="noopener noreferrer">Ver en Maps</a>
          </div>
        </div>
      </div>
      <div style="padding:.6rem .8rem;border-bottom:1px solid #10243d">
        <div class="small" id="dMeta">Sin datos</div>
      </div>
      <div class="photos" id="photos"></div>
    </aside>
  </div>
</div>

<script>
// ====== Utilidades ======
const qs = (s, el=document)=> el.querySelector(s);
const qsa = (s, el=document)=> Array.from(el.querySelectorAll(s));

// Formato coord
const fmt = (n) => Number(n).toFixed(6);

// Parseo robusto de KML (Points) para Trimble/placemarks
function parseKmlPoints(kmlText){
  const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
  const placemarks = Array.from(xml.getElementsByTagName('Placemark'));
  const features = [];
  placemarks.forEach(pm => {
    const name = (pm.getElementsByTagName('name')[0]?.textContent || '').trim();
    const coordText = pm.getElementsByTagName('coordinates')[0]?.textContent?.trim() || '';
    if(!coordText) return;
    // coordinates are "lon,lat,alt?" possibly with spaces/line breaks
    const [lonStr, latStr] = coordText.split(/[,\s]+/);
    const lon = parseFloat(lonStr), lat = parseFloat(latStr);
    if(isNaN(lat) || isNaN(lon)) return;

    // ExtendedData -> SimpleData
    const ext = {};
    const simps = pm.getElementsByTagName('SimpleData');
    for(const sd of simps){
      const key = sd.getAttribute('name') || '';
      const val = (sd.textContent || '').trim();
      if(key) ext[key] = val;
    }

    // description (tabla HTML con <a>)
    const descHtml = pm.getElementsByTagName('description')[0]?.textContent || '';
    const descDiv = document.createElement('div');
    descDiv.innerHTML = descHtml;
    const links = qsa('a', descDiv).map(a => a.getAttribute('href')).filter(Boolean);

    features.push({
      name, lat, lon,
      props: ext,
      photos: links
    });
  });
  return features;
}

// ====== Mapa ======
let map, cluster, sat, streets;
const side = qs('#side'), details = qs('#details');
const listEl = qs('#list');
const photosEl = qs('#photos');
const dTitle = qs('#dTitle');
const dMeta = qs('#dMeta');
const dCoord = qs('#dCoord');
const btnMaps = qs('#btnMaps');
const statusEl = qs('#status');

function initMap(){
  map = L.map('map', {
    zoomControl: false, // quitamos para UI limpia
    minZoom: 2,
    maxZoom: 20
  }).setView([31.30, -110.94], 13);

  // Controles de zoom a la izquierda como en tu captura
  L.control.zoom({ position:'topleft' }).addTo(map);

  sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom: 20, attribution: '&copy; Esri, Maxar'
  }).addTo(map);

  streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 20, attribution: '&copy; OSM'
  });

  cluster = L.markerClusterGroup({
    disableClusteringAtZoom: 19,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    maxClusterRadius: 40,
    iconCreateFunction: function(c){
      const count = c.getChildCount();
      return L.divIcon({
        html: '<div style="background:#4caf50;color:#fff;border-radius:999px;border:2px solid #2f7f3a;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;">'+count+'</div>',
        className: 'cluster-green',
        iconSize: [32,32]
      });
    }
  });
  map.addLayer(cluster);

  // Base map switch
  qs('#bmSat').onclick = ()=>{ if(!map.hasLayer(sat)){ map.addLayer(sat); map.removeLayer(streets); qs('#bmSat').classList.add('active'); qs('#bmSt').classList.remove('active'); } };
  qs('#bmSt').onclick = ()=>{ if(!map.hasLayer(streets)){ map.addLayer(streets); map.removeLayer(sat); qs('#bmSt').classList.add('active'); qs('#bmSat').classList.remove('active'); } };
}

initMap();

// ====== UI Lista/Panel (colapsables en móvil) ======
qs('#btnLista').onclick = ()=>{
  if(side.classList.contains('hidden')) side.classList.remove('hidden'); else side.classList.add('hidden');
};
qs('#btnPanel').onclick = ()=>{
  if(details.classList.contains('hidden')) details.classList.remove('hidden'); else details.classList.add('hidden');
};

// ====== Carga KML ======
let currentFeatures = [];

function clearAll(){
  cluster.clearLayers();
  listEl.innerHTML = '';
  currentFeatures = [];
}

function addFeaturesToMap(features){
  const markers = [];
  features.forEach((f, idx) => {
    const m = L.marker([f.lat, f.lon], { title: f.name || ('bache_'+(idx+1)) });
    m.on('click', ()=>showDetails(f));
    markers.push(m);

    // item en la lista
    const item = document.createElement('div');
    item.className = 'item';
    item.innerHTML = `<div>${f.name || ('kml_'+(idx+1))}</div>
                      <div class="small">${fmt(f.lat)}, ${fmt(f.lon)}</div>`;
    item.onclick = ()=>{
      map.setView([f.lat, f.lon], Math.max(map.getZoom(), 18));
      m.fire('click');
    };
    listEl.appendChild(item);
  });
  markers.forEach(m => cluster.addLayer(m));

  // Fit al contenido (si hay puntos)
  if(features.length){
    const b = L.latLngBounds(features.map(f=>[f.lat,f.lon]));
    map.fitBounds(b.pad(0.15));
  }
}

function showDetails(f){
  dTitle.textContent = f.name || 'Sin nombre';
  dCoord.textContent = `${fmt(f.lat)}, ${fmt(f.lon)}`;
  btnMaps.href = `https://www.google.com/maps?q=${f.lat},${f.lon}`;

  // Meta a partir de props conocidos
  const metaParts = [];
  const pairs = [
    ['TipodeTrabajo','Tipo'], ['Ancho','Ancho'], ['Largo','Largo'],
    ['Colonia','Colonia'], ['Calle','Calle'], ['Entrecalles','Entre calles'],
    ['Createdon','Creado'], ['Collector','Collector']
  ];
  for(const [key,label] of pairs){
    if(f.props[key]) metaParts.push(`<span class="pill">${label}: ${f.props[key]}</span>`);
  }
  dMeta.innerHTML = metaParts.join(' ') || 'Sin datos';

  // Fotos (3 máx para panel, como tu captura)
  photosEl.innerHTML = '';
  const imgs = f.photos.slice(0,3);
  if(imgs.length){
    imgs.forEach(url=>{
      const a = document.createElement('a');
      a.href = url; a.target = '_blank'; a.rel = 'noopener noreferrer';
      const img = document.createElement('img'); img.className='thumb'; img.loading='lazy'; img.src = url;
      a.appendChild(img);
      photosEl.appendChild(a);
    });
  }
}

// Carga desde URL o ruta
async function loadFromUrl(url){
  try{
    statusEl.innerHTML = 'Cargando: <span class="badge">'+url+'</span>';
    const resp = await fetch(url, {cache:'no-store'});
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    const text = await resp.text();
    clearAll();
    const feats = parseKmlPoints(text);
    currentFeatures = feats;
    addFeaturesToMap(feats);
    statusEl.innerHTML = 'Listo: <span class="badge">'+(url.split('/').pop())+'</span>';
  }catch(err){
    alert('No se pudo cargar el KML: '+err.message);
    console.error(err);
  }
}

// Carga local
qs('#fileKml').addEventListener('change', async (ev)=>{
  const file = ev.target.files[0];
  if(!file) return;
  statusEl.innerHTML = 'Leyendo KML local...';
  const text = await file.text();
  clearAll();
  const feats = parseKmlPoints(text);
  currentFeatures = feats;
  addFeaturesToMap(feats);
  statusEl.innerHTML = 'Listo (local): <span class="badge">'+file.name+'</span>';
});

// Botones
qs('#btnUrl').onclick = ()=>{
  const u = qs('#kmlUrl').value.trim();
  if(u) loadFromUrl(u);
};
qs('#btnRefresh').onclick = ()=>{
  // vuelve a cargar la fuente actual (si viene de URL input usa esa, si no la predeterminada o parámetro data)
  const u = (qs('#kmlUrl').value.trim()) || getDefaultDataUrl();
  loadFromUrl(u);
};

// ====== Búsqueda en lista ======
qs('#q').addEventListener('input', function(){
  const k = this.value.trim().toLowerCase();
  const items = qsa('.item', listEl);
  items.forEach((it, i)=>{
    const text = it.textContent.toLowerCase();
    it.style.display = text.includes(k) ? '' : 'none';
  });
});

// ====== Parámetros ======
function getDefaultDataUrl(){
  const p = new URLSearchParams(location.search);
  const d = p.get('data');
  if(d){
    if(/^https?:/i.test(d)) return d;
    // relativo a la raíz del repo (GitHub Pages)
    return d;
  }
  return 'baches.kml';
}

// Arranque
const initialUrl = getDefaultDataUrl();
qs('#kmlUrl').value = initialUrl;
loadFromUrl(initialUrl);

</script>
</body>
</html>
