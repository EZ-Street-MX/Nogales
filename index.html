<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>EZ Street MX ¬∑ Mapa de Bacheo</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
:root{
  --bg:#0f172a; /* slate-900 */
  --panel:#111827; /* gray-900 */
  --panel-2:#0b1220;
  --txt:#e5e7eb;
  --muted:#9ca3af;
  --accent:#22d3ee;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#000;color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
#app{height:100%;display:flex;flex-direction:column}
/* Top bar */
.toolbar{display:flex;align-items:center;gap:.5rem;padding:.6rem .8rem;background:#0b1220;border-bottom:1px solid #1f2937;white-space:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
.brand{font-weight:700;letter-spacing:.3px;margin-right:.5rem;flex:0 0 auto}
.toolbar input,.toolbar button{background:#0f172a;border:1px solid #334155;color:var(--txt);border-radius:.6rem;padding:.55rem .8rem}
.toolbar button{cursor:pointer}
.toolbar .spacer{flex:1}
#map{flex:1;min-height:0}
/* Panels */
#leftPanel{position:fixed;left:0;top:54px;bottom:0;width:320px;max-width:85vw;background:var(--panel);border-right:1px solid #1f2937;transform:translateX(-100%);transition:transform .25s ease;z-index:800;display:flex;flex-direction:column}
#leftPanel.open{transform:translateX(0)}
#leftPanel header{padding:.6rem .8rem;border-bottom:1px solid #1f2937}
#leftPanel .list{overflow:auto;flex:1}
#leftPanel .item{padding:.75rem .9rem;border-bottom:1px solid #1f2937;cursor:pointer}
#leftPanel .item:hover{background:#0f172a}

#infoPanel{position:fixed;right:0;top:54px;bottom:0;width:380px;max-width:90vw;background:var(--panel);border-left:1px solid #1f2937;transform:translateX(100%);transition:transform .25s ease;z-index:800;overflow:auto}
#infoPanel.open{transform:translateX(0)}
.section{padding:1rem 1rem .75rem}
.photos{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.photo{aspect-ratio:4/3;background:#0f172a;border:1px solid #1f2937;border-radius:.6rem;overflow:hidden}
.photo img{width:100%;height:100%;object-fit:cover;display:block}
.row{display:flex;justify-content:space-between;padding:.45rem .7rem;border:1px solid #1f2937;border-radius:.6rem;background:#0f172a;margin:.35rem 0}
.row label{color:var(--muted)}
.pill{padding:.25rem .5rem;border:1px solid #1f2937;border-radius:.6rem;background:#0f172a}
/* Floating buttons */
.fab{position:fixed;z-index:850;bottom:92px;left:14px}
.fab .btn{display:inline-flex;align-items:center;gap:.5rem;background:#0f172a;border:1px solid #334155;color:var(--txt);padding:.6rem .9rem;border-radius:999px}
.fabR{position:fixed;z-index:850;bottom:92px;right:14px}
/* Marker style (small red dot with white ring) */
.leaflet-interactive.red-dot{stroke:#fff;stroke-width:2}
@media (max-width:820px){
  .brand{font-size:.95rem;line-height:1.1rem;max-width:40vw;white-space:normal}
  .toolbar{gap:.4rem}
  .toolbar input{min-width:46vw}
  #leftPanel{top:64px}
  #infoPanel{top:64px}
  .fab,.fabR{bottom:110px}
  .photos{grid-template-columns:repeat(3, 1fr)}
}
</style>
</head>
<body>
<div id="app">
  <div class="toolbar">
    <div class="brand">EZ Street MX ¬∑ Mapa de Bacheo</div>
    <input id="kmlUrl" placeholder="KML (por defecto: baches.kml)" />
    <button id="loadBtn">Cargar</button>
    <button id="reloadBtn">Actualizar</button>
    <div class="spacer"></div>
  </div>

  <div id="map"></div>

  <!-- Left list -->
  <aside id="leftPanel">
    <header>
      <div style="display:flex;gap:.5rem;align-items:center">
        <button id="closeLeft" class="pill">‚úñ</button>
        <input id="search" placeholder="Buscar bache‚Ä¶" style="flex:1" />
      </div>
    </header>
    <div id="list" class="list"></div>
  </aside>

  <!-- Right info -->
  <aside id="infoPanel">
    <div class="section" style="display:flex;align-items:center;justify-content:space-between">
      <div class="pill" id="title">Baches</div>
      <a id="mapsLink" class="pill" target="_blank" rel="noopener">Ver en Maps</a>
    </div>
    <div class="section">
      <div class="photos">
        <div class="photo"><img id="imgAntes" alt="Antes"></div>
        <div class="photo"><img id="imgRef" alt="Referencia"></div>
        <div class="photo"><img id="imgFinal" alt="Final"></div>
      </div>
    </div>
    <div class="section" id="measures">
      <div class="row" data-key="Ancho"><label>Ancho</label><span id="m_ancho">‚Äî</span></div>
      <div class="row" data-key="Largo"><label>Largo</label><span id="m_largo">‚Äî</span></div>
      <div class="row" data-key="Tipo"><label>Tipo</label><span id="m_tipo">‚Äî</span></div>
      <div class="row" data-key="NumerodeBache"><label># Bache</label><span id="m_nb">‚Äî</span></div>
      <div class="row" data-key="Cadenamiento"><label>Cadenamiento</label><span id="m_cad">‚Äî</span></div>
      <div class="row" data-key="Colonia"><label>Colonia</label><span id="m_col">‚Äî</span></div>
      <div class="row" data-key="Calle"><label>Calle</label><span id="m_calle">‚Äî</span></div>
      <div class="row" data-key="Entrecalles"><label>Entre calles</label><span id="m_entre">‚Äî</span></div>
    </div>
    <div style="height:20px"></div>
  </aside>

  <!-- Floating toggles -->
  <div class="fab"><button id="btnList" class="btn">üìã Lista</button></div>
  <div class="fabR"><button id="btnPanel" class="btn">‚ÑπÔ∏è Panel</button></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script>
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

const map = L.map('map', {
  zoomControl:false,
  preferCanvas:true,
  maxZoom: 22
});
L.control.zoom({ position:'bottomright' }).addTo(map);

const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 22, attribution:'&copy; Esri'
}).addTo(map);

map.setView([31.304, -110.941], 14);

const cluster = L.markerClusterGroup({
  disableClusteringAtZoom: 19,
  spiderfyOnMaxZoom:true,
  showCoverageOnHover:false,
  maxClusterRadius: 36
});
map.addLayer(cluster);

/* UI handlers */
const leftPanel = document.getElementById('leftPanel');
const rightPanel = document.getElementById('infoPanel');
document.getElementById('btnList').onclick = () => leftPanel.classList.toggle('open');
document.getElementById('btnPanel').onclick = () => rightPanel.classList.toggle('open');
document.getElementById('closeLeft').onclick = () => leftPanel.classList.remove('open');

/* Loader */
const kmlInput = document.getElementById('kmlUrl');
const loadBtn = document.getElementById('loadBtn');
const reloadBtn = document.getElementById('reloadBtn');
kmlInput.value = 'baches.kml';
loadBtn.onclick = () => fetchAndLoad(kmlInput.value.trim() || 'baches.kml');
reloadBtn.onclick = () => fetchAndLoad(kmlInput.value.trim() || 'baches.kml');

/* Helpers */
function asNum(x){
  const n = Number(String(x).replace(',','.')); return isFinite(n) ? n : undefined;
}
function setField(id, val, keySel){
  const row = document.querySelector(`.row[data-key="${keySel}"]`);
  if(val === undefined || val === null || String(val).trim()===''){
    row.style.display='none';
  }else{
    row.style.display='flex';
    document.getElementById(id).textContent = val;
  }
}
function proxify(url){
  if(!url) return '';
  url = String(url).trim();
  if(!url) return '';
  url = url.replace(/^http:/,'https:');
  return url;
}
function setImg(el, url){
  if(!url){ el.parentElement.style.display='none'; return; }
  el.parentElement.style.display='block';
  const first = proxify(url);
  el.loading='lazy'; el.referrerPolicy='no-referrer'; el.crossOrigin='anonymous';
  el.src = first;
  el.onerror = () => {
    const prox = 'https://images.weserv.nl/?url='+encodeURIComponent(first.replace(/^https?:\/\//,''));
    el.onerror = null; el.src = prox;
  };
}
/* Populate info */
function showInfo(props, latlng){
  rightPanel.classList.add('open');
  document.getElementById('title').textContent = props.name || 'Baches';
  document.getElementById('mapsLink').href = `https://www.google.com/maps?q=${latlng.lat},${latlng.lng}`;

  setImg(document.getElementById('imgAntes'), props.Fotoantes || props.FotoAntes);
  setImg(document.getElementById('imgRef'), props.FotoReferencia || props.FotoReferencia);
  setImg(document.getElementById('imgFinal'), props.FotoFinal || props.Fotofinal);

  setField('m_ancho', props.Ancho ?? props.anchov, 'Ancho');
  setField('m_largo', props.Largo ?? props.largov, 'Largo');
  setField('m_tipo', props.TipodeTrabajo || props.Tipo || '', 'Tipo');
  setField('m_nb', props.NumerodeBache || '', 'NumerodeBache');
  setField('m_cad', props.Cadenamiento || '', 'Cadenamiento');
  setField('m_col', props.Colonia || '', 'Colonia');
  setField('m_calle', props.Calle || '', 'Calle');
  setField('m_entre', props.EntreCalles || props.Entrecalles || '', 'Entrecalles');
}
/* Build item in list */
const listDiv = document.getElementById('list');
function addListItem(feature, marker){
  const it = document.createElement('div');
  it.className='item';
  const p = feature.properties || {};
  const label = (p.name || 'kml') + (p.Calle? (' ¬∑ '+p.Calle):'');
  it.textContent = label;
  it.onclick = ()=>{
    map.setView(marker.getLatLng(), Math.max(map.getZoom(), 18));
    marker.fire('click'); // open panel
    leftPanel.classList.remove('open');
  };
  listDiv.appendChild(it);
}
/* Create red circle marker */
function redDot(latlng, props){
  const r = isMobile ? 7 : 6;
  const m = L.circleMarker(latlng, {
    radius:r, color:'#ff3b30', weight:2, fillColor:'#ff3b30',
    fillOpacity:.8, className:'red-dot', pane: 'markerPane'
  });
  // Improve touch hitbox
  const hit = L.circle(latlng, {radius:3, stroke:false, fill:false}); // no draw, just for touch fallback
  m.on('click', () => showInfo(props, latlng));
  m.on('touchstart', () => showInfo(props, latlng));
  return m;
}

/* Fetch KML and render */
async function fetchAndLoad(url){
  try{
    const res = await fetch(url + (url.includes('?') ? '&' : '?') + 't=' + Date.now());
    if(!res.ok){ throw new Error(res.statusText); }
    const text = await res.text();
    const xml = new DOMParser().parseFromString(text, 'text/xml');
    const gj = toGeoJSON.kml(xml);
    cluster.clearLayers();
    listDiv.innerHTML='';

    const geo = gj.features || [];
    const group = L.featureGroup();

    geo.forEach(f => {
      if(!f.geometry) return;
      let latlng;
      if(f.geometry.type === 'Point'){
        latlng = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
      }else if(f.geometry.type === 'LineString'){
        const c = f.geometry.coordinates[0];
        latlng = L.latLng(c[1], c[0]);
      }else return;

      const marker = redDot(latlng, f.properties||{});
      cluster.addLayer(marker);
      addListItem(f, marker);
      group.addLayer(marker);
    });

    if(group.getLayers().length){ map.fitBounds(group.getBounds().pad(0.2)); }
  }catch(e){
    console.error(e);
    alert('No se pudo cargar el KML');
  }
}

fetchAndLoad('baches.kml');

/* Search */
document.getElementById('search').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  [...listDiv.children].forEach(n => {
    n.style.display = n.textContent.toLowerCase().includes(q) ? 'block' : 'none';
  });
});
</script>
</body>
</html>
