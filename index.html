<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EZ Street MX · Mapa de Bacheo (panel + clusters)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--sub:#94a3b8;--border:#223046}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial}
  #layout{position:fixed;inset:0;display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:auto 1fr;transition:grid-template-columns .2s ease}
  header{grid-column:1/4;display:flex;gap:8px;align-items:center;padding:8px 10px;background:#0b1220;border-bottom:1px solid var(--border)}
  .title{font-weight:700;color:#c7d2fe;margin-right:auto}
  .btn{background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 12px;cursor:pointer}
  .inp{background:#0b1220;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;min-width:240px}
  #left{border-right:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;overflow:hidden}
  #list{overflow:auto}
  .item{padding:10px 12px;border-bottom:1px solid #0b1220;cursor:pointer}
  .item:hover{background:#0b162a}
  .item small{display:block;color:var(--sub)}
  #map{width:100%;height:100%}
  #right{border-left:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;overflow:hidden}
  #info{padding:12px;overflow:auto}
  .h{font-weight:700;margin:8px 0 6px 0}
  .kv{margin:4px 0;color:var(--sub)}
  .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .thumbs a img{width:108px;height:72px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
  .chips{display:flex;gap:6px;margin-top:8px}
  .chip{background:#0b1220;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--sub)}
  .sec{padding:10px;border-bottom:1px solid #0b1220}
  .pill{background:#0b1220;border:1px solid var(--border);padding:4px 8px;border-radius:6px;font-size:12px;color:var(--sub)}
  .muted{color:var(--sub)}
  /* Collapsed states */
  .left-collapsed #layout{grid-template-columns:0 1fr 360px}
  .left-collapsed #left{display:none}
  .right-collapsed #layout{grid-template-columns:320px 1fr 0}
  .right-collapsed #right{display:none}
  /* Floating open buttons */
  .float-btn{position:fixed;top:64px;z-index:5000;background:#0b1220;border:1px solid var(--border);color:#e5e7eb;border-radius:8px;padding:8px 10px;cursor:pointer}
  #openLeft{left:8px;display:none}
  #openRight{right:8px;display:none}
  .left-collapsed #openLeft{display:block}
  .right-collapsed #openRight{display:block}
  @media (max-width: 900px){
    #layout{grid-template-columns:260px 1fr 0}
    #right{display:none}
  }
</style>
</head>
<body>
<div id="layout">
  <header>
    <button id="toggleLeft" class="btn" title="Mostrar/ocultar lista">☰ Lista</button>
    <div class="title">EZ Street MX · Mapa de Bacheo</div>
    <input id="inUrl" class="inp" placeholder="URL del KML (por defecto: baches.kml)">
    <button id="btnUrl" class="btn">Cargar URL</button>
    <label class="btn">KML local<input id="file" type="file" accept=".kml,.kmz" style="display:none"></label>
    <button id="btnReload" class="btn">Actualizar</button>
    <button id="toggleRight" class="btn" title="Mostrar/ocultar panel">ℹ️ Panel</button>
  </header>

  <aside id="left">
    <div class="sec">
      <input id="q" class="inp" placeholder="Buscar bache…">
      <div class="chips">
        <span class="chip" id="countChip">Listo: 0</span>
      </div>
    </div>
    <div id="list"></div>
  </aside>

  <div id="map"></div>

  <aside id="right">
    <div class="sec muted">Selecciona un bache del mapa o de la lista</div>
    <div id="info"></div>
  </aside>
</div>

<button id="openLeft" class="float-btn">▶ Lista</button>
<button id="openRight" class="float-btn">Panel ◀</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ---- UI: collapse & persist ----
const LS = window.localStorage;
function setCollapsed(which, v){
  const cls = which==='left' ? 'left-collapsed' : 'right-collapsed';
  document.body.classList.toggle(cls, v);
  LS.setItem('collapse:'+which, v?'1':'0');
  setTimeout(()=>map.invalidateSize(), 210);
}
function restoreCollapsed(){
  setCollapsed('left',  LS.getItem('collapse:left')==='1');
  setCollapsed('right', LS.getItem('collapse:right')==='1');
}
document.getElementById('toggleLeft').onclick = ()=> setCollapsed('left', !document.body.classList.contains('left-collapsed'));
document.getElementById('toggleRight').onclick= ()=> setCollapsed('right',!document.body.classList.contains('right-collapsed'));
document.getElementById('openLeft').onclick  = ()=> setCollapsed('left', false);
document.getElementById('openRight').onclick = ()=> setCollapsed('right', false);

// ---- MAPA ----
const map = L.map('map', {preferCanvas:true}).setView([31.31,-110.94], 13);
const lyrSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom:19}).addTo(map);
const lyrOsm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:20});
L.control.layers({'Satélite':lyrSat,'Calles':lyrOsm}).addTo(map);

// ---- ESTADO ----
const qs = new URLSearchParams(location.search);
let currentURL = qs.get('data') || LS.getItem('kml:url') || 'baches.kml';
document.getElementById('inUrl').value = currentURL;
let features = []; // {t:'Point'|'Line'|'Poly', c: coords, p: props, id, center}
let cluster = L.markerClusterGroup({showCoverageOnHover:false, disableClusteringAtZoom:18, maxClusterRadius:40});
let lines = L.featureGroup();
let polys = L.featureGroup();
cluster.addTo(map); lines.addTo(map); polys.addTo(map);

function resetLayers(){ cluster.clearLayers(); lines.clearLayers(); polys.clearLayers(); }

// ---- PARSER KML ----
function parseKml(txt){
  const feats=[]; let id=0;
  const placemarks = txt.match(/<Placemark[\s\S]*?<\/Placemark>/gi) || [];
  for(const block of placemarks){
    const p={};
    block.replace(/<SimpleData[^>]*name="([^"]+)"[^>]*>([\s\S]*?)<\/SimpleData>/gi,(a,n,v)=>{p[n]=v.replace(/<[^>]*>/g,'').trim();});
    const nm = block.match(/<name>([\s\S]*?)<\/name>/i); if(nm) p.name = nm[1].trim();
    const pts = block.match(/<Point>[\s\S]*?<\/Point>/gi) || [];
    for(const pt of pts){ const m = pt.match(/<coordinates>([^<]+)<\/coordinates>/i); if(m){const a=m[1].trim().split(',').map(Number); if(a.length>=2) feats.push({id:++id,t:'Point',c:[a[1],a[0]],p});}}
    const lns = block.match(/<LineString>[\s\S]*?<\/LineString>/gi) || [];
    for(const ln of lns){ const m = ln.match(/<coordinates>([^<]+)<\/coordinates>/i); if(m){const arr=m[1].trim().split(/\s+/).map(s=>s.split(',').map(Number)).filter(a=>a.length>=2).map(a=>[a[1],a[0]]); if(arr.length>1) feats.push({id:++id,t:'Line',c:arr,p});}}
    const polys = block.match(/<Polygon>[\s\S]*?<\/Polygon>/gi) || [];
    for(const pg of polys){ const m = pg.match(/<outerBoundaryIs>[\s\S]*?<LinearRing>[\s\S]*?<coordinates>([^<]+)<\/coordinates>[\s\S]*?<\/LinearRing>[\s\S]*?<\/outerBoundaryIs>/i); if(m){const arr=m[1].trim().split(/\s+/).map(s=>s.split(',').map(Number)).filter(a=>a.length>=2).map(a=>[a[1],a[0]]); if(arr.length>2) feats.push({id:++id,t:'Poly',c:[arr],p});}}
  }
  for(const f of feats){
    if(f.t==='Point') f.center=f.c;
    else{ const lyr=f.t==='Line'?L.polyline(f.c):L.polygon(f.c); f.center=lyr.getBounds().getCenter(); }
  }
  return feats;
}

// ---- DIBUJO + PANEL ----
function draw(){
  resetLayers();
  for(const f of features){
    if(f.t==='Point'){
      const m=L.marker(f.c).on('click',()=>showPanel(f));
      cluster.addLayer(m);
    }else if(f.t==='Line'){
      L.polyline(f.c,{color:'#38bdf8',weight:6,opacity:.85}).on('click',()=>showPanel(f)).addTo(lines);
    }else if(f.t==='Poly'){
      L.polygon(f.c,{color:'#22c55e',weight:2,fillOpacity:.25}).on('click',()=>showPanel(f)).addTo(polys);
    }
  }
  const g=L.featureGroup([cluster,lines,polys]); try{const b=g.getBounds(); if(b.isValid()) map.fitBounds(b.pad(.15));}catch(_){}
  buildList();
  document.getElementById('countChip').textContent='Listo: '+features.length;
}
function field(p, names){ for(const n of names){ if(p[n]) return p[n]; } return ''; }
function photosFromProps(p){
  const keys=['Fotoantes','FotoAntes','fotoantes','Foto Referencia','FotoReferencia','Foto Final','FotoFinal'];
  const out=[]; for(const k of keys){ if(p[k]){const m=String(p[k]).match(/https?:\/\/[^\s"'<>\)]+/); if(m) out.push(m[0]); } } return out;
}
function showPanel(f){
  const p=f.p||{};
  const tipo=field(p,['TipodeTrabajo','Tipo','tipo']);
  const ancho=field(p,['Ancho','ancho']); const largo=field(p,['Largo','largo']);
  const colonia=field(p,['Colonia','colonia']); const calle=field(p,['Calle','calle']);
  const fotos=photosFromProps(p);
  const coord=f.center?(f.center.lat.toFixed(6)+', '+f.center.lng.toFixed(6)):'';
  document.getElementById('info').innerHTML=`
    <div class="h">${p.name||'Bache'}</div>
    ${tipo?`<div class="kv"><b>Tipo:</b> ${tipo}</div>`:''}
    ${ancho?`<div class="kv"><b>Ancho:</b> ${ancho}</div>`:''}
    ${largo?`<div class="kv"><b>Largo:</b> ${largo}</div>`:''}
    ${colonia?`<div class="kv"><b>Colonia:</b> ${colonia}</div>`:''}
    ${calle?`<div class="kv"><b>Calle:</b> ${calle}</div>`:''}
    ${coord?`<div class="kv"><b>Coord:</b> ${coord}</div>`:''}
    ${fotos.length?`<div class="h">Fotos</div><div class="thumbs">${fotos.map(u=>`<a href="${u}" target="_blank"><img src="${u}"></a>`).join('')}</div>`:''}
    <div class="h"></div>
    <a class="btn" target="_blank" href="https://www.google.com/maps?q=${f.center.lat},${f.center.lng}">Ver en Maps</a>
  `;
  // asegúrate de que el panel esté visible si estaba colapsado
  setCollapsed('right', false);
}

// ---- LISTA y BUSCADOR ----
function buildList(){
  const box=document.getElementById('list'); box.innerHTML='';
  const q=document.getElementById('q').value.trim().toLowerCase();
  const data=!q?features:features.filter(f=>{
    const p=f.p||{}; const hay=(p.name||'')+' '+(p.Calle||'')+' '+(p.Colonia||'')+' '+JSON.stringify(p);
    return hay.toLowerCase().includes(q);
  });
  for(const f of data){
    const p=f.p||{}; const it=document.createElement('div'); it.className='item';
    const subtitle=f.center?f.center.lat.toFixed(6)+', '+f.center.lng.toFixed(6):'';
    it.innerHTML=`<div>${p.name||('kml_'+f.id)}</div><small>${subtitle||f.t}</small>`;
    it.onclick=()=>{
      showPanel(f);
      if(f.t==='Point') map.setView(f.center,19);
      else{ const lyr=f.t==='Line'?L.polyline(f.c):L.polygon(f.c); map.fitBounds(lyr.getBounds().pad(.2)); }
    };
    box.appendChild(it);
  }
}
document.getElementById('q').addEventListener('input', buildList);

// ---- CARGA ----
async function loadURL(u){
  try{
    const res=await fetch(u+(u.includes('?')?'&':'?')+'t='+Date.now());
    if(!res.ok) throw new Error('HTTP '+res.status);
    const txt=await res.text();
    features=parseKml(txt);
    draw();
  }catch(e){ alert('No se pudo cargar el KML: '+e.message); }
}
document.getElementById('btnUrl').onclick=()=>{
  const u=document.getElementById('inUrl').value.trim();
  if(u){ currentURL=u; localStorage.setItem('kml:url',u); loadURL(currentURL); }
};
document.getElementById('btnReload').onclick=()=> loadURL(currentURL);
document.getElementById('file').addEventListener('change',async ev=>{
  const f=ev.target.files[0]; if(!f) return; const txt=await f.text(); features=parseKml(txt); draw();
});

// init
restoreCollapsed();
loadURL(currentURL);
</script>
</body>
</html>
