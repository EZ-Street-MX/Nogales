<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa de Bacheo · Satélite (rápido)</title>
  <meta name="description" content="Mapa satelital optimizado: carga rápida de KML/KMZ, clúster en chunks, marcadores ligeros, panel de detalle." />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://server.arcgisonline.com" crossorigin>
  <link rel="preconnect" href="https://{s}.tile.openstreetmap.org" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --panel-2:#111827; --text:#e5e7eb; --muted:#94a3b8; --brand:#00a0e3; --accent:#22d3ee; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased; }
    .app{display:grid;grid-template-rows:auto 1fr; height:100%}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px;background:#0d1726;border-bottom:1px solid rgba(255,255,255,.06)}
    .controls{display:flex;flex-wrap:wrap; gap:8px; align-items:center}
    input[type="url"]{background:var(--panel-2); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:8px 10px; border-radius:10px; min-width:320px}
    .btn{background:#15223a; color:var(--text); border:1px solid rgba(255,255,255,.12); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:hover{background:#1b2b4b}
    .layout{display:grid; grid-template-columns: 360px 1fr 420px; height:100%; min-height:0;}
    .sidebar{background:var(--panel); border-right:1px solid rgba(255,255,255,.06); display:flex; flex-direction:column; min-width:0}
    .side-head{padding:12px; border-bottom:1px solid rgba(255,255,255,.06);}
    .search{width:100%; background:var(--panel-2); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:9px 12px; border-radius:10px}
    .list{overflow:auto; min-height:0}
    .item{padding:12px; border-bottom:1px dashed rgba(255,255,255,.06); cursor:pointer}
    .item:hover{background:rgba(255,255,255,.04)}
    .item h4{margin:0 0 6px; font-size:14px}
    .item .muted{color:var(--muted); font-size:12px}
    #map{height:100%; width:100%}
    .leaflet-container{background:#000}
    .detail{background:var(--panel); border-left:1px solid rgba(255,255,255,.06); display:flex; flex-direction:column; min-width:0; min-height:0}
    .detail-head{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid rgba(255,255,255,.06)}
    .detail-body{padding:12px; overflow:auto; min-height:0}
    .field{display:grid; grid-template-columns: 140px 1fr; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.06)}
    .field b{color:#cbd5e1}
    .gallery{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:8px}
    .thumb{width:100%; aspect-ratio:4/3; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,.08); cursor:pointer; background:#0b1220}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; background:rgba(34,211,238,.15); color:#67e8f9; border:1px solid rgba(34,211,238,.3)}
    .footer{padding:8px 12px; border-top:1px solid rgba(255,255,255,.06); color:var(--muted); font-size:12px; display:flex; gap:10px; justify-content:space-between}
    .toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#111827;color:#fff;border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:10px;z-index:2000;display:none}
    .toast.show{display:block}
    .bm{position:absolute; right:12px; bottom:12px; z-index:1200; background:#111827d0; padding:8px; border-radius:12px; display:flex; gap:8px; border:1px solid rgba(255,255,255,.1)}
    .bm .btn{padding:6px 10px}
    .coord-chip{cursor:pointer;margin-left:8px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:3000}
    .modal.open{display:flex}
    .modal img{max-width:92vw; max-height:92vh; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.6)}
    /* ultra-ligeros: marcadores como puntos rojos via divIcon */
    .dot{width:10px;height:10px;border-radius:50%;background:#ff2d2d;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25)}
    @media (max-width:1200px){ .layout{grid-template-columns: 1fr 1fr} .sidebar{display:none} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="font-weight:700">Mapa de Bacheo · Satélite (rápido)</div>
      <div class="controls">
        <input id="dataUrl" type="url" placeholder="URL pública del KML/KMZ/GeoJSON (RAW de GitHub, etc.)" />
        <button class="btn" id="btnLoadUrl">Cargar URL</button>
        <input id="fileInput" type="file" accept=".kml,.kmz,.geojson,.json" hidden>
        <button class="btn" id="btnPickFile">KML local</button>
        <button class="btn" id="btnRefresh">Actualizar</button>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="side-head">
          <input id="search" class="search" type="text" placeholder="Buscar bache..." />
        </div>
        <div id="list" class="list"></div>
        <div class="footer">
          <span id="status">Listo.</span>
          <span class="badge" id="count">0</span>
        </div>
      </aside>
      <main id="map"></main>
      <aside class="detail" id="detail">
        <div class="detail-head">
          <div>
            <div id="d-title" style="font-weight:700">Selecciona un bache</div>
            <div id="d-sub" class="badge coord-chip" title="Copiar coordenadas">—</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn" id="btnZoom20">Zoom 20</button>
            <a id="d-gmaps" href="#" target="_blank" rel="noopener" class="btn">Ver en Maps</a>
          </div>
        </div>
        <div class="detail-body">
          <div id="d-fields"></div>
          <div style="margin-top:10px">
            <div style="font-weight:700;margin-bottom:6px">Fotos</div>
            <div id="d-gallery" class="gallery"><em>Sin fotos</em></div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="modal" id="modal"><img id="modal-img" alt="foto"/></div>

  <div class="bm">
    <button class="btn" id="bmSat">Satélite</button>
    <button class="btn" id="bmStreets">Calles</button>
  </div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>
  <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.umd.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>

  <script>
    window.addEventListener('load', () => { // esperar a que estén las libs (defer)
      const $ = (s,p=document)=>p.querySelector(s);
      const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
      const statusEl = $('#status'); const countEl = $('#count'); const toast = $('#toast');
      const storeKey = 'ezstreet_baches_data_url';
      const getParam = k => new URLSearchParams(location.search).get(k);
      const showToast = msg => { toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); };

      // Basemaps en alta definición + retina
      const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { detectRetina:true, maxZoom: 20, maxNativeZoom: 19, attribution: 'Imagery &copy; Esri' });
      const labels = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}.png', { detectRetina:true, maxZoom: 20, attribution: '&copy; CARTO' });
      const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { detectRetina:true, maxZoom: 20, maxNativeZoom: 19, attribution: '&copy; OpenStreetMap' });

      const map = L.map('map', { preferCanvas:true, updateWhenIdle:true, zoomAnimation:true, fadeAnimation:true, markerZoomAnimation:true, minZoom:2, maxZoom:20, zoomControl:true, layers:[sat, labels] }).setView([31.307, -110.948], 19);
      L.control.scale({imperial:false}).addTo(map);

      $('#bmSat').onclick = ()=>{ map.eachLayer(l=>map.removeLayer(l)); sat.addTo(map); labels.addTo(map); };
      $('#bmStreets').onclick = ()=>{ map.eachLayer(l=>map.removeLayer(l)); streets.addTo(map); };

      const cluster = L.markerClusterGroup({
        showCoverageOnHover:false, spiderfyOnEveryZoom:false,
        maxClusterRadius: 40, disableClusteringAtZoom: 18,
        chunkedLoading:true, chunkDelay: 30, chunkInterval: 200,
        chunkProgress: (processed, total, elapsed) => { statusEl.textContent = `Procesando: ${processed} / ${total}`; if(processed===total) statusEl.textContent='Datos cargados.'; }
      }).addTo(map);

      // Marcador ultra-ligero por divIcon
      const dotIcon = L.divIcon({ className:'dot', iconSize:[10,10] });

      let markers = [];

      function escapeHtml(s){return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}

      const FIELD_WHITELIST = [
        'Tipo de Trabajo','Número de Bache','Numero de Bache','Ancho','Largo','Profundidad','Colonia','Calle','Entre calles','Calificación','Calificación km','Calificacion','Calificacion km','Cuadrilla','Fecha','Persona','Responsable'
      ];
      const IMAGE_LABELS = ['Foto antes','Foto Referencia','Foto Final','Foto antes:','Foto Referencia:','Foto Final:'];

      function parseDescriptionToFields(html){
        const out = { fields: {}, images: [] };
        if(!html) return out;
        const div = document.createElement('div'); div.innerHTML = html;

        const lines = (div.textContent||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
        for(let i=0;i<lines.length;i++){
          const line = lines[i];
          for(const lbl of FIELD_WHITELIST){
            const cleanLbl = lbl.toLowerCase();
            const lower = line.toLowerCase();
            if(lower === cleanLbl){ const val = (lines[i+1]||'').trim(); if(val) out.fields[lbl] = val; }
            const m = line.match(new RegExp('^'+lbl.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'\s*:?\s*(.+)$','i'));
            if(m) out.fields[lbl] = m[1].trim();
          }
        }

        IMAGE_LABELS.forEach(lbl => {
          const el = Array.from(div.querySelectorAll('*')).find(n => (n.textContent||'').trim().toLowerCase() === lbl.replace(':','').toLowerCase());
          if(el){
            const img = el.closest('div')?.querySelector('img') || el.parentElement?.querySelector('img');
            if(img && img.src) out.images.push({ label: lbl.replace(':',''), url: img.src });
          }
        });
        if(out.images.length===0){ Array.from(div.querySelectorAll('img')).forEach(img => { if(img.src) out.images.push({ label: '', url: img.src }); }); }

        return out;
      }

      function pickFieldsFromProps(props){
        const out = {};
        if(!props) return out;
        for(const k of Object.keys(props)){
          const found = FIELD_WHITELIST.find(lbl => lbl.toLowerCase() === k.toLowerCase());
          if(found && props[k] != null && String(props[k]).trim().length>0) out[found] = String(props[k]).trim();
        }
        return out;
      }

      function buildFieldsView(fields){
        const pairs = [];
        const ORDER = ['Tipo de Trabajo','Número de Bache','Numero de Bache','Ancho','Largo','Profundidad','Colonia','Calle','Entre calles','Calificación','Calificación km','Calificacion','Calificacion km','Cuadrilla','Fecha','Persona','Responsable'];
        ORDER.forEach(k => { if(fields[k]) pairs.push([k, fields[k]]); });
        if(pairs.length===0) return '<em>Sin datos</em>';
        return pairs.map(([k,v]) => `<div class="field"><b>${escapeHtml(k)}</b><div>${escapeHtml(v)}</div></div>`).join('');
      }

      function setDetail(marker){
        const p = marker._meta.props || {};
        const name = marker._meta.name || 'Bache';
        $('#d-title').textContent = name;
        const lat = marker._meta.latlng.lat.toFixed(6), lng = marker._meta.latlng.lng.toFixed(6);
        $('#d-sub').textContent = lat + ', ' + lng;
        $('#d-sub').onclick = ()=>{ navigator.clipboard.writeText(lat+', '+lng).then(()=>showToast('Coordenadas copiadas')); };
        $('#btnZoom20').onclick = ()=> map.setView(marker._meta.latlng, 20);
        $('#d-gmaps').href = `https://www.google.com/maps?q=${marker._meta.latlng.lat},${marker._meta.latlng.lng}`;

        const fromProps = pickFieldsFromProps(p);
        const desc = p.description || p.Description || '';
        const parsed = parseDescriptionToFields(desc);
        const merged = Object.assign({}, parsed.fields, fromProps);
        $('#d-fields').innerHTML = buildFieldsView(merged);

        const g = $('#d-gallery');
        const imgs = parsed.images;
        if(imgs.length){
          g.innerHTML = imgs.map(im=>`<img class="thumb" src="${im.url}" alt="foto">`).join('');
          $$('#d-gallery .thumb').forEach(img => img.onclick = ()=>{ $('#modal-img').src = img.src; $('#modal').classList.add('open'); });
          $('#modal').onclick = ()=> $('#modal').classList.remove('open');
        } else { g.innerHTML = '<em>Sin fotos</em>'; }
      }

      function clearData(){ cluster.clearLayers(); markers=[]; $('#list').innerHTML=''; countEl.textContent='0'; statusEl.textContent='Listo.'; }

      function indexMarkersFromGeoJSON(geojson){
        clearData();
        const temp = [];
        const gj = L.geoJSON(geojson, {
          pointToLayer: (f, latlng) => { // divIcon ultra-ligero
            const name = f.properties?.name || f.properties?.Name || 'Bache';
            const m = L.marker(latlng, { icon: dotIcon, title: name });
            m._meta = { name, latlng, props: f.properties || {} };
            m.on('click', ()=> setDetail(m));
            temp.push(m);
            return m;
          }
        });
        temp.forEach(m => cluster.addLayer(m));
        markers = temp;
        if(markers.length){ try{ map.fitBounds(L.featureGroup(markers).getBounds().pad(0.12)); }catch(e){} }
        $('#list').innerHTML = markers.map((m,i)=>`<div class="item" data-i="${i}"><h4>${escapeHtml(m._meta.name)}</h4><div class="muted">${m._meta.latlng.lat.toFixed(6)}, ${m._meta.latlng.lng.toFixed(6)}</div></div>`).join('');
        $$('#list .item').forEach(el=> el.onclick = ()=>{ const i = +el.dataset.i; const mk = markers[i]; setDetail(mk); map.setView(mk.getLatLng(), 20); });
        countEl.textContent = String(markers.length);
        statusEl.textContent = 'Datos cargados.';
      }

      async function fetchArrayBuffer(url){ const bust = url + (url.includes('?')?'&':'?') + '_=' + Date.now(); const res = await fetch(bust); if(!res.ok) throw new Error('No se pudo descargar'); return await res.arrayBuffer(); }
      async function fetchText(url){ const bust = url + (url.includes('?')?'&':'?') + '_=' + Date.now(); const res = await fetch(bust); if(!res.ok) throw new Error('No se pudo descargar'); return await res.text(); }

      async function loadFromUrl(url){
        try{ statusEl.textContent = 'Cargando datos...';
          if(/\.kmz$/i.test(url)){
            const buf = await fetchArrayBuffer(url);
            const zip = await JSZip.loadAsync(buf);
            const kmlFile = Object.values(zip.files).find(f => /\.kml$/i.test(f.name));
            if(!kmlFile) throw new Error('KMZ sin KML interno');
            const kmlText = await kmlFile.async('text');
            const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
            const gj = toGeoJSON.kml(xml);
            indexMarkersFromGeoJSON(gj);
          } else if(/\.kml$/i.test(url)){ 
            const text = await fetchText(url);
            const xml = new DOMParser().parseFromString(text, 'text/xml');
            const gj = toGeoJSON.kml(xml);
            indexMarkersFromGeoJSON(gj);
          } else { // GeoJSON
            const text = await fetchText(url);
            const gj = JSON.parse(text);
            indexMarkersFromGeoJSON(gj);
          }
        }catch(err){ console.error(err); showToast('No se pudo cargar: '+err.message); statusEl.textContent='Error.'; }
      }

      async function loadLocalFile(file){
        statusEl.textContent = 'Importando archivo...';
        const ext = file.name.split('.').pop().toLowerCase();
        try{
          if(ext==='kmz'){
            const buf = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(buf);
            const kmlFile = Object.values(zip.files).find(f => /\.kml$/i.test(f.name));
            if(!kmlFile) throw new Error('KMZ sin KML interno');
            const kmlText = await kmlFile.async('text');
            const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
            const gj = toGeoJSON.kml(xml);
            indexMarkersFromGeoJSON(gj);
          } else if(ext==='kml'){ 
            const text = await file.text();
            const xml = new DOMParser().parseFromString(text, 'text/xml');
            const gj = toGeoJSON.kml(xml);
            indexMarkersFromGeoJSON(gj);
          } else { // geojson
            const text = await file.text();
            const gj = JSON.parse(text);
            indexMarkersFromGeoJSON(gj);
          }
        }catch(err){ console.error(err); showToast('No se pudo importar: '+err.message); statusEl.textContent='Error.'; }
      }

      // Eventos UI
      $('#btnPickFile').onclick = ()=> $('#fileInput').click();
      $('#fileInput').onchange = e => e.target.files[0] && loadLocalFile(e.target.files[0]);
      $('#btnLoadUrl').onclick = ()=> { const u=$('#dataUrl').value.trim(); if(!u){ showToast('Pega la URL pública'); return; } localStorage.setItem(storeKey,u); loadFromUrl(u); };
      $('#btnRefresh').onclick = ()=> { const u=$('#dataUrl').value.trim() || localStorage.getItem(storeKey) || getParam('data') || 'https://raw.githubusercontent.com/gerardo0503/Nogales/main/baches.kml'; loadFromUrl(u); };
      $('#search').oninput = e => { const q = e.target.value.trim().toLowerCase(); $$('#list .item').forEach(el=> { const t = el.querySelector('h4').textContent.toLowerCase(); el.style.display = t.includes(q)?'block':'none'; }); };

      // Autocarga por ?data= o KML por defecto
      (function init(){ const url = getParam('data') || 'https://raw.githubusercontent.com/gerardo0503/Nogales/main/baches.kml'; $('#dataUrl').value = url; loadFromUrl(url); })();
    });
  </script>
</body>
</html>
