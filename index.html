<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>EZ Street MX · Mapa de Bacheo</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
:root{
  --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --chip:#1f2937;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#0b1220;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
header{
  display:flex;gap:.5rem;align-items:center;padding:.5rem .75rem;border-bottom:1px solid #1e293b;background:linear-gradient(to bottom,#0b1220,#0f172a);
  position:sticky;top:0;z-index:1000;
}
h1{font-size:1rem;margin:0;font-weight:600;letter-spacing:.2px;color:#e2e8f0}
input[type="text"]{width:min(520px,55vw);padding:.55rem .7rem;border:1px solid #243244;background:#0b1220;color:var(--text);border-radius:.5rem;outline:none;}
button,.btn{background:#111827;border:1px solid #263247;color:#e5e7eb;padding:.55rem .8rem;border-radius:.55rem;cursor:pointer;}
button:hover{border-color:#334155}
.btn-ghost{background:transparent;border-color:#1e293b}
.badge{background:var(--chip);border:1px solid #1f2a3a;color:#cbd5e1;border-radius:999px;padding:.25rem .5rem;font-size:.8rem}
.container{display:grid;grid-template-columns:320px 1fr 380px;gap:.75rem; height: calc(100vh - 60px);}
#left,#right{background:var(--panel);border-left:1px solid #1f2a37;border-right:1px solid #1f2a37;overflow:auto}
#map{height:100%;width:100%;background:#000}
#left{padding:.5rem}
#right{padding:.75rem}
.item{padding:.5rem;border-bottom:1px solid #1c2434;cursor:pointer}
.item:hover{background:#0f1626}
.item .name{font-weight:600}
.item .sub{color:var(--muted);font-size:.85rem}
.hidden{display:none!important}
.handle{position:absolute;top:50%;transform:translateY(-50%);width:14px;height:64px;background:#0b1220;border:1px solid #1f2a37;border-radius:0 .5rem .5rem 0;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:.7}
#left-handle{right:-14px}
#right-handle{left:-14px;border-radius:.5rem 0 0 .5rem}
/* red dot marker */
.red-dot{width:10px;height:10px;background:#ef4444;border-radius:999px;border:2px solid #111827;box-shadow:0 0 0 1px #ef4444aa}
.leaflet-div-icon{background:transparent;border:0}
@media (max-width:1100px){
  .container{grid-template-columns:1fr;grid-template-rows:auto 1fr auto; height:auto}
  #left{order:1;height:280px}
  #map{order:2;height:calc(100vh - 60px)}
  #right{order:3}
  .handle{display:none}
  input[type=text]{width:52vw}
}
</style>
</head>
<body>
<header>
  <h1>EZ Street MX · Mapa de Bacheo</h1>
  <div style="flex:1"></div>
  <input id="kmlUrl" type="text" placeholder="KML (por defecto: baches.kml)" />
  <button id="btnLoad">Cargar</button>
  <label class="btn" style="position:relative;overflow:hidden">
    <input id="fileInput" type="file" accept='.kml,.kmz' style="position:absolute;inset:0;opacity:0;cursor:pointer">
    KML local
  </label>
  <button id="btnRefresh" class="btn-ghost">Actualizar</button>
</header>

<div class="container" id="container">
  <div id="left">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
      <button id="btnToggleLeft" class="btn">☰ Lista</button>
      <span id="srcChip" class="badge">—</span>
      <span id="countChip" class="badge">Listo: 0</span>
    </div>
    <input id="search" type="text" placeholder="Buscar bache…" style="width:100%;margin:.5rem 0">
    <label style="display:flex;gap:.5rem;align-items:center;font-size:.9rem;color:#9fb2c8">
      <input type="checkbox" id="autoHideList"> Ocultar lista al seleccionar
    </label>
    <hr style="border:0;border-top:1px solid #1c2434;margin:.5rem 0">
    <div id="list"></div>
    <div id="left-handle" class="handle">❯</div>
  </div>

  <div id="map"></div>

  <div id="right">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.5rem">
      <button id="btnToggleRight" class="btn">ℹ️ Panel</button>
      <a id="btnMaps" class="btn" href="#" target="_blank" rel="noopener">Ver en Maps</a>
    </div>
    <div class="card">
      <div style="font-size:.85rem;color:#9fb2c8;margin-bottom:.4rem">FOTOS</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem">
        <a class="thumb" id="img0" target="_blank" rel="noopener"><span style="color:#64748b">Antes</span></a>
        <a class="thumb" id="img1" target="_blank" rel="noopener"><span style="color:#64748b">Referencia</span></a>
        <a class="thumb" id="img2" target="_blank" rel="noopener"><span style="color:#64748b">Final</span></a>
      </div>
    </div>
    <div style="height:.75rem"></div>
    <div class="card">
      <div style="font-size:.85rem;color:#9fb2c8;margin-bottom:.4rem">MEDIDAS</div>
      <div style="display:grid;grid-template-columns:120px 1fr;gap:.35rem .75rem;align-items:center">
        <div class="k">Ancho</div><div id="vAncho">—</div>
        <div class="k">Largo</div><div id="vLargo">—</div>
        <div class="k">Tipo</div><div id="vTipo">—</div>
        <div class="k"># Bache</div><div id="vNum">—</div>
        <div class="k">Cadenamiento</div><div id="vCad">—</div>
        <div class="k">Colonia</div><div id="vCol">—</div>
        <div class="k">Calle</div><div id="vCalle">—</div>
        <div class="k">Entre calles</div><div id="vEntre">—</div>
      </div>
    </div>
    <div id="right-handle" class="handle">❮</div>
  </div>
</div>

<div id="toast" style="position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#0b1320;border:1px solid #20324a;border-radius:.6rem;padding:.55rem .8rem;display:none;z-index:2000"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// Utils
const $ = s => document.querySelector(s);
const toast = (m,t=2000)=>{const el=$("#toast"); el.textContent=m; el.style.display='block'; setTimeout(()=>el.style.display='none',t)};
const qs = new URLSearchParams(location.search);

// Fit map height to viewport (prevents blank map)
function fitMapHeight(){
  const headH = document.querySelector('header').offsetHeight || 60;
  const cont = $("#container");
  cont.style.height = `calc(100vh - ${headH}px)`;
  if(window._map) window._map.invalidateSize();
}
window.addEventListener('resize', fitMapHeight);

// Map
const map = L.map('map',{zoomControl:false, renderer:L.canvas(), minZoom:3, maxZoom:21});
window._map = map;
const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
  maxNativeZoom:19, maxZoom:22, attribution:'&copy; Esri'
}).addTo(map);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 20, attribution: '&copy; OpenStreetMap'
});
esri.on('tileerror',()=>{ if(!map.hasLayer(osm)){ osm.addTo(map); toast('Satélite no disponible; usando Calles.'); } });
map.setView([29.09,-110.96], 12);

// Clusters
const markers = L.markerClusterGroup({chunkedLoading:true, disableClusteringAtZoom:20, maxClusterRadius:40});
map.addLayer(markers);

// Red dot
const redIcon = L.divIcon({className:'', html:'<div class="red-dot"></div>', iconSize:[14,14], iconAnchor:[7,7]});

// Panel + list
let features=[], srcUrl='';
function renderList(arr){
  const list = $("#list"); list.innerHTML='';
  arr.forEach(f=>{
    const div=document.createElement('div'); div.className='item';
    div.innerHTML = `<div class="name">${f.props.name||'Bache'}</div><div class="sub">${(f.lat&&f.lon)?(f.lat.toFixed(6)+', '+f.lon.toFixed(6)):'—'} ${(f.props.Calle||'')}</div>`;
    div.onclick=()=>focusFeature(f,true);
    list.appendChild(div);
  });
  $("#countChip").textContent = \`Listo: \${arr.length}\`;
}
function proxied(u){ try{ const naked = u.replace(/^https?:\/\//,''); return 'https://images.weserv.nl/?url='+encodeURIComponent(naked); }catch{return u} }
function fillPanel(f){
  $("#btnMaps").href = (f.lat && f.lon) ? \`https://www.google.com/maps?q=\${f.lat},\${f.lon}\` : '#';
  const get = k => f.props[k] ?? f.props[k.toLowerCase()] ?? f.props[k.toUpperCase()] ?? '—';
  $("#vAncho").textContent = get('Ancho');
  $("#vLargo").textContent = get('Largo');
  $("#vTipo").textContent  = get('Tipo')==='—' ? (get('Tipo de trabajo')||'—') : get('Tipo');
  $("#vNum").textContent   = get('Numero de Bache')==='—'? (get('NumBache')||'—') : get('Numero de Bache');
  $("#vCad").textContent   = get('Cadenamiento');
  $("#vCol").textContent   = get('Colonia');
  $("#vCalle").textContent = get('Calle');
  $("#vEntre").textContent = get('EntreCalles')==='—'? (get('Entre calles')||'—') : get('EntreCalles');
  const imgs = (f.photos||[]).slice(0,3);
  [0,1,2].forEach(i=>{
    const a = $("#img"+i); a.innerHTML=''; a.removeAttribute('href');
    if(imgs[i]){ const im=new Image(); im.loading='lazy'; im.src=imgs[i]; im.onerror=()=>{im.src=proxied(imgs[i]);}; a.appendChild(im); a.href=imgs[i]; }
    else{ a.innerHTML = \`<span style="color:#64748b">\${i==0?'Antes':i==1?'Referencia':'Final'}</span>\`; }
  });
}
function focusFeature(f,fromList=false){
  if(f.lat && f.lon) map.setView([f.lat,f.lon], Math.max(18,map.getZoom()));
  if($("#autoHideList").checked && fromList) $("#left").classList.add('hidden');
  fillPanel(f);
}

// Parse KML
function parseKml(text){
  const xml = new DOMParser().parseFromString(text,'text/xml');
  const placemarks = Array.from(xml.getElementsByTagName('Placemark'));
  const out=[];
  placemarks.forEach(pm=>{
    const props={};
    const nm = pm.getElementsByTagName('name')[0]?.textContent?.trim(); if(nm) props.name=nm;
    pm.querySelectorAll('ExtendedData Data, ExtendedData SimpleData').forEach(n=>{
      const k=(n.getAttribute('name')||'').trim(); const v=(n.textContent||'').trim(); if(k) props[k]=v;
    });
    const desc = pm.getElementsByTagName('description')[0]?.textContent||'';
    if(desc){
      const tmp = new DOMParser().parseFromString(desc,'text/html');
      const tds = Array.from(tmp.querySelectorAll('td'));
      for(let i=0;i<tds.length-1;i+=2){
        const k = tds[i].textContent.trim().replace(/[:：]$/,''); const v = tds[i+1].textContent.trim(); if(k) props[k]=v;
      }
      tmp.querySelectorAll('img,a').forEach(el=>{
        const u = el.getAttribute('src')||el.getAttribute('href'); if(u) props['__img__'+Math.random()] = u;
      });
    }
    let lat=null, lon=null, coords=[];
    const pc = pm.getElementsByTagName('Point')[0]?.getElementsByTagName('coordinates')[0]?.textContent;
    if(pc){ const [lo,la]=pc.trim().split(',').map(Number); if(isFinite(la)&&isFinite(lo)){ lat=la; lon=lo; } }
    else{
      const seg = pm.getElementsByTagName('LineString')[0]?.getElementsByTagName('coordinates')[0]?.textContent
               || pm.getElementsByTagName('Polygon')[0]?.getElementsByTagName('coordinates')[0]?.textContent || '';
      seg.trim().split(/\s+/).forEach(s=>{ const [lo,la]=s.split(',').map(Number); if(isFinite(la)&&isFinite(lo)) coords.push([la,lo]); });
    }
    const urls = Object.values(props).filter(v=>typeof v==='string').flatMap(v=> v.match(/https?:\/\/[^\s"']+/gi)||[]).filter(u=>/\.(jpe?g|png|webp)(\?|$)/i.test(u) || /\/forms\/images\//.test(u)).filter((u,i,a)=>a.indexOf(u)===i);
    out.push({props, lat, lon, coords, photos: urls});
  });
  return out;
}

// Draw
function draw(arr){
  markers.clearLayers();
  const group = L.featureGroup();
  arr.forEach(f=>{
    if(f.lat && f.lon){
      const m = L.marker([f.lat,f.lon],{icon:redIcon}).on('click',()=>focusFeature(f,false));
      markers.addLayer(m); group.addLayer(m);
    }else if(f.coords?.length){
      const l = L.polyline(f.coords,{color:'#38bdf8'}).addTo(map); l.on('click',()=>focusFeature(f,false)); group.addLayer(l);
    }
  });
  if(group.getLayers().length){ try{ map.fitBounds(group.getBounds().pad(0.2)); }catch{} }
}

// Load URL
async function loadUrl(url){
  try{
    $("#srcChip").textContent = new URL(url, location.href).href;
  }catch{ $("#srcChip").textContent = url; }
  const u = url + (url.includes('?')?'&':'?') + 't=' + Date.now();
  const res = await fetch(u, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP '+res.status);
  const txt = await res.text();
  features = parseKml(txt);
  if(!features.length) throw new Error('Sin Placemarks');
  renderList(features); draw(features); fillPanel(features[0]);
  toast('Listo.');
}

// Load local
async function loadLocal(file){
  const text = await file.text();
  features = parseKml(text);
  renderList(features); draw(features); fillPanel(features[0]);
  $("#srcChip").textContent = 'archivo local';
  toast('Listo.');
}

// Events
$("#btnLoad").onclick = ()=> loadUrl( ($("#kmlUrl").value.trim()||'baches.kml') ).catch(e=>toast('Error: '+e.message));
$("#btnRefresh").onclick = ()=> loadUrl( ($("#kmlUrl").value.trim()||'baches.kml') + (location.search.includes('?')?'&':'?') + 't=' + Date.now() ).catch(e=>toast('Error: '+e.message));
$("#fileInput").addEventListener('change', e=>{ const f=e.target.files[0]; if(f) loadLocal(f).catch(err=>toast('Error: '+err.message)); e.target.value=''; });
$("#btnToggleLeft").onclick = ()=>{ $("#left").classList.toggle('hidden'); fitMapHeight(); };
$("#btnToggleRight").onclick = ()=>{ $("#right").classList.toggle('hidden'); fitMapHeight(); };
$("#left-handle").onclick = $("#btnToggleLeft").onclick;
$("#right-handle").onclick = $("#btnToggleRight").onclick;
$("#search").oninput = e=>{
  const q=e.target.value.toLowerCase();
  const sub = features.filter(f=> JSON.stringify(f).toLowerCase().includes(q));
  renderList(sub);
};

// Boot
(function boot(){
  fitMapHeight();
  const start = qs.get('data') || 'baches.kml';
  $("#kmlUrl").value = start;
  loadUrl(start).catch(e=>toast('Error: '+e.message));
})();
</script>
</body>
</html>
